<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—å‘½ç†é¤¨ - æ˜Ÿç©ºå åœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(to bottom, #0a0e27 0%, #1a1a3e 50%, #2d1b4e 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* æµæ˜Ÿæ•ˆæœ */
        .shooting-star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8);
            animation: shoot 3s linear infinite;
            opacity: 0;
        }

        @keyframes shoot {
            0% {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-300px) translateY(300px);
                opacity: 0;
            }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            position: relative;
            z-index: 2;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* é ­éƒ¨ */
        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3em;
            color: #fff;
            text-shadow: 0 0 20px rgba(138, 43, 226, 0.8),
                         0 0 40px rgba(138, 43, 226, 0.5);
            margin-bottom: 10px;
            letter-spacing: 5px;
        }

        .subtitle {
            color: #b8b8d4;
            font-size: 1.2em;
            letter-spacing: 3px;
        }

        /* å¡ç‰‡å®¹å™¨ */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeIn 1s ease-out 0.3s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 30px;
        }

        label {
            display: block;
            color: #e0e0ff;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        select option {
            background: #fff;
            color: #000;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8a2be2;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* æ™‚é–“é¸æ“‡å™¨ç¶²æ ¼ */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        /* æŒ‰éˆ• */
        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 2px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(-1px);
        }

        /* çµæœé¡¯ç¤ºå€åŸŸ */
        .result-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .bazi-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .pillar {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pillar-title {
            color: #ffd700;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .pillar-char {
            font-size: 2em;
            color: #fff;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .tengod {
            font-size: 0.9em;
            color: #ff69b4;
            margin-top: 5px;
            font-weight: bold;
        }
        .element {
            color: #b8b8d4;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .interpretation {
            color: #e0e0ff;
            line-height: 1.8;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .interpretation h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .interpretation p {
            margin-bottom: 15px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .card {
                padding: 25px;
            }

            .bazi-display {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* è¿”å›é¦–é æŒ‰éˆ• */
        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s ease;
            z-index: 1000;
            width: auto;
            margin: 0;
            display: inline-block;
            font-size: 1em;
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
            transform: translateY(-2px);
        }
    </style>
<link rel="stylesheet" href="../mobile-ui.css">
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars" id="stars"></div>
    
    <!-- è¿”å›é¦–é æŒ‰éˆ• -->
    <a href="../index.html" class="home-button">ğŸ  é¦–é </a>

    <div class="container">
        <header>
            <h1>âœ¨ å…«å­—å‘½ç†é¤¨ âœ¨</h1>
            <p class="subtitle">æ¢ç´¢å‘½é‹çš„å¥§ç§˜</p>
        </header>

        <div class="card">
            <form id="baziForm">
                <div class="form-group">
                    <label for="name">æ‚¨çš„å§“å</label>
                    <input type="text" id="name" name="name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
                </div>

                <div class="form-group">
                    <label for="gender">æ€§åˆ¥</label>
                    <select id="gender" name="gender" required>
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birthdate" name="birthdate" required>
                </div>

                <div class="form-group">
                    <label>å‡ºç”Ÿæ™‚é–“</label>
                    <div class="time-grid">
                        <select id="hour" name="hour" required>
                            <option value="">æ™‚</option>
                        </select>
                        <select id="minute" name="minute" required>
                            <option value="">åˆ†</option>
                        </select>
                        <select id="second" name="second">
                            <option value="0">ç§’</option>
                        </select>
                    </div>
                </div>

                <button type="submit">ğŸ”® é–‹å§‹ç®—å‘½</button>
            </form>

            <div class="result-section" id="resultSection">
                <h2 style="color: #ffd700; text-align: center; margin-bottom: 30px;">æ‚¨çš„å…«å­—å‘½ç›¤</h2>
                
                <div class="bazi-display" id="baziDisplay">
                    <!-- å…«å­—å››æŸ±å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div class="interpretation" id="interpretation">
                    <!-- è§£è®€å…§å®¹å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== äºŒåå››ç¯€æ°£è¨ˆç®—ï¼ˆç”¨æ–¼å…«å­—å¹´æŸ±åˆ¤æ–·ï¼‰=====
        const SOLAR_TERMS = [
            {'longitude':315, 'minutes':42467, 'cn': 'ç«‹æ˜¥', 'en':'Beginning of Spring'},
            {'longitude':330, 'minutes':63836, 'cn': 'é›¨æ°´', 'en':'Rain Water'},
            {'longitude':345, 'minutes':85337, 'cn': 'æƒŠè›°', 'en':'Awakening of Insects'},
            {'longitude':0, 'minutes':107014, 'cn': 'æ˜¥åˆ†', 'en':'Spring Equinox'},
            {'longitude':15, 'minutes':128867, 'cn': 'æ¸…æ˜', 'en':'Pure Brightness'},
            {'longitude':30, 'minutes':150921, 'cn': 'è°·é›¨', 'en':'Grain Rain'},
            {'longitude':45, 'minutes':173149, 'cn': 'ç«‹å¤', 'en':'Beginning of Summer'},
            {'longitude':60, 'minutes':195551, 'cn': 'å°æ»¡', 'en':'Grain Buds'},
            {'longitude':75, 'minutes':218072, 'cn': 'èŠ’ç§', 'en':'Grain in Ear'},
            {'longitude':90, 'minutes':240693, 'cn': 'å¤è‡³', 'en':'Summer Solstice'},
            {'longitude':105, 'minutes':263343, 'cn': 'å°æš‘', 'en':'Minor Heat'},
            {'longitude':120, 'minutes':285989, 'cn': 'å¤§æš‘', 'en':'Major heat'},
            {'longitude':135, 'minutes':308563, 'cn': 'ç«‹ç§‹', 'en':'Beginning of Autumn'},
            {'longitude':150, 'minutes':331033, 'cn': 'å¤„æš‘', 'en':'End of Heat'},
            {'longitude':165, 'minutes':353350, 'cn': 'ç™½éœ²', 'en':'White Dew'},
            {'longitude':180, 'minutes':375494, 'cn': 'ç§‹åˆ†', 'en':'Autumn Equinox'},
            {'longitude':195, 'minutes':397447, 'cn': 'å¯’éœ²', 'en':'Cold Dew'},
            {'longitude':210, 'minutes':419210, 'cn': 'éœœé™', 'en':'Frosts Descent'},
            {'longitude':225, 'minutes':440795, 'cn': 'ç«‹å†¬', 'en':'Beginning of Winter'},
            {'longitude':240, 'minutes':462224, 'cn': 'å°é›ª', 'en':'Minor Snow'},
            {'longitude':255, 'minutes':483532, 'cn': 'å¤§é›ª', 'en':'Major Snow'},
            {'longitude':270, 'minutes':504758, 'cn': 'å†¬è‡³', 'en':'Winter Solstice'},
            {'longitude':285, 'minutes':0, 'cn': 'å°å¯’', 'en':'Minor Cold'},
            {'longitude':300, 'minutes':21208, 'cn': 'å¤§å¯’', 'en':'Major Cold'}
        ];

        // è¨ˆç®—æŸå¹´çš„ç«‹æ˜¥æ—¥æœŸ
        function getLichunDate(year) {
            const baseTimeForYear = 31556925974.7 * (year - 1900) + Date.UTC(1900,0,6,2,5);
            const lichunMinutes = SOLAR_TERMS[0].minutes; // ç«‹æ˜¥æ˜¯ç¬¬ä¸€å€‹ç¯€æ°£
            return new Date(baseTimeForYear + lichunMinutes * 60000);
        }

        // ç²å–å…«å­—å¹´ä»½ï¼ˆè€ƒæ…®ç«‹æ˜¥ï¼‰
        function getBaziYear(date) {
            const year = date.getFullYear();
            const lichunThisYear = getLichunDate(year);
            // å¦‚æœåœ¨ç«‹æ˜¥ä¹‹å‰ï¼Œä½¿ç”¨å‰ä¸€å¹´
            if (date < lichunThisYear) {
                return year - 1;
            }
            return year;
        }

        // æ ¹æ“šç¯€æ°£ç²å–æœˆæ”¯ç´¢å¼•
        function getMonthBranchByDate(date) {
            const year = date.getFullYear();
            const baseTimeForYear = 31556925974.7 * (year - 1900) + Date.UTC(1900,0,6,2,5);
            
            // è¨ˆç®—ç•¶å¹´æ‰€æœ‰ç¯€æ°£
            let solarTerms = [];
            for(let i = 0; i < 24; i++) {
                solarTerms.push(new Date(baseTimeForYear + SOLAR_TERMS[i].minutes * 60000));
            }
            
            // æœˆæ”¯å¾å¯…æœˆï¼ˆç«‹æ˜¥ï¼‰é–‹å§‹ï¼šå¯…(2)ã€å¯(3)ã€è¾°(4)...ä¸‘(1)
            // ç¯€æ°£ç´¢å¼•ï¼šç«‹æ˜¥(0)ã€é©šèŸ„(2)ã€æ¸…æ˜(4)ã€ç«‹å¤(6)ã€èŠ’ç¨®(8)ã€å°æš‘(10)ã€ç«‹ç§‹(12)ã€ç™½éœ²(14)ã€å¯’éœ²(16)ã€ç«‹å†¬(18)ã€å¤§é›ª(20)ã€å°å¯’(22)
            const monthStarts = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22]; // 12å€‹æœˆçš„èµ·å§‹ç¯€æ°£
            
            for(let i = 0; i < 12; i++) {
                const startTerm = solarTerms[monthStarts[i]];
                const endTerm = i < 11 ? solarTerms[monthStarts[i + 1]] : solarTerms[0]; // æœ€å¾Œä¸€å€‹æœˆåˆ°ä¸‹ä¸€å¹´ç«‹æ˜¥
                
                if (date >= startTerm && (i < 11 ? date < endTerm : true)) {
                    return (2 + i) % 12; // å¯…æœˆé–‹å§‹ï¼Œç´¢å¼•ç‚º2
                }
            }
            
            // å¦‚æœåœ¨å°å¯’ä¹‹å¾Œã€ç«‹æ˜¥ä¹‹å‰ï¼Œå±¬æ–¼ä¸‘æœˆ
            if (date < solarTerms[0]) {
                return 1; // ä¸‘
            }
            
            return 2; // é»˜èªå¯…æœˆ
        }


        // ç”Ÿæˆæ˜Ÿç©º
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const numberOfStars = 200;

            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }

            // å‰µå»ºæµæ˜Ÿ
            for (let i = 0; i < 3; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = Math.random() * 100 + '%';
                shootingStar.style.top = Math.random() * 50 + '%';
                shootingStar.style.animationDelay = Math.random() * 5 + 's';
                starsContainer.appendChild(shootingStar);
            }
        }

        // åˆå§‹åŒ–æ™‚é–“é¸æ“‡å™¨
        function initTimeSelectors() {
            const hourSelect = document.getElementById('hour');
            const minuteSelect = document.getElementById('minute');
            const secondSelect = document.getElementById('second');

            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                hourSelect.appendChild(option);
            }

            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                minuteSelect.appendChild(option);
            }

            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                secondSelect.appendChild(option);
            }
        }

        // å¤©å¹²åœ°æ”¯
        const heavenlyStems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
        const earthlyBranches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const elements = ['æœ¨', 'æœ¨', 'ç«', 'ç«', 'åœŸ', 'åœŸ', 'é‡‘', 'é‡‘', 'æ°´', 'æ°´'];
        const branchElements = ['æ°´', 'åœŸ', 'æœ¨', 'æœ¨', 'åœŸ', 'ç«', 'ç«', 'åœŸ', 'é‡‘', 'é‡‘', 'åœŸ', 'æ°´'];
        
        // æ™‚è¾°å°æ‡‰è¡¨ï¼ˆ23-1é»ç‚ºå­æ™‚ï¼‰
        const hourBranches = ['å­', 'ä¸‘', 'ä¸‘', 'å¯…', 'å¯…', 'å¯', 'å¯', 'è¾°', 'è¾°', 'å·³', 'å·³', 'åˆ', 
                             'åˆ', 'æœª', 'æœª', 'ç”³', 'ç”³', 'é…‰', 'é…‰', 'æˆŒ', 'æˆŒ', 'äº¥', 'äº¥', 'å­'];

        // è¨ˆç®—å¾åŸºæº–æ—¥æœŸåˆ°ç›®æ¨™æ—¥æœŸçš„å¤©æ•¸
        function getDaysSinceEpoch(date) {
            const baseDate = new Date(1900, 0, 31); // 1900å¹´1æœˆ31æ—¥ç‚ºåºšå­æ—¥
            const diff = date - baseDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // è¨ˆç®—å…«å­—ï¼ˆå·²å„ªåŒ–ï¼šä½¿ç”¨ç«‹æ˜¥åˆ¤æ–·å¹´æŸ±ã€ä½¿ç”¨ç¯€æ°£åˆ¤æ–·æœˆæŸ±ï¼‰
        function calculateBazi(birthDate) {
            const year = birthDate.getFullYear();
            const month = birthDate.getMonth() + 1;
            const day = birthDate.getDate();
            const hour = birthDate.getHours();

            // å¹´æŸ±è¨ˆç®—ï¼ˆä»¥ç«‹æ˜¥ç‚ºç•Œï¼‰- å·²å„ªåŒ–
            const baziYear = getBaziYear(birthDate);
            let yearOffset = baziYear - 4; // ç”²å­å¹´é–‹å§‹æ–¼å…¬å…ƒ4å¹´
            const yearStemIndex = ((yearOffset % 10) + 10) % 10;
            const yearBranchIndex = ((yearOffset % 12) + 12) % 12;
            const yearStem = heavenlyStems[yearStemIndex];
            const yearBranch = earthlyBranches[yearBranchIndex];
            
            // æœˆæŸ±è¨ˆç®—ï¼ˆæ ¹æ“šç¯€æ°£åˆ¤æ–·æœˆæ”¯ï¼‰- å·²å„ªåŒ–
            const monthBranchIndex = getMonthBranchByDate(birthDate);
            
            // æœˆå¹²æ ¹æ“šå¹´å¹²æ¨ç®—ï¼ˆäº”è™éæœˆå£è¨£ï¼‰
            // ç”²å·±ä¹‹å¹´ä¸™ä½œé¦–ï¼Œä¹™åºšä¹‹å¹´æˆŠç‚ºé ­
            // ä¸™è¾›å¿…å®šå°‹åºšèµ·ï¼Œä¸å£¬å£¬ä½é †è¡Œæµ
            // è‹¥å•æˆŠç™¸ä½•æ–¹ç™¼ï¼Œç”²å¯…ä¹‹ä¸Šå¥½è¿½æ±‚
            const monthStemStart = [2, 4, 6, 8, 0]; // ä¸™ã€æˆŠã€åºšã€å£¬ã€ç”²
            const yearStemMod = yearStemIndex % 5;
            // æœˆæ”¯å¾å¯…æœˆé–‹å§‹è¨ˆç®—ï¼Œå¯…=0, å¯=1, ..., ä¸‘=11
            const monthOffset = (monthBranchIndex - 2 + 12) % 12;
            const monthStemIndex = (monthStemStart[yearStemMod] + monthOffset) % 10;
            
            const monthStem = heavenlyStems[monthStemIndex];
            const monthBranch = earthlyBranches[monthBranchIndex];
            
            // æ—¥æŸ±è¨ˆç®—ï¼ˆä½¿ç”¨è¬å¹´æ›†æ¨ç®—ï¼‰
            const daysSinceEpoch = getDaysSinceEpoch(birthDate);
            const dayStemIndex = (daysSinceEpoch + 6) % 10; // åŸºæº–æ—¥1900/1/31æ˜¯åºš(6)å­æ—¥
            const dayBranchIndex = (daysSinceEpoch + 0) % 12; // åŸºæº–æ—¥æ˜¯å­(0)
            const dayStem = heavenlyStems[dayStemIndex];
            const dayBranch = earthlyBranches[dayBranchIndex];
            
            // æ™‚æŸ±è¨ˆç®—
            const hourBranchIndex = Math.floor((hour + 1) % 24 / 2); // 23-1é»ç‚ºå­æ™‚(0)
            const hourBranch = earthlyBranches[hourBranchIndex];
            
            // æ™‚å¹²æ ¹æ“šæ—¥å¹²æ¨ç®—ï¼ˆäº”é¼ éæ™‚å£è¨£ï¼‰
            // ç”²å·±é‚„åŠ ç”²ï¼Œä¹™åºšä¸™ä½œåˆ
            // ä¸™è¾›å¾æˆŠèµ·ï¼Œä¸å£¬åºšå­å±…
            // æˆŠç™¸ä½•æ–¹ç™¼ï¼Œå£¬å­æ˜¯çœŸé€”
            const hourStemStart = [0, 2, 4, 6, 8]; // ç”²ã€ä¸™ã€æˆŠã€åºšã€å£¬
            const dayStemMod = dayStemIndex % 5;
            const hourStemIndex = (hourStemStart[dayStemMod] + hourBranchIndex) % 10;
            const hourStem = heavenlyStems[hourStemIndex];

            return {
                year: { stem: yearStem, branch: yearBranch },
                month: { stem: monthStem, branch: monthBranch },
                day: { stem: dayStem, branch: dayBranch },
                hour: { stem: hourStem, branch: hourBranch }
            };
        }


        // ===== åç¥è¨ˆç®—æ¨¡çµ„ =====
        // åç¥è¨ˆç®—æ¨¡çµ„
// ç”¨æ–¼å…«å­—å‘½ç†ä¸­çš„åç¥åˆ†æ

/**
 * åç¥é—œä¿‚è¡¨
 * æ ¹æ“šæ—¥ä¸»èˆ‡å…¶ä»–å¤©å¹²çš„äº”è¡Œé—œä¿‚å’Œé™°é™½å±¬æ€§ä¾†åˆ¤æ–·åç¥
 */

// å¤©å¹²äº”è¡Œå±¬æ€§
const STEM_ELEMENTS = {
    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
    'ä¸™': 'ç«', 'ä¸': 'ç«',
    'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
    'åºš': 'é‡‘', 'è¾›': 'é‡‘',
    'å£¬': 'æ°´', 'ç™¸': 'æ°´'
};

// å¤©å¹²é™°é™½å±¬æ€§ï¼ˆé™½å¹²ï¼šç”²ä¸™æˆŠåºšå£¬ï¼Œé™°å¹²ï¼šä¹™ä¸å·±è¾›ç™¸ï¼‰
const STEM_YINYANG = {
    'ç”²': 'é™½', 'ä¹™': 'é™°',
    'ä¸™': 'é™½', 'ä¸': 'é™°',
    'æˆŠ': 'é™½', 'å·±': 'é™°',
    'åºš': 'é™½', 'è¾›': 'é™°',
    'å£¬': 'é™½', 'ç™¸': 'é™°'
};

// äº”è¡Œç”Ÿå…‹é—œä¿‚
const ELEMENT_RELATIONS = {
    'æœ¨': { generates: 'ç«', controls: 'åœŸ', controlledBy: 'é‡‘', generatedBy: 'æ°´' },
    'ç«': { generates: 'åœŸ', controls: 'é‡‘', controlledBy: 'æ°´', generatedBy: 'æœ¨' },
    'åœŸ': { generates: 'é‡‘', controls: 'æ°´', controlledBy: 'æœ¨', generatedBy: 'ç«' },
    'é‡‘': { generates: 'æ°´', controls: 'æœ¨', controlledBy: 'ç«', generatedBy: 'åœŸ' },
    'æ°´': { generates: 'æœ¨', controls: 'ç«', controlledBy: 'åœŸ', generatedBy: 'é‡‘' }
};

/**
 * è¨ˆç®—å…©å€‹å¤©å¹²ä¹‹é–“çš„åç¥é—œä¿‚
 * @param {string} dayStem - æ—¥ä¸»å¤©å¹²
 * @param {string} otherStem - å…¶ä»–å¤©å¹²
 * @returns {string} - åç¥åç¨±
 */
function calculateTenGod(dayStem, otherStem) {
    // å¦‚æœæ˜¯åŒä¸€å€‹å¤©å¹²ï¼Œè¿”å›æ¯”è‚©
    if (dayStem === otherStem) {
        return 'æ¯”è‚©';
    }
    
    const dayElement = STEM_ELEMENTS[dayStem];
    const otherElement = STEM_ELEMENTS[otherStem];
    const dayYinYang = STEM_YINYANG[dayStem];
    const otherYinYang = STEM_YINYANG[otherStem];
    
    // åˆ¤æ–·é™°é™½æ˜¯å¦ç›¸åŒ
    const sameYinYang = dayYinYang === otherYinYang;
    
    // åˆ¤æ–·äº”è¡Œé—œä¿‚
    const relation = ELEMENT_RELATIONS[dayElement];
    
    // 1. åŒäº”è¡Œï¼šæ¯”è‚©ã€åŠ«è²¡
    if (dayElement === otherElement) {
        return sameYinYang ? 'æ¯”è‚©' : 'åŠ«è²¡';
    }
    
    // 2. æˆ‘ç”Ÿè€…ï¼šé£Ÿç¥ã€å‚·å®˜
    if (relation.generates === otherElement) {
        return sameYinYang ? 'é£Ÿç¥' : 'å‚·å®˜';
    }
    
    // 3. æˆ‘å…‹è€…ï¼šæ­£è²¡ã€åè²¡
    if (relation.controls === otherElement) {
        return sameYinYang ? 'åè²¡' : 'æ­£è²¡';
    }
    
    // 4. å…‹æˆ‘è€…ï¼šæ­£å®˜ã€ä¸ƒæ®ºï¼ˆåå®˜ï¼‰
    if (relation.controlledBy === otherElement) {
        return sameYinYang ? 'ä¸ƒæ®º' : 'æ­£å®˜';
    }
    
    // 5. ç”Ÿæˆ‘è€…ï¼šæ­£å°ã€åå°ï¼ˆæ¢Ÿç¥ï¼‰
    if (relation.generatedBy === otherElement) {
        return sameYinYang ? 'åå°' : 'æ­£å°';
    }
    
    return 'æœªçŸ¥';
}

/**
 * è¨ˆç®—å…«å­—å››æŸ±çš„åç¥
 * @param {object} bazi - å…«å­—å°è±¡ { year: {stem, branch}, month: {stem, branch}, day: {stem, branch}, hour: {stem, branch} }
 * @returns {object} - åç¥åˆ†æçµæœ
 */
function analyzeTenGods(bazi) {
    const dayStem = bazi.day.stem;
    
    const tenGods = {
        year: {
            stem: calculateTenGod(dayStem, bazi.year.stem),
            branch: null // åœ°æ”¯è—å¹²éœ€è¦å¦å¤–è¨ˆç®—
        },
        month: {
            stem: calculateTenGod(dayStem, bazi.month.stem),
            branch: null
        },
        day: {
            stem: 'æ—¥ä¸»', // æ—¥ä¸»æœ¬èº«
            branch: null
        },
        hour: {
            stem: calculateTenGod(dayStem, bazi.hour.stem),
            branch: null
        }
    };
    
    return tenGods;
}

/**
 * ç²å–åç¥çš„è©³ç´°èªªæ˜
 * @param {string} tenGod - åç¥åç¨±
 * @returns {object} - åç¥è©³ç´°è³‡è¨Š
 */
function getTenGodDescription(tenGod) {
    const descriptions = {
        'æ¯”è‚©': {
            name: 'æ¯”è‚©',
            category: 'å¹³ç¥',
            meaning: 'ä»£è¡¨å…„å¼Ÿå§å¦¹ã€åŒè¼©ã€ç«¶çˆ­è€…',
            personality: 'ç¨ç«‹è‡ªä¸»ã€è‡ªå°Šå¿ƒå¼·ã€é‡è¦–æœ‹å‹',
            positive: 'å …å¼·ã€ç¨ç«‹ã€æœ‰ä¸»è¦‹ã€é‡ç¾©æ°£',
            negative: 'å›ºåŸ·ã€å­¤åƒ»ã€ä¸å–„å¦¥å”'
        },
        'åŠ«è²¡': {
            name: 'åŠ«è²¡',
            category: 'å‡¶ç¥',
            meaning: 'ä»£è¡¨ç«¶çˆ­ã€å¥ªå–ã€ç ´è²¡',
            personality: 'ç©æ¥µé€²å–ã€æ•¢æ–¼ç«¶çˆ­ã€é‡è¦–åˆ©ç›Š',
            positive: 'å‹‡æ–¼é–‹æ‹“ã€è¡Œå‹•åŠ›å¼·ã€å–„æ–¼ç«¶çˆ­',
            negative: 'å¥½å‹ã€è¡å‹•ã€æ˜“ç ´è²¡ã€äººéš›é—œä¿‚ç·Šå¼µ'
        },
        'é£Ÿç¥': {
            name: 'é£Ÿç¥',
            category: 'å‰ç¥',
            meaning: 'ä»£è¡¨æ‰è¯ã€è¡¨é”ã€äº«å—',
            personality: 'æ¨‚è§€é–‹æœ—ã€å–„æ–¼è¡¨é”ã€é‡è¦–äº«å—',
            positive: 'æ‰è¯æ©«æº¢ã€å£æ‰å¥½ã€ç¦ç¥¿é›™å…¨',
            negative: 'å¥½é€¸æƒ¡å‹ã€ç¼ºä¹é€²å–å¿ƒ'
        },
        'å‚·å®˜': {
            name: 'å‚·å®˜',
            category: 'å‡¶ç¥',
            meaning: 'ä»£è¡¨æ‰è¯ã€å›é€†ã€å‚·å®³',
            personality: 'è°æ˜ä¼¶ä¿ã€æ‰è¯å‡ºçœ¾ã€ä¸å®ˆè¦çŸ©',
            positive: 'è°æ˜ã€å¤šæ‰å¤šè—ã€å‰µæ„è±å¯Œ',
            negative: 'å‚²æ…¢ã€å›é€†ã€æ˜“å¾—ç½ªäººã€ä¸åˆ©å®˜é‹'
        },
        'æ­£è²¡': {
            name: 'æ­£è²¡',
            category: 'å‰ç¥',
            meaning: 'ä»£è¡¨ç©©å®šæ”¶å…¥ã€å¦»å­ã€è²¡å¯Œ',
            personality: 'å‹™å¯¦ç©©é‡ã€é‡è¦–è²¡å¯Œã€å‹¤å‹ç¯€å„‰',
            positive: 'è²¡é‹ç©©å®šã€å–„æ–¼ç†è²¡ã€å‹¤å‹è¸å¯¦',
            negative: 'éæ–¼ä¿å®ˆã€åå—‡ã€ç¼ºä¹å†’éšªç²¾ç¥'
        },
        'åè²¡': {
            name: 'åè²¡',
            category: 'å¹³ç¥',
            meaning: 'ä»£è¡¨æ„å¤–ä¹‹è²¡ã€çˆ¶è¦ªã€æŠ•è³‡',
            personality: 'æ…·æ…¨å¤§æ–¹ã€å–„æ–¼äº¤éš›ã€é‡è¦–æ©Ÿæœƒ',
            positive: 'è²¡é‹äº¨é€šã€å–„æ–¼æŠ•è³‡ã€äººç·£å¥½',
            negative: 'æ®éœã€æŠ•æ©Ÿã€æ„Ÿæƒ…ä¸å°ˆä¸€'
        },
        'æ­£å®˜': {
            name: 'æ­£å®˜',
            category: 'å‰ç¥',
            meaning: 'ä»£è¡¨æ¬ŠåŠ›ã€åœ°ä½ã€ä¸ˆå¤«',
            personality: 'æ­£ç›´å®ˆæ³•ã€é‡è¦–åè­½ã€æœ‰è²¬ä»»æ„Ÿ',
            positive: 'äº‹æ¥­æœ‰æˆã€åè²å¥½ã€æœ‰é ˜å°æ‰èƒ½',
            negative: 'éæ–¼ä¿å®ˆã€å£“åŠ›å¤§ã€ç¼ºä¹å‰µæ–°'
        },
        'ä¸ƒæ®º': {
            name: 'ä¸ƒæ®º',
            category: 'å‡¶ç¥',
            meaning: 'ä»£è¡¨æ¬ŠåŠ›ã€å£“åŠ›ã€å°äºº',
            personality: 'æœæ–·å‰›æ¯…ã€æ•¢ä½œæ•¢ç•¶ã€é‡è¦–æ¬ŠåŠ›',
            positive: 'æ±ºæ–·åŠ›å¼·ã€æœ‰é­„åŠ›ã€èƒ½æˆå¤§äº‹',
            negative: 'æš´èºã€å°ˆåˆ¶ã€æ˜“æ¨¹æ•µã€å£“åŠ›å¤§'
        },
        'æ­£å°': {
            name: 'æ­£å°',
            category: 'å‰ç¥',
            meaning: 'ä»£è¡¨å­¸å•ã€æ¯è¦ªã€è²´äºº',
            personality: 'ä»æ…ˆå–„è‰¯ã€é‡è¦–å­¸ç¿’ã€æœ‰æ¶µé¤Š',
            positive: 'å­¸æ¥­æœ‰æˆã€æœ‰è²´äººç›¸åŠ©ã€å“å¾·é«˜å°š',
            negative: 'ä¾è³´æ€§å¼·ã€ç¼ºä¹ä¸»è¦‹ã€è¡Œå‹•åŠ›ä¸è¶³'
        },
        'åå°': {
            name: 'åå°',
            category: 'å‡¶ç¥',
            meaning: 'ä»£è¡¨åé–€å­¸å•ã€ç¹¼æ¯ã€å­¤ç¨',
            personality: 'è°æ˜æ©Ÿæ™ºã€å–„æ–¼é‘½ç ”ã€å–œæ­¡ç¨è™•',
            positive: 'æ‚Ÿæ€§é«˜ã€æœ‰ç‰¹æ®Šæ‰èƒ½ã€å–„æ–¼ç ”ç©¶',
            negative: 'å­¤åƒ»ã€å¤šç–‘ã€äººéš›é—œä¿‚å·®ã€æ˜“é­å°äºº'
        },
        'æ—¥ä¸»': {
            name: 'æ—¥ä¸»',
            category: 'æœ¬å‘½',
            meaning: 'ä»£è¡¨è‡ªå·±ã€æœ¬å‘½ã€å…ƒç¥',
            personality: 'å‘½ä¸»æœ¬èº«',
            positive: 'è‡ªæˆ‘',
            negative: 'è‡ªæˆ‘'
        }
    };
    
    return descriptions[tenGod] || {
        name: tenGod,
        category: 'æœªçŸ¥',
        meaning: 'æœªçŸ¥',
        personality: 'æœªçŸ¥',
        positive: 'æœªçŸ¥',
        negative: 'æœªçŸ¥'
    };
}

/**
 * çµ±è¨ˆåç¥åˆ†å¸ƒ
 * @param {object} tenGods - åç¥åˆ†æçµæœ
 * @returns {object} - åç¥çµ±è¨ˆ
 */
function countTenGods(tenGods) {
    const count = {};
    
    // çµ±è¨ˆå¤©å¹²åç¥
    ['year', 'month', 'day', 'hour'].forEach(pillar => {
        const stemGod = tenGods[pillar].stem;
        if (stemGod && stemGod !== 'æ—¥ä¸»') {
            count[stemGod] = (count[stemGod] || 0) + 1;
        }
    });
    
    return count;
}

/**
 * åˆ†æåç¥æ ¼å±€
 * @param {object} tenGodsCount - åç¥çµ±è¨ˆ
 * @param {object} bazi - å…«å­—å°è±¡
 * @returns {object} - æ ¼å±€åˆ†æ
 */
function analyzePattern(tenGodsCount, bazi) {
    const patterns = [];
    
    // åˆ¤æ–·æ˜¯å¦ç‚ºå¾æ ¼
    const dayStem = bazi.day.stem;
    const dayElement = STEM_ELEMENTS[dayStem];
    
    // åˆ¤æ–·ä¸»è¦åç¥
    let mainGod = null;
    let maxCount = 0;
    for (const god in tenGodsCount) {
        if (tenGodsCount[god] > maxCount) {
            maxCount = tenGodsCount[god];
            mainGod = god;
        }
    }
    
    // åŸºæœ¬æ ¼å±€åˆ¤æ–·
    if (mainGod) {
        if (mainGod === 'æ­£å®˜' || mainGod === 'ä¸ƒæ®º') {
            patterns.push('å®˜æ®ºæ ¼');
        } else if (mainGod === 'æ­£è²¡' || mainGod === 'åè²¡') {
            patterns.push('è²¡æ ¼');
        } else if (mainGod === 'æ­£å°' || mainGod === 'åå°') {
            patterns.push('å°æ ¼');
        } else if (mainGod === 'é£Ÿç¥' || mainGod === 'å‚·å®˜') {
            patterns.push('é£Ÿå‚·æ ¼');
        } else if (mainGod === 'æ¯”è‚©' || mainGod === 'åŠ«è²¡') {
            patterns.push('æ¯”åŠ«æ ¼');
        }
    }
    
    return {
        mainGod: mainGod,
        patterns: patterns,
        description: patterns.length > 0 ? `æ­¤å‘½ä»¥${mainGod}ç‚ºä¸»ï¼Œå±¬æ–¼${patterns[0]}` : 'æ ¼å±€å¾…å®š'
    };
}

// å°å‡ºå‡½æ•¸
// if (typeof module !== 'undefined' && // module.exports) {
    // module.exports = {
        calculateTenGod,
        analyzeTenGods,
        getTenGodDescription,
        countTenGods,
        analyzePattern
    };
}



        // ===== å¤§é‹æ¨ç®—æ¨¡çµ„ =====
        // å¤§é‹æ¨ç®—æ¨¡çµ„
// ç”¨æ–¼å…«å­—å‘½ç†ä¸­çš„å¤§é‹ï¼ˆåå¹´é‹ï¼‰è¨ˆç®—

/**
 * å¤§é‹æ¨ç®—è¦å‰‡ï¼š
 * 1. é™½ç”·é™°å¥³ï¼šé †æ¨ï¼ˆæœˆæŸ±é †æ•¸ï¼‰
 * 2. é™°ç”·é™½å¥³ï¼šé€†æ¨ï¼ˆæœˆæŸ±é€†æ•¸ï¼‰
 * 3. èµ·é‹æ­²æ•¸ï¼šå¾å‡ºç”Ÿæ—¥åˆ°ä¸‹ä¸€å€‹/ä¸Šä¸€å€‹ç¯€æ°£çš„å¤©æ•¸ Ã· 3
 */

// å¤©å¹²åœ°æ”¯
const HEAVENLY_STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
const EARTHLY_BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];

// å¤©å¹²é™°é™½å±¬æ€§
const STEM_YINYANG_MAP = {
    'ç”²': 'é™½', 'ä¹™': 'é™°',
    'ä¸™': 'é™½', 'ä¸': 'é™°',
    'æˆŠ': 'é™½', 'å·±': 'é™°',
    'åºš': 'é™½', 'è¾›': 'é™°',
    'å£¬': 'é™½', 'ç™¸': 'é™°'
};

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºé™½å¹´ï¼ˆå¹´å¹²ç‚ºé™½ï¼‰
 * @param {string} yearStem - å¹´æŸ±å¤©å¹²
 * @returns {boolean}
 */
function isYangYear(yearStem) {
    return STEM_YINYANG_MAP[yearStem] === 'é™½';
}

/**
 * ç²å–ä¸‹ä¸€å€‹å¹²æ”¯çµ„åˆ
 * @param {string} stem - ç•¶å‰å¤©å¹²
 * @param {string} branch - ç•¶å‰åœ°æ”¯
 * @param {boolean} forward - æ˜¯å¦é †æ¨ï¼ˆtrue=é †æ¨ï¼Œfalse=é€†æ¨ï¼‰
 * @returns {object} - {stem, branch}
 */
function getNextGanZhi(stem, branch, forward) {
    const stemIndex = HEAVENLY_STEMS.indexOf(stem);
    const branchIndex = EARTHLY_BRANCHES.indexOf(branch);
    
    let newStemIndex, newBranchIndex;
    
    if (forward) {
        // é †æ¨
        newStemIndex = (stemIndex + 1) % 10;
        newBranchIndex = (branchIndex + 1) % 12;
    } else {
        // é€†æ¨
        newStemIndex = (stemIndex - 1 + 10) % 10;
        newBranchIndex = (branchIndex - 1 + 12) % 12;
    }
    
    return {
        stem: HEAVENLY_STEMS[newStemIndex],
        branch: EARTHLY_BRANCHES[newBranchIndex]
    };
}

/**
 * è¨ˆç®—èµ·é‹æ­²æ•¸
 * @param {Date} birthDate - å‡ºç”Ÿæ—¥æœŸ
 * @param {string} yearStem - å¹´æŸ±å¤©å¹²
 * @param {string} gender - æ€§åˆ¥ï¼ˆ'male' æˆ– 'female'ï¼‰
 * @param {function} getSolarTermsForYear - ç²å–æŸå¹´ç¯€æ°£çš„å‡½æ•¸
 * @returns {number} - èµ·é‹æ­²æ•¸
 */
function calculateStartAge(birthDate, yearStem, gender, getSolarTermsForYear) {
    const isYang = isYangYear(yearStem);
    const isMale = gender === 'male';
    
    // åˆ¤æ–·æ˜¯é †æ¨é‚„æ˜¯é€†æ¨
    // é™½ç”·é™°å¥³é †æ¨ï¼Œé™°ç”·é™½å¥³é€†æ¨
    const forward = (isYang && isMale) || (!isYang && !isMale);
    
    // ç²å–ç•¶å¹´çš„æ‰€æœ‰ç¯€æ°£
    const year = birthDate.getFullYear();
    const solarTerms = getSolarTermsForYear(year);
    
    // æ‰¾åˆ°å‡ºç”Ÿæ—¥æœŸæ‰€åœ¨çš„ç¯€æ°£å€é–“
    let targetTerm = null;
    
    if (forward) {
        // é †æ¨ï¼šæ‰¾ä¸‹ä¸€å€‹ç¯€æ°£
        for (let i = 0; i < solarTerms.length; i++) {
            if (birthDate < solarTerms[i].date) {
                targetTerm = solarTerms[i];
                break;
            }
        }
        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½¿ç”¨ä¸‹ä¸€å¹´çš„ç«‹æ˜¥
        if (!targetTerm) {
            const nextYearTerms = getSolarTermsForYear(year + 1);
            targetTerm = nextYearTerms[0]; // ç«‹æ˜¥
        }
    } else {
        // é€†æ¨ï¼šæ‰¾ä¸Šä¸€å€‹ç¯€æ°£
        for (let i = solarTerms.length - 1; i >= 0; i--) {
            if (birthDate > solarTerms[i].date) {
                targetTerm = solarTerms[i];
                break;
            }
        }
        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½¿ç”¨ä¸Šä¸€å¹´çš„æœ€å¾Œä¸€å€‹ç¯€æ°£
        if (!targetTerm) {
            const prevYearTerms = getSolarTermsForYear(year - 1);
            targetTerm = prevYearTerms[prevYearTerms.length - 1];
        }
    }
    
    // è¨ˆç®—å¤©æ•¸å·®
    const daysDiff = Math.abs(Math.floor((targetTerm.date - birthDate) / (1000 * 60 * 60 * 24)));
    
    // ä¸‰å¤©ç‚ºä¸€æ­²
    const startAge = Math.floor(daysDiff / 3);
    
    return startAge;
}

/**
 * æ¨ç®—å¤§é‹
 * @param {object} bazi - å…«å­—å°è±¡
 * @param {string} gender - æ€§åˆ¥ï¼ˆ'male' æˆ– 'female'ï¼‰
 * @param {Date} birthDate - å‡ºç”Ÿæ—¥æœŸ
 * @param {function} getSolarTermsForYear - ç²å–æŸå¹´ç¯€æ°£çš„å‡½æ•¸
 * @param {number} count - æ¨ç®—å¤§é‹çš„æ•¸é‡ï¼ˆé»˜èª 8 å€‹ï¼Œä»£è¡¨ 80 å¹´ï¼‰
 * @returns {object} - å¤§é‹è³‡è¨Š
 */
function calculateDayun(bazi, gender, birthDate, getSolarTermsForYear, count = 8) {
    const yearStem = bazi.year.stem;
    const isYang = isYangYear(yearStem);
    const isMale = gender === 'male';
    
    // åˆ¤æ–·æ˜¯é †æ¨é‚„æ˜¯é€†æ¨
    const forward = (isYang && isMale) || (!isYang && !isMale);
    
    // è¨ˆç®—èµ·é‹æ­²æ•¸
    const startAge = calculateStartAge(birthDate, yearStem, gender, getSolarTermsForYear);
    
    // å¾æœˆæŸ±é–‹å§‹æ¨ç®—å¤§é‹
    let currentStem = bazi.month.stem;
    let currentBranch = bazi.month.branch;
    
    const dayunList = [];
    
    for (let i = 0; i < count; i++) {
        // ç²å–ä¸‹ä¸€å€‹å¹²æ”¯
        const nextGanZhi = getNextGanZhi(currentStem, currentBranch, forward);
        
        // è¨ˆç®—é€™å€‹å¤§é‹çš„èµ·å§‹å¹´é½¡
        const ageStart = startAge + i * 10;
        const ageEnd = ageStart + 9;
        
        dayunList.push({
            index: i + 1,
            stem: nextGanZhi.stem,
            branch: nextGanZhi.branch,
            ganZhi: nextGanZhi.stem + nextGanZhi.branch,
            ageStart: ageStart,
            ageEnd: ageEnd,
            yearStart: birthDate.getFullYear() + ageStart,
            yearEnd: birthDate.getFullYear() + ageEnd
        });
        
        currentStem = nextGanZhi.stem;
        currentBranch = nextGanZhi.branch;
    }
    
    return {
        startAge: startAge,
        forward: forward,
        direction: forward ? 'é †æ¨' : 'é€†æ¨',
        dayunList: dayunList
    };
}

/**
 * ç²å–ç•¶å‰æ‰€åœ¨çš„å¤§é‹
 * @param {object} dayunInfo - å¤§é‹è³‡è¨Š
 * @param {number} currentAge - ç•¶å‰å¹´é½¡
 * @returns {object} - ç•¶å‰å¤§é‹
 */
function getCurrentDayun(dayunInfo, currentAge) {
    for (const dayun of dayunInfo.dayunList) {
        if (currentAge >= dayun.ageStart && currentAge <= dayun.ageEnd) {
            return dayun;
        }
    }
    return null;
}

/**
 * åˆ†æå¤§é‹å‰å‡¶
 * @param {object} dayun - å¤§é‹å°è±¡
 * @param {object} bazi - å…«å­—å°è±¡
 * @returns {object} - å¤§é‹åˆ†æ
 */
function analyzeDayunLuck(dayun, bazi) {
    // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„å¤§é‹å‰å‡¶åˆ†æ
    // ç°¡åŒ–ç‰ˆæœ¬ï¼šæ ¹æ“šåç¥é—œä¿‚åˆ¤æ–·
    const dayStem = bazi.day.stem;
    
    // ä½¿ç”¨åç¥è¨ˆç®—ï¼ˆéœ€è¦å¼•å…¥ ten-gods-calculator.jsï¼‰
    let stemGod = 'æœªçŸ¥';
    if (typeof calculateTenGod !== 'undefined') {
        stemGod = calculateTenGod(dayStem, dayun.stem);
    }
    
    // æ ¹æ“šåç¥åˆ¤æ–·å‰å‡¶ï¼ˆç°¡åŒ–ç‰ˆï¼‰
    const goodGods = ['æ­£å®˜', 'æ­£è²¡', 'æ­£å°', 'é£Ÿç¥'];
    const badGods = ['ä¸ƒæ®º', 'å‚·å®˜', 'åå°', 'åŠ«è²¡'];
    
    let luck = 'å¹³é‹';
    if (goodGods.includes(stemGod)) {
        luck = 'å‰é‹';
    } else if (badGods.includes(stemGod)) {
        luck = 'å‡¶é‹';
    }
    
    return {
        tenGod: stemGod,
        luck: luck,
        description: `æ­¤å¤§é‹ç‚º${stemGod}ï¼Œå±¬æ–¼${luck}`
    };
}

// å°å‡ºå‡½æ•¸
// if (typeof module !== 'undefined' && // module.exports) {
    // module.exports = {
        isYangYear,
        getNextGanZhi,
        calculateStartAge,
        calculateDayun,
        getCurrentDayun,
        analyzeDayunLuck
    };
}


        // ===== è¼”åŠ©å‡½æ•¸ï¼šç²å–æŸå¹´çš„æ‰€æœ‰ç¯€æ°£ =====
        function getSolarTermsForYear(year) {
            const baseTimeForYear = 31556925974.7 * (year - 1900) + Date.UTC(1900,0,6,2,5);
            let solarTermsDates = [];
            for(let n = 0; n < SOLAR_TERMS.length; n++) {
                let termDate = new Date(baseTimeForYear + SOLAR_TERMS[n].minutes * 60000);
                solarTermsDates.push({ 
                    longitude: SOLAR_TERMS[n].longitude, 
                    term: SOLAR_TERMS[n].cn, 
                    date: termDate 
                });
            }
            return solarTermsDates;
        }

        // ===== åç¥åˆ†ææ•´åˆ =====
        // é¡¯ç¤ºå…«å­—çµæœ
        function displayBazi(bazi, name, gender) {
            const baziDisplay = document.getElementById('baziDisplay');
            const interpretation = document.getElementById('interpretation');
            
            // è¨ˆç®—åç¥
            const tenGods = analyzeTenGods(bazi);
            const tenGodsCount = countTenGods(tenGods);
            const pattern = analyzePattern(tenGodsCount, bazi);
            
            baziDisplay.innerHTML = `
                <div class="pillar">
                    <div class="pillar-title">å¹´æŸ±</div>
                    <div class="pillar-char">${bazi.year.stem}</div>
                    <div class="pillar-char">${bazi.year.branch}</div>
                    <div class="element">${elements[heavenlyStems.indexOf(bazi.year.stem)]}/${branchElements[earthlyBranches.indexOf(bazi.year.branch)]}</div>
                    <div class="tengod">${tenGods.year.stem}</div>
                </div>
                <div class="pillar">
                    <div class="pillar-title">æœˆæŸ±</div>
                    <div class="pillar-char">${bazi.month.stem}</div>
                    <div class="pillar-char">${bazi.month.branch}</div>
                    <div class="element">${elements[heavenlyStems.indexOf(bazi.month.stem)]}/${branchElements[earthlyBranches.indexOf(bazi.month.branch)]}</div>
                    <div class="tengod">${tenGods.month.stem}</div>
                </div>
                <div class="pillar">
                    <div class="pillar-title">æ—¥æŸ±ï¼ˆæ—¥ä¸»ï¼‰</div>
                    <div class="pillar-char">${bazi.day.stem}</div>
                    <div class="pillar-char">${bazi.day.branch}</div>
                    <div class="element">${elements[heavenlyStems.indexOf(bazi.day.stem)]}/${branchElements[earthlyBranches.indexOf(bazi.day.branch)]}</div>
                    <div class="tengod">æœ¬å‘½</div>
                </div>
                <div class="pillar">
                    <div class="pillar-title">æ™‚æŸ±</div>
                    <div class="pillar-char">${bazi.hour.stem}</div>
                    <div class="pillar-char">${bazi.hour.branch}</div>
                    <div class="element">${elements[heavenlyStems.indexOf(bazi.hour.stem)]}/${branchElements[earthlyBranches.indexOf(bazi.hour.branch)]}</div>
                    <div class="tengod">${tenGods.hour.stem}</div>
                </div>
            `;

            const dayElement = elements[heavenlyStems.indexOf(bazi.day.stem)];
            const genderText = gender === 'male' ? 'å…ˆç”Ÿ' : 'å¥³å£«';

            // ç”Ÿæˆåç¥åˆ†ææ–‡å­—
            let tenGodsAnalysis = '<h4 style="color:#ffd700;margin-top:20px;">ğŸ”® åç¥åˆ†æ</h4>';
            tenGodsAnalysis += `<p><strong>å‘½æ ¼ï¼š</strong>${pattern.description}</p>`;
            tenGodsAnalysis += '<p><strong>åç¥åˆ†å¸ƒï¼š</strong>';
            for (const god in tenGodsCount) {
                const desc = getTenGodDescription(god);
                tenGodsAnalysis += `${god}(${desc.category})Ã—${tenGodsCount[god]} `;
            }
            tenGodsAnalysis += '</p>';
            
            // ä¸»è¦åç¥è©³è§£
            if (pattern.mainGod) {
                const mainDesc = getTenGodDescription(pattern.mainGod);
                tenGodsAnalysis += `<p><strong>ä¸»æ˜Ÿç‰¹è³ªï¼š</strong>${mainDesc.personality}</p>`;
                tenGodsAnalysis += `<p><strong>å„ªé»ï¼š</strong>${mainDesc.positive}</p>`;
                tenGodsAnalysis += `<p><strong>æ³¨æ„ï¼š</strong>${mainDesc.negative}</p>`;
            }
            
            interpretation.innerHTML = `
                <h3>âœ¨ ${name}${genderText}çš„å‘½ç†è§£æ</h3>
                <p><strong>æ—¥ä¸»äº”è¡Œï¼š</strong>${dayElement}</p>
                ${tenGodsAnalysis}
                <h4 style="color:#ffd700;margin-top:20px;">ğŸŒŸ äº”è¡Œé‹å‹¢</h4>
                <p><strong>æ€§æ ¼ç‰¹è³ªï¼š</strong>${getPersonalityByElement(dayElement)}</p>
                <p><strong>äº‹æ¥­é‹å‹¢ï¼š</strong>${getCareerByElement(dayElement)}</p>
                <p><strong>è²¡é‹åˆ†æï¼š</strong>${getWealthByElement(dayElement)}</p>
                <p><strong>æ„Ÿæƒ…é‹å‹¢ï¼š</strong>${getLoveByElement(dayElement)}</p>
                <p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); color: #ffd700;">
                    â­ å‘½ç†å»ºè­°ï¼šä¿æŒç©æ¥µæ¨‚è§€çš„å¿ƒæ…‹ï¼Œé †æ‡‰è‡ªç„¶è¦å¾‹ï¼Œæ–¹èƒ½è¶¨å‰é¿å‡¶ï¼Œé–‹å‰µç¾å¥½æœªä¾†ã€‚
                </p>
            `;

            // è¨ˆç®—å¤§é‹
            const dayunInfo = calculateDayun(bazi, gender, birthDate, getSolarTermsForYear, 8);
            const currentYear = new Date().getFullYear();
            const currentAge = currentYear - birthDate.getFullYear();
            const currentDayun = getCurrentDayun(dayunInfo, currentAge);
            
            // é¡¯ç¤ºå¤§é‹
            let dayunHTML = '<h4 style="color:#ffd700;margin-top:20px;">ğŸŒ  å¤§é‹æ¨ç®—</h4>';
            dayunHTML += `<p><strong>èµ·é‹æ­²æ•¸ï¼š</strong>${dayunInfo.startAge}æ­²</p>`;
            dayunHTML += `<p><strong>å¤§é‹æ–¹å‘ï¼š</strong>${dayunInfo.direction}ï¼ˆ${isYangYear(bazi.year.stem) ? 'é™½å¹´' : 'é™°å¹´'}${gender === 'male' ? 'ç”·å‘½' : 'å¥³å‘½'}ï¼‰</p>`;
            
            if (currentDayun) {
                const dayunAnalysis = analyzeDayunLuck(currentDayun, bazi);
                dayunHTML += `<p style="background:rgba(255,215,0,0.1);padding:10px;border-radius:5px;border-left:3px solid #ffd700;">`;
                dayunHTML += `<strong>ç›®å‰å¤§é‹ï¼ˆ${currentAge}æ­²ï¼‰ï¼š</strong>${currentDayun.ganZhi}ï¼ˆ${currentDayun.ageStart}-${currentDayun.ageEnd}æ­²ï¼‰<br>`;
                dayunHTML += `<strong>åç¥ï¼š</strong>${dayunAnalysis.tenGod} | <strong>é‹å‹¢ï¼š</strong>${dayunAnalysis.luck}`;
                dayunHTML += `</p>`;
            }
            
            dayunHTML += '<div style="margin-top:15px;"><table style="width:100%;border-collapse:collapse;">';
            dayunHTML += '<tr style="background:rgba(255,215,0,0.2);"><th style="padding:8px;border:1px solid rgba(255,215,0,0.3);">å¤§é‹</th><th style="padding:8px;border:1px solid rgba(255,215,0,0.3);">å¹²æ”¯</th><th style="padding:8px;border:1px solid rgba(255,215,0,0.3);">å¹´é½¡</th><th style="padding:8px;border:1px solid rgba(255,215,0,0.3);">å¹´ä»½</th><th style="padding:8px;border:1px solid rgba(255,215,0,0.3);">åç¥</th></tr>';
            
            for (const dayun of dayunInfo.dayunList) {
                const analysis = analyzeDayunLuck(dayun, bazi);
                const isCurrent = currentDayun && dayun.index === currentDayun.index;
                const rowStyle = isCurrent ? 'background:rgba(255,215,0,0.15);font-weight:bold;' : '';
                dayunHTML += `<tr style="${rowStyle}">`;
                dayunHTML += `<td style="padding:8px;border:1px solid rgba(255,215,0,0.3);text-align:center;">${dayun.index}</td>`;
                dayunHTML += `<td style="padding:8px;border:1px solid rgba(255,215,0,0.3);text-align:center;">${dayun.ganZhi}</td>`;
                dayunHTML += `<td style="padding:8px;border:1px solid rgba(255,215,0,0.3);text-align:center;">${dayun.ageStart}-${dayun.ageEnd}</td>`;
                dayunHTML += `<td style="padding:8px;border:1px solid rgba(255,215,0,0.3);text-align:center;">${dayun.yearStart}-${dayun.yearEnd}</td>`;
                dayunHTML += `<td style="padding:8px;border:1px solid rgba(255,215,0,0.3);text-align:center;">${analysis.tenGod}</td>`;
                dayunHTML += `</tr>`;
            }
            
            dayunHTML += '</table></div>';
            
            // å°‡å¤§é‹HTMLåŠ å…¥åˆ° interpretation
            interpretation.innerHTML += dayunHTML;
            
            document.getElementById('resultSection').classList.add('show');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // æ ¹æ“šäº”è¡Œç²å–æ€§æ ¼æè¿°
        function getPersonalityByElement(element) {
            const personalities = {
                'æœ¨': 'æ€§æ ¼ä»æ…ˆæ­£ç›´ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒï¼Œå…·æœ‰å‘ä¸Šç™¼å±•çš„ç‰¹æ€§ï¼Œç‚ºäººæ­£ç›´å–„è‰¯ï¼Œå¾…äººå’Œè—¹å¯è¦ªã€‚',
                'ç«': 'æ€§æ ¼ç†±æƒ…ç©æ¥µï¼Œå…·æœ‰ç¦®è²Œä¿®é¤Šï¼Œå–„æ–¼ç¤¾äº¤ï¼Œå¯Œæœ‰é€²å–ç²¾ç¥å’Œé ˜å°æ‰èƒ½ã€‚',
                'åœŸ': 'æ€§æ ¼ç©©é‡è¸å¯¦ï¼Œèª å¯¦å®ˆä¿¡ï¼Œå…·æœ‰åŒ…å®¹å¿ƒï¼Œç‚ºäººå¿ åšè€å¯¦ï¼Œå€¼å¾—ä¿¡è³´ã€‚',
                'é‡‘': 'æ€§æ ¼å‰›æ¯…æœæ–·ï¼Œè¬›ç©¶ç¾©æ°£ï¼Œæœ‰æ­£ç¾©æ„Ÿï¼Œåšäº‹èªçœŸè² è²¬ï¼Œæ„å¿—å …å®šã€‚',
                'æ°´': 'æ€§æ ¼è°æ˜éˆæ´»ï¼Œå¯Œæœ‰æ™ºæ…§ï¼Œå–„æ–¼æ€è€ƒï¼Œé©æ‡‰èƒ½åŠ›å¼·ï¼Œå…·æœ‰å‰µæ–°ç²¾ç¥ã€‚'
            };
            return personalities[element] || 'æ€§æ ¼ç‰¹è³ªå¾…åˆ†æ';
        }

        // æ ¹æ“šäº”è¡Œç²å–äº‹æ¥­æè¿°
        function getCareerByElement(element) {
            const careers = {
                'æœ¨': 'é©åˆå¾äº‹æ•™è‚²ã€æ–‡åŒ–ã€è—è¡“ã€åœ’æ—ã€é†«ç™‚ç­‰è¡Œæ¥­ï¼Œäº‹æ¥­ç™¼å±•ç©©å¥å‘ä¸Šã€‚',
                'ç«': 'é©åˆå¾äº‹å‚³åª’ã€è—è¡“ã€è¡¨æ¼”ã€ç§‘æŠ€ã€ç®¡ç†ç­‰è¡Œæ¥­ï¼Œäº‹æ¥­å®¹æ˜“æœ‰çªç ´æ€§ç™¼å±•ã€‚',
                'åœŸ': 'é©åˆå¾äº‹æˆ¿åœ°ç”¢ã€å»ºç¯‰ã€è¾²æ¥­ã€ä¸­ä»‹ã€é¡§å•ç­‰è¡Œæ¥­ï¼Œäº‹æ¥­æ ¹åŸºç©©å›ºã€‚',
                'é‡‘': 'é©åˆå¾äº‹é‡‘èã€æ³•å¾‹ã€è»è­¦ã€æ©Ÿæ¢°ã€å·¥ç¨‹ç­‰è¡Œæ¥­ï¼Œäº‹æ¥­è¬›æ±‚ç²¾æº–å’Œæ•ˆç‡ã€‚',
                'æ°´': 'é©åˆå¾äº‹è²¿æ˜“ã€ç‰©æµã€æ—…éŠã€æ°´ç”¢ã€ä¿¡æ¯ç­‰è¡Œæ¥­ï¼Œäº‹æ¥­ç™¼å±•éˆæ´»å¤šè®Šã€‚'
            };
            return careers[element] || 'äº‹æ¥­é‹å‹¢å¾…åˆ†æ';
        }

        // æ ¹æ“šäº”è¡Œç²å–è²¡é‹æè¿°
        function getWealthByElement(element) {
            const wealth = {
                'æœ¨': 'è²¡é‹ç©©å¥ï¼Œé©åˆé•·æœŸæŠ•è³‡ï¼Œè²¡å¯Œç©ç´¯å¦‚æ¨¹æœ¨ç”Ÿé•·èˆ¬å¾ªåºæ¼¸é€²ã€‚',
                'ç«': 'è²¡é‹æ—ºç››ï¼Œåè²¡é‹è¼ƒå¥½ï¼Œä½†éœ€æ³¨æ„ç†è²¡è¦åŠƒï¼Œé¿å…å¤§èµ·å¤§è½ã€‚',
                'åœŸ': 'è²¡é‹ç©©å®šï¼Œå–„æ–¼ç©ç´¯è²¡å¯Œï¼Œé©åˆç©©å¥å‹æŠ•è³‡ï¼Œè²¡å¯Œæ ¹åŸºæ·±åšã€‚',
                'é‡‘': 'è²¡é‹ä¸éŒ¯ï¼Œæ­£è²¡ç‚ºä¸»ï¼Œé€šéåŠªåŠ›å·¥ä½œå¯ç²å¾—è±åšå›å ±ã€‚',
                'æ°´': 'è²¡é‹éˆæ´»ï¼Œè²¡è·¯è¼ƒå»£ï¼Œé©åˆå¤šå…ƒåŒ–æŠ•è³‡ï¼ŒæŠŠæ¡æ©Ÿé‡èƒ½æœ‰ä¸éŒ¯æ”¶ç›Šã€‚'
            };
            return wealth[element] || 'è²¡é‹åˆ†æå¾…è§£è®€';
        }

        // æ ¹æ“šäº”è¡Œç²å–æ„Ÿæƒ…æè¿°
        function getLoveByElement(element) {
            const love = {
                'æœ¨': 'æ„Ÿæƒ…çœŸæ‘¯ï¼Œå°æ„›æƒ…å¿ èª å°ˆä¸€ï¼Œé©åˆç´°æ°´é•·æµçš„æ„Ÿæƒ…æ¨¡å¼ã€‚',
                'ç«': 'æ„Ÿæƒ…ç†±çƒˆï¼Œå……æ»¿æ¿€æƒ…ï¼Œä½†éœ€æ³¨æ„æƒ…ç·’ç®¡ç†ï¼Œç¶­æŒæ„Ÿæƒ…çš„ç©©å®šæ€§ã€‚',
                'åœŸ': 'æ„Ÿæƒ…ç©©é‡ï¼Œé‡è¦–å®¶åº­ï¼Œæ˜¯å€¼å¾—ä¾é çš„ä¼´ä¾¶ï¼Œå©šå§»ç”Ÿæ´»å®‰ç©©å¹¸ç¦ã€‚',
                'é‡‘': 'æ„Ÿæƒ…å°ˆä¸€ï¼Œé‡è¦–æ‰¿è«¾ï¼Œå°æ„Ÿæƒ…èªçœŸè² è²¬ï¼Œæ˜¯å¯é çš„çµ‚èº«ä¼´ä¾¶ã€‚',
                'æ°´': 'æ„Ÿæƒ…ç´°è†©ï¼Œå–„è§£äººæ„ï¼Œæºé€šèƒ½åŠ›å¼·ï¼Œèƒ½ç‡Ÿé€ å’Œè«§çš„æ„Ÿæƒ…æ°›åœã€‚'
            };
            return love[element] || 'æ„Ÿæƒ…é‹å‹¢å¾…åˆ†æ';
        }

        // è¡¨å–®æäº¤è™•ç†
        document.getElementById('baziForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const gender = document.getElementById('gender').value;
            const birthdate = document.getElementById('birthdate').value;
            const hour = document.getElementById('hour').value;
            const minute = document.getElementById('minute').value;
            
            const birthDate = new Date(birthdate);
            birthDate.setHours(parseInt(hour), parseInt(minute), 0);
            
            const bazi = calculateBazi(birthDate);
            displayBazi(bazi, name, gender);
        });

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function() {
            createStars();
            initTimeSelectors();
        });
    </script>
<script src="../mobile-nav.js"></script>
</body>
</html>
