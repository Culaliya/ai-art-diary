<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿåº§å‘½ç›¤æ’ç›¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            background: #0a0a1a;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #e0e0ff;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, #e0e0ff, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #e0e0ff, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 4s linear infinite;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(70, 70, 150, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(100, 50, 180, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(60, 120, 200, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: nebula 10s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        @keyframes nebula {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(10, 10, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            overflow: hidden;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .header {
            background: linear-gradient(45deg, #1a1a3d, #2a1a5d);
            color: #ffd700;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }

        .header::before {
            content: '[Star]';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            animation: sparkle 2s infinite;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            color: #ffd700;
            font-weight: bold;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            color: #e0e0ff;
        }

        .input-section {
            padding: 40px;
            background: rgba(15, 15, 40, 0.7);
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(100, 100, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(20, 20, 50, 0.8);
            color: #e0e0ff;
            transition: all 0.3s;
        }

        input::placeholder {
            color: rgba(200, 200, 255, 0.6);
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            background: rgba(30, 30, 70, 0.9);
        }

        .btn-generate {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #4a1a8d, #6a2ad8);
            color: #ffd700;
            border: 2px solid #ffd700;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            box-shadow: 0 5px 15px rgba(106, 42, 216, 0.4);
        }

        .btn-generate:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(106, 42, 216, 0.6);
            background: linear-gradient(45deg, #5a2ad8, #8a4af8);
        }

        .btn-generate:active {
            transform: translateY(-1px);
        }

        .results {
            padding: 40px;
            display: none;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .planet-card {
            background: linear-gradient(135deg, rgba(70, 26, 141, 0.9) 0%, rgba(106, 42, 216, 0.9) 100%);
            color: #ffd700;
            padding: 22px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
        }

        .planet-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(106, 42, 216, 0.6);
        }

        .planet-card.earth {
            background: linear-gradient(135deg, rgba(30, 70, 150, 0.9) 0%, rgba(60, 120, 200, 0.9) 100%);
            border-color: #87CEEB;
        }

        .planet-card.moon {
            background: linear-gradient(135deg, rgba(100, 50, 180, 0.9) 0%, rgba(150, 100, 220, 0.9) 100%);
            border-color: #DDA0DD;
        }

        .planet-card.sun {
            background: linear-gradient(135deg, rgba(180, 80, 50, 0.9) 0%, rgba(255, 140, 0, 0.9) 100%);
            border-color: #FFD700;
        }

        .planet-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .zodiac-sign {
            font-size: 1.6em;
            margin: 12px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            font-weight: bold;
        }

        .degree {
            font-size: 1em;
            opacity: 0.9;
            color: #e0e0ff;
        }

        .interpretation {
            background: rgba(15, 15, 40, 0.7);
            padding: 30px;
            border-radius: 16px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .interpretation h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.4em;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }

        .interpretation p {
            line-height: 1.8;
            color: #e0e0ff;
            margin-bottom: 12px;
            font-size: 1.05em;
        }

        .zodiac-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .zodiac-card {
            background: rgba(20, 20, 50, 0.7);
            padding: 22px;
            border-radius: 14px;
            border-left: 4px solid #ffd700;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s;
        }

        .zodiac-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
        }

        .zodiac-card h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1.2em;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .zodiac-card p {
            color: #e0e0ff;
            line-height: 1.6;
        }

        .privacy {
            background: rgba(10, 10, 30, 0.8);
            color: #b0b0ff;
            padding: 20px;
            text-align: center;
            font-size: 0.9em;
            border-top: 1px solid rgba(100, 100, 255, 0.3);
        }

        .privacy a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }

        .privacy a:hover {
            text-decoration: underline;
        }

        .back-btn {
            display: block;
            width: 160px;
            margin: 20px auto;
            padding: 12px 20px;
            background: linear-gradient(45deg, #1a1a3d, #2a2a6d);
            color: #00ffff;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            text-decoration: none;
            border-radius: 50px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .back-btn::before {
            content: '[Home]';
            margin-right: 8px;
            font-size: 1.2em;
        }

        .back-btn:hover {
            background: linear-gradient(45deg, #2a2a6d, #3a3a9d);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.8);
            transform: translateY(-2px);
            color: #fff;
        }

        .back-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .input-section, .results {
                padding: 20px;
            }

            .back-btn {
                width: 140px;
                font-size: 1em;
                padding: 10px 16px;
            }
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ˜Ÿåº§å‘½ç›¤æ’ç›¤å·¥å…·</h1>
            <p>æ¢ç´¢å®‡å®™çš„å¥§ç§˜ï¼Œè§£é–ä½ çš„æ˜Ÿè¾°æ•…äº‹</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" id="birthDate" required>
            </div>
            
            <div class="input-group">
                <label for="birthTime">å‡ºç”Ÿæ™‚é–“</label>
                <input type="time" id="birthTime" required>
            </div>
            
            <div class="input-group">
                <label for="birthPlace">å‡ºç”Ÿåœ°é» (åŸå¸‚)</label>
                <input type="text" id="birthPlace" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚" required>
            </div>
            
            <button class="btn-generate" onclick="generateChart()">ç”Ÿæˆå‘½ç›¤</button>
        </div>

        <div class="results" id="results">
            <div class="chart-grid" id="chartGrid"></div>
            
            <div class="interpretation" id="interpretation"></div>
            
            <div class="zodiac-info" id="zodiacInfo"></div>
        </div>

        <a href="fortune_lab.html" class="back-btn">å›é¦–é </a>

        <div class="privacy">
            <p>æœ¬å·¥å…·ä½¿ç”¨ AstrologyAPI æä¾›ç²¾æº–å¤©æ–‡è¨ˆç®—ã€‚æ‚¨çš„å‡ºç”Ÿè³‡æ–™åƒ…ç”¨æ–¼ç”Ÿæˆå€‹äººå‘½ç›¤ï¼Œä¸æœƒå„²å­˜æˆ–åˆ†äº«çµ¦ç¬¬ä¸‰æ–¹ã€‚<br>
            å¦‚æœ‰ç–‘æ…®ï¼Œè«‹åƒé–±æˆ‘å€‘çš„ <a href="#privacy">éš±ç§æ”¿ç­–</a>ã€‚</p>
        </div>
    </div>

    <script>
/* ========== ä½ è¦å¡«é€™è£¡ ========== */
/* AstrologyAPI å¤šåŠéœ€è¦ userId + apiKey åš Basic Auth
   è‹¥ä½ ç¢ºå®šæ˜¯ã€ŒBearerã€æ–¹æ¡ˆï¼Œå°±æŠŠ USE_BASIC=falseï¼Œä¸¦ç•™ API_BEARER å°±å¥½ã€‚ */
const USE_BASIC   = true;                          // â† æœ‰ userId + apiKey å°±è¨­ true
const ASTRO_USER  = 'YOUR_USER_ID';                // â† é€™å€‹è¦æ›æˆä½ çš„ userId
const ASTRO_KEY   = 'QHh4C2NS8q2GfaVyMe065AEYgBxpeBIaHTzUz5S6';  // â† ä½ çš„ api_key
const API_BEARER  = 'QHh4C2NS8q2GfaVyMe065AEYgBxpeBIaHTzUz5S6';  // è‹¥ä½ çš„æ–¹æ¡ˆæ˜¯ Bearerï¼Œç•™é€™å€‹
const API_BASE    = 'https://json.astrologyapi.com/v1';
const TZ_OFFSET   = 8; // å°ç£ +8

/* ====== UI å…ƒä»¶ ====== */
const birthDateEl = document.getElementById('birthDate');
const birthTimeEl = document.getElementById('birthTime');
const birthPlaceEl= document.getElementById('birthPlace');
const btnGen      = document.getElementById('btnGen') || document.querySelector('.btn-generate') || document.querySelector('button');
const resultsEl   = document.getElementById('results');
const statusEl    = document.getElementById('status')  || document.querySelector('.loading');
const cardsEl     = document.getElementById('cards')   || document.getElementById('chartGrid');

/* ====== åˆå§‹åŒ–æ—¥æœŸæ™‚é–“ ====== */
(function initNow(){
  const now=new Date();
  birthDateEl.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  birthTimeEl.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
})();
btnGen.addEventListener('click', generate);

/* ====== åŸå¸‚å¿«å–è¡¨ï¼ˆé¿å… OSM å¶ç™¼ 403ï¼‰ ====== */
const cityTable = {
  'å°åŒ—':{lat:25.0375,lon:121.5637}, 'è‡ºåŒ—':{lat:25.0375,lon:121.5637}, 'taipei':{lat:25.0375,lon:121.5637},
  'æ–°åŒ—':{lat:25.0139,lon:121.4637}, 'æ–°ç«¹':{lat:24.8066,lon:120.9686}, 'æ¡ƒåœ’':{lat:24.9937,lon:121.2969},
  'å°ä¸­':{lat:24.1477,lon:120.6736}, 'è‡ºä¸­':{lat:24.1477,lon:120.6736}, 'å°å—':{lat:22.9997,lon:120.2270},
  'è‡ºå—':{lat:22.9997,lon:120.2270}, 'é«˜é›„':{lat:22.6273,lon:120.3014}, 'kaohsiung':{lat:22.6273,lon:120.3014}
};

/* ====== ç°¡é«”è½‰æ›ï¼ˆAPI å›å‚³è‹±æ–‡å­—ï¼‰ ====== */
const en2zh = { Aries:'ç‰¡ç¾Šåº§', Taurus:'é‡‘ç‰›åº§', Gemini:'é›™å­åº§', Cancer:'å·¨èŸ¹åº§', Leo:'ç…å­åº§',
  Virgo:'è™•å¥³åº§', Libra:'å¤©ç§¤åº§', Scorpio:'å¤©è åº§', Sagittarius:'å°„æ‰‹åº§', Capricorn:'æ‘©ç¾¯åº§', Aquarius:'æ°´ç“¶åº§', Pisces:'é›™é­šåº§' };

/* ====== æ–‡æ¡ˆ ====== */
const textSun = {
 'ç‰¡ç¾Šåº§':'ç†±æƒ…ç›´æ¥ã€è¡Œå‹•æ´¾ï¼Œé©åˆä¸»å‹•å‡ºæ“Šçš„èˆå°ã€‚','é‡‘ç‰›åº§':'ç©©å®šå‹™å¯¦ã€æ„Ÿå®˜æ•éŠ³ï¼Œé‡è¦–å®‰å…¨èˆ‡å“è³ªã€‚',
 'é›™å­åº§':'éˆæ´»å¥½å¥‡ã€è³‡è¨Šé›·é”ï¼Œæ“…é•·é€£çµäººèˆ‡æƒ³æ³•ã€‚','å·¨èŸ¹åº§':'æƒ…æ„Ÿè±å¯Œã€å®ˆè­·èƒ½é‡å¼·ï¼Œé‡è¦–å®¶èˆ‡æ­¸å±¬ã€‚',
 'ç…å­åº§':'è‡ªä¿¡è€€çœ¼ã€å‰µé€ åŠ›å¼·ï¼Œå–œæ­¡æˆç‚ºç„¦é»ã€‚','è™•å¥³åº§':'ç´°ç¯€æ§ã€æå‡æ´¾ï¼Œè¿½æ±‚ç§©åºèˆ‡æœ‰æ•ˆç‡ã€‚',
 'å¤©ç§¤åº§':'å„ªé›…å¹³è¡¡ã€ç¤¾äº¤é«˜æ‰‹ï¼Œæ“…é•·å”èª¿èˆ‡å¯©ç¾ã€‚','å¤©è åº§':'æ·±åº¦èˆ‡æ´å¯ŸåŠ›å…¼å…·ï¼Œå¿ èª è€Œå¼·çƒˆã€‚',
 'å°„æ‰‹åº§':'è‡ªç”±æ¨‚è§€ã€é æ–¹å¬å–šï¼Œç†±æ„›æ¢ç´¢èˆ‡çœŸç›¸ã€‚','æ‘©ç¾¯åº§':'è€åŠ›èˆ‡è²¬ä»»æ„Ÿæ»¿é»ï¼Œè¨ˆåŠƒæ´¾çš„å¯¦è¸è€…ã€‚',
 'æ°´ç“¶åº§':'å‰è¡›ç¨ç«‹ã€é»å­æ€ªç¾ï¼Œé‡è¦–ç†æƒ³èˆ‡è‡ªç”±ã€‚','é›™é­šåº§':'æµªæ¼«ç›´è¦ºã€å…±æ„ŸåŠ›é«˜ï¼Œæ“æŠ±æƒ³åƒèˆ‡åŒ…å®¹ã€‚'
};
const textMoon = {
 'ç‰¡ç¾Šåº§':'æƒ…ç·’ä¾†å»å¿«ï¼Œéœ€è¦ç«‹å³è¡Œå‹•èˆ‡å›æ‡‰ã€‚','é‡‘ç‰›åº§':'å–œæ­¡å¯é æœŸèˆ‡èˆ’é©ï¼Œæ…¢å³æ˜¯å¿«ã€‚',
 'é›™å­åº§':'éœ€è¦å°è©±èˆ‡æ–°é®®æ„Ÿï¼›è³‡è¨Šå°±æ˜¯å®‰å…¨æ„Ÿã€‚','å·¨èŸ¹åº§':'æ¸´æœ›è¢«ç…§é¡§èˆ‡ç…§é¡§äººï¼Œå®¶æ˜¯èƒ½é‡ä¾†æºã€‚',
 'ç…å­åº§':'è¢«æ¬£è³å°±æœ‰é›»ï¼›å„€å¼èˆ‡èˆå°æœ‰ç™‚æ•ˆã€‚','è™•å¥³åº§':'ç”¨æ•´ç†ä¾†å®‰å®šï¼›ç´°ç¯€åˆ°ä½æ‰å®‰å¿ƒã€‚',
 'å¤©ç§¤åº§':'é—œä¿‚èˆ‡ç¾æ„Ÿè¦å¹³è¡¡ï¼›è¡çªæœƒæ¶ˆè€—èƒ½é‡ã€‚','å¤©è åº§':'æ·±åº¦é€£çµå‹éè¡¨é¢ç¤¾äº¤ï¼›ä¿¡ä»»æ˜¯åº•ç·šã€‚',
 'å°„æ‰‹åº§':'éœ€è¦ç©ºé–“èˆ‡é æ™¯ï¼›å‡ºèµ°æ˜¯è£œçµ¦è€Œä¸æ˜¯é€ƒè·‘ã€‚','æ‘©ç¾¯åº§':'å¯¦éš›å¯é èƒ½å®‰å®šå¿ƒï¼›æˆæœå³å®‰å…¨æ„Ÿã€‚',
 'æ°´ç“¶åº§':'ä¿æŒè·é›¢æ‰èƒ½è¦ªè¿‘ï¼›ç†å¿µåŒé »æœ€é‡è¦ã€‚','é›™é­šåº§':'æƒ…ç·’åƒæ½®æ±ï¼›è—è¡“èˆ‡å¤¢èƒ½è‡ªæˆ‘ä¿®å¾©ã€‚'
};
const textAsc = {
 'ç‰¡ç¾Šåº§':'ç¬¬ä¸€çœ¼å°±å¾ˆæœ‰è¡Œå‹•åŠ›èˆ‡é­„åŠ›ã€‚','é‡‘ç‰›åº§':'æ²‰ç©©æº«å’Œï¼Œçµ¦äººå¯é çš„æ­¥èª¿ã€‚','é›™å­åº§':'è¨Šæ¯éˆé€šï¼Œç¸½æœ‰è©±é¡Œèˆ‡å¥½å¥‡ã€‚',
 'å·¨èŸ¹åº§':'æŸ”è»Ÿè¦ªåˆ‡ï¼Œåƒå®¶ä¸€æ¨£çš„å®‰å…¨æ„Ÿã€‚','ç…å­åº§':'æ˜äº®å¤§æ–¹ï¼Œå¾ˆæœƒå¸¶æ°£æ°›ã€‚','è™•å¥³åº§':'ä¹¾æ·¨ä¿è½ã€å°ˆæ¥­ä»”ç´°ã€‚',
 'å¤©ç§¤åº§':'ç¦®è²Œèˆ‡ç¾æ„Ÿå…¼å…·ï¼Œç¤¾äº¤æ„Ÿå¾ˆå¼·ã€‚','å¤©è åº§':'ç›®å…‰éŠ³åˆ©ã€æ°£å ´æ·±ï¼›ç¥ç§˜å¸å¼•äººã€‚',
 'å°„æ‰‹åº§':'çˆ½æœ—ç›´ç‡ï¼Œæ¨‚è§€å¤–æ”¾ã€‚','æ‘©ç¾¯åº§':'æˆç†Ÿç©©é‡ï¼Œè²¬ä»»æ„Ÿæ»¿é»ã€‚','æ°´ç“¶åº§':'ç‰¹ç«‹ç¨è¡Œï¼Œè§€é»æ–°é®®ã€‚','é›™é­šåº§':'æº«æŸ”å¤¢å¹»ï¼Œæœ‰è—è¡“æ°£æ¯ã€‚'
};

/* ====== ä¸»è¦æµç¨‹ ====== */
async function generate(){
  const dateStr = birthDateEl.value.trim();
  const timeStr = birthTimeEl.value.trim();
  const city    = birthPlaceEl.value.trim();
  if(!dateStr || !timeStr || !city){ alert('è«‹å®Œæ•´å¡«å¯«ï¼šå‡ºç”Ÿæ—¥æœŸ / æ™‚é–“ / åœ°é»'); return; }

  // é¡¯ç¤ºçµæœå®¹å™¨
  if(resultsEl){ resultsEl.style.display='block'; resultsEl.style.opacity=0; }
  if(statusEl){  statusEl.className='loading'; statusEl.textContent='âœ¨ æ­£åœ¨å¬å–šæ˜Ÿè¾°...'; }
  if(cardsEl){   cardsEl.innerHTML=''; }

  // å–åº§æ¨™ï¼šè¡¨å…§ -> OSM -> å°åŒ—
  let latlon = cityTable[city.toLowerCase()] || cityTable[city];
  if(!latlon){
    try{
      const g = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {headers:{'Accept':'application/json'}});
      const gj = await g.json();
      if(gj && gj.length) latlon = {lat:parseFloat(gj[0].lat), lon:parseFloat(gj[0].lon)};
    }catch(_){} // å¿½ç•¥
  }
  if(!latlon) latlon = cityTable['å°åŒ—'];

  const dt = new Date(`${dateStr}T${timeStr}:00`);
  const payload = {
    day: dt.getDate(),
    month: dt.getMonth()+1,
    year: dt.getFullYear(),
    hour: dt.getHours(),
    min: dt.getMinutes(),
    lat: latlon.lat,
    lon: latlon.lon,
    tzone: TZ_OFFSET
  };

  try{
    // 1) å¤ªé™½/æœˆäº®
    const planets = await astroPost('/planets/positions', payload);
    // æœ‰äº›æ–¹æ¡ˆ endpoint æ˜¯ /planets/positionï¼Œä¹Ÿè©¦ä¸€æ¬¡
    const planetsData = planets || await astroPost('/planets/position', payload);

    // 2) ä¸Šå‡
    const ascData = await astroPost('/ascendant', payload);

    const sunEn  = planetsData?.sun?.sign  || 'Aries';
    const moonEn = planetsData?.moon?.sign || 'Taurus';
    const ascEn  = ascData?.ascendant?.sign || ascData?.ascendant || 'Gemini';

    const sunDeg  = Math.round(planetsData?.sun?.degree || 0);
    const moonDeg = Math.round(planetsData?.moon?.degree || 0);
    const ascDeg  = Math.round(ascData?.ascendant?.degree || ascData?.ascendant_degree || 0);

    const sun = en2zh[sunEn]  || 'ç‰¡ç¾Šåº§';
    const moon= en2zh[moonEn] || 'é‡‘ç‰›åº§';
    const asc = en2zh[ascEn]  || roughAscendant(dt.getHours()); // API æ²’å›å°±è¿‘ä¼¼

    drawCards({sun,moon,asc,sDeg:sunDeg,mDeg:moonDeg,aDeg:ascDeg});
    reveal();

  }catch(err){
    console.error('[AstrologyAPI] é€£ç·šå¤±æ•—ï¼š', err);
    if(statusEl){ statusEl.className='error'; statusEl.textContent='ğŸ’« API ç„¡æ³•ä½¿ç”¨ï¼Œæ”¹ç‚ºé›¢ç·šè¿‘ä¼¼ï¼ˆæº–ç¢ºåº¦è¼ƒä½ï¼‰ã€‚'; }
    // é›¢ç·šè¿‘ä¼¼ï¼ˆå¤ªé™½çœŸå¯¦æ—¥æœŸè¡¨ï¼›æœˆäº®/ä¸Šå‡è¿‘ä¼¼ï¼‰
    const {sun} = fallbackSun(dateStr);
    const moon  = roughMoon(dt);
    const asc   = roughAscendant(dt.getHours());
    drawCards({sun,moon,asc,sDeg:rand30(),mDeg:rand30(),aDeg:rand30()});
    reveal();
  }
}

/* ====== å‘¼å« AstrologyAPIï¼šå…ˆ Basic å† Bearer ====== */
async function astroPost(path, payload){
  const url = `${API_BASE}${path}`;
  // æ–¹æ¡ˆä¸€ï¼šBasic (userId:apiKey)
  if(USE_BASIC && ASTRO_USER && ASTRO_KEY){
    const res = await fetch(url,{
      method:'POST',
      headers:{
        'Authorization': 'Basic ' + btoa(`${ASTRO_USER}:${ASTRO_KEY}`),
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });
    if(res.ok) return res.json();
  }
  // æ–¹æ¡ˆäºŒï¼šBearer (éƒ¨åˆ†æ–¹æ¡ˆæä¾›)
  if(API_BEARER){
    const res2 = await fetch(url,{
      method:'POST',
      headers:{
        'Authorization': `Bearer ${API_BEARER}`,
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });
    if(res2.ok) return res2.json();
    throw new Error(`AstrologyAPI ${res2.status}`);
  }
  throw new Error('No valid credentials');
}

/* ====== ç•«é¢ç”Ÿæˆ ====== */
function drawCards({sun,moon,asc,sDeg,mDeg,aDeg}){
  if(statusEl) statusEl.textContent='å‘½ç›¤å·²ç”Ÿæˆ âœ¨';
  const blocks = [
    {title:'å¤ªé™½', cls:'sun',   sign:sun,  deg:sDeg, desc:textSun[sun]},
    {title:'æœˆäº®', cls:'moon',  sign:moon, deg:mDeg, desc:textMoon[moon]},
    {title:'ä¸Šå‡', cls:'earth', sign:asc,  deg:aDeg, desc:textAsc[asc]}
  ];
  cardsEl.innerHTML = blocks.map(b=>`
    <div class="card ${b.cls}">
      <h3>${b.title}</h3>
      <div class="sign">${b.sign}</div>
      <div class="deg">${b.deg}Â°</div>
      <div class="desc">${b.desc || ''}</div>
    </div>`).join('');
}
function reveal(){
  if(!resultsEl) return;
  requestAnimationFrame(()=>{ resultsEl.style.opacity=1; resultsEl.scrollIntoView({behavior:'smooth',block:'start'}); });
}

/* ====== è¿‘ä¼¼ & å·¥å…· ====== */
function rand30(){ return Math.floor(Math.random()*30); }
function fallbackSun(dateStr){
  const md = dateStr.slice(5);
  const table = [
    ['ç‰¡ç¾Šåº§','03-21','04-19'],['é‡‘ç‰›åº§','04-20','05-20'],['é›™å­åº§','05-21','06-20'],
    ['å·¨èŸ¹åº§','06-21','07-22'],['ç…å­åº§','07-23','08-22'],['è™•å¥³åº§','08-23','09-22'],
    ['å¤©ç§¤åº§','09-23','10-22'],['å¤©è åº§','10-23','11-21'],['å°„æ‰‹åº§','11-22','12-21'],
    ['æ‘©ç¾¯åº§','12-22','01-19'],['æ°´ç“¶åº§','01-20','02-18'],['é›™é­šåº§','02-19','03-20']
  ];
  for(const [sign,st,ed] of table){
    if(st<=ed){ if(md>=st&&md<=ed) return {sun:sign}; }
    else { if(md>=st||md<=ed) return {sun:sign}; }
  }
  return {sun:'ç‰¡ç¾Šåº§'};
}
function roughMoon(dt){
  const start = new Date(Date.UTC(2000,0,6));
  const diffDays = (dt - start)/(1000*60*60*24);
  const idx = Math.floor((diffDays/2.46)%12);
  return ['ç‰¡ç¾Šåº§','é‡‘ç‰›åº§','é›™å­åº§','å·¨èŸ¹åº§','ç…å­åº§','è™•å¥³åº§','å¤©ç§¤åº§','å¤©è åº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','é›™é­šåº§'][ (idx+12)%12 ];
}
function roughAscendant(hour){
  const ascList=['ç‰¡ç¾Šåº§','é‡‘ç‰›åº§','é›™å­åº§','å·¨èŸ¹åº§','ç…å­åº§','è™•å¥³åº§','å¤©ç§¤åº§','å¤©è åº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','é›™é­šåº§'];
  return ascList[Math.floor((hour%24)/2)];
}

/* ====== ç¶å®šæŒ‰éˆ•ï¼ˆå…¼å®¹ä½ èˆŠæŒ‰éˆ• classï¼‰ ====== */
document.getElementById('btnGen')?.addEventListener('click', generate);
document.querySelector('.btn-generate')?.addEventListener('click', generate);
</script>

</body>
</html>
