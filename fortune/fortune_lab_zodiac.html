<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>🌌 星座命盤排盤工具｜Culaliya Mystic Lab</title>

<!-- 顏色主題 -->
<style>
:root{
  --bg1:#090a1a; --bg2:#060615;
  --cyan:#00ffff; --pink:#ff3eff; --gold:#ffd86b; --ink:#e0e0ff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Orbitron','Noto Sans TC','Microsoft JhengHei',system-ui,sans-serif;
  background:radial-gradient(circle at 50% 20%, var(--bg1) 0%, var(--bg2) 70%, #000 100%);
  color:var(--ink); min-height:100vh; overflow-x:hidden;
}
canvas#stars{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:screen}
.container{
  position:relative;z-index:1;max-width:900px;margin:32px auto;padding:0 16px;
}
.header{
  background:linear-gradient(45deg,#15153a,#2a1761);
  border:1px solid rgba(255,216,107,.35);
  border-radius:18px; padding:28px 20px; text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}
.header h1{color:var(--gold);font-size:2.2rem;letter-spacing:.05em;
  text-shadow:0 0 14px var(--gold),0 0 28px var(--pink); animation:glow 3s ease-in-out infinite alternate}
.header p{opacity:.9;color:#cfd0ff;margin-top:.5rem}

@keyframes glow{from{ text-shadow:0 0 8px var(--gold)} to{ text-shadow:0 0 16px var(--pink),0 0 32px var(--cyan)}}

.panel{
  margin-top:18px;background:rgba(10,12,30,.75);backdrop-filter:blur(10px);
  border:1px solid rgba(0,255,255,.25);border-radius:16px;padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.35);
}
.grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;align-items:end}
@media (max-width:840px){ .grid{grid-template-columns:1fr 1fr} }
@media (max-width:580px){ .grid{grid-template-columns:1fr} }

label{display:block;margin-bottom:6px;color:var(--gold);font-weight:700}
input{
  width:100%;padding:12px;border-radius:12px;border:1px solid rgba(0,255,255,.35);
  background:rgba(12,16,38,.9);color:#eaf3ff;outline:none;
}
input:focus{border-color:var(--gold);box-shadow:0 0 12px rgba(255,216,107,.45)}

.btn{
  padding:12px 18px;border-radius:14px;font-weight:800;cursor:pointer;border:1px solid var(--gold);
  background:linear-gradient(135deg,#4a1a8d,#6a2ad8);color:var(--gold);text-shadow:0 0 8px rgba(255,216,107,.5);
  box-shadow:0 6px 18px rgba(106,42,216,.5);transition:.25s;
}
.btn:hover{transform:translateY(-2px) scale(1.02); box-shadow:0 12px 28px rgba(106,42,216,.65)}

.results{display:none;margin-top:18px;opacity:0;transition:opacity .6s ease}
.loading{color:var(--gold);font-weight:800;text-align:center;padding:18px}
.error{color:#ff6b6b;background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.35);
  padding:14px;border-radius:12px;text-align:center}

.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:14px}
@media (max-width:840px){ .cards{grid-template-columns:1fr 1fr} }
@media (max-width:580px){ .cards{grid-template-columns:1fr} }

.card{
  background:linear-gradient(135deg,rgba(18,20,46,.92),rgba(12,16,40,.92));
  border:2px solid rgba(0,255,255,.35);border-radius:16px;padding:18px;text-align:center;
  box-shadow:0 0 16px rgba(0,255,255,.25); transition:.28s; position:relative; overflow:hidden;
}
.card:hover{transform:translateY(-6px); box-shadow:0 0 36px var(--pink),0 0 52px var(--cyan)}
.card h3{color:var(--gold);margin-bottom:6px;font-size:1.1rem}
.sign{font-size:1.35rem;font-weight:800;color:#fff;text-shadow:0 0 10px var(--pink)}
.deg{opacity:.9;margin-top:4px}
.desc{margin-top:10px;color:#cfe2ff;line-height:1.6}

.back{
  display:inline-flex;align-items:center;gap:8px;margin:18px auto 0;padding:10px 16px;border-radius:999px;
  border:2px solid var(--cyan); color:var(--cyan); text-decoration:none; font-weight:800;
  background:rgba(0,255,255,.1); box-shadow:0 0 14px rgba(0,255,255,.4); transition:.25s;
}
.back:hover{transform:translateY(-2px); box-shadow:0 0 26px rgba(0,255,255,.75); color:#fff}
.back span{display:inline-block; transform:translateX(0); transition:.25s}
.back:hover span{ transform:translateX(-2px)}
hr.sep{border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,255,.3),transparent);margin:14px 0}
</style>
</head>
<body>
<canvas id="stars"></canvas>

<div class="container" id="top">
  <div class="header">
    <h1>星座命盤排盤工具</h1>
    <p>探索宇宙的奧秘，解鎖你的星辰故事</p>
  </div>

  <div class="panel">
    <div class="grid">
      <div>
        <label>出生日期</label>
        <input type="date" id="birthDate"/>
      </div>
      <div>
        <label>出生時間</label>
        <input type="time" id="birthTime"/>
      </div>
      <div>
        <label>出生地點（城市）</label>
        <input type="text" id="birthPlace" placeholder="例如：台北、台中、台南、Kaohsiung"/>
      </div>
      <div style="grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn" id="btnGen">✨ 生成命盤</button>
        <a class="back" href="../fortune_lab.html">🏠 <span>回命理實驗室</span></a>
      </div>
    </div>
  </div>

  <div class="panel results" id="results">
    <div id="status" class="loading">✨ 正在召喚星辰...</div>
    <hr class="sep"/>
    <div class="cards" id="cards"></div>
  </div>
</div>

<script>
/* ========== 星空動畫（主題色） ========== */
const cvs=document.getElementById('stars'),ctx=cvs.getContext('2d');
let W,H,S=[];
function resize(){W=cvs.width=innerWidth;H=cvs.height=innerHeight;S=[...Array(140)].map(()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+.4,s:Math.random()*.35+.05,a:Math.random()*.6+.25}))}
addEventListener('resize',resize);resize();
(function raf(t=0){ctx.clearRect(0,0,W,H);
  for(const p of S){ctx.beginPath();const f=.6+.4*Math.sin((t+Math.random()*400)/800);
    ctx.fillStyle=`rgba(0,255,255,${p.a*f})`;ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=`rgba(255,62,255,${p.a*(1-f)*.65})`;ctx.fillRect(p.x+1,p.y+1,.8,.8);
    p.y+=p.s; if(p.y>H){p.y=0;p.x=Math.random()*W}
  }
  requestAnimationFrame(raf)
})();

/* ========== API 與常量 ========== */
const API_KEY = 'QHh4C2NS8q2GfaVyMe065AEYgBxpeBIaHTzUz5S6';  // 你提供的金鑰
const API_BASE = 'https://json.astrologyapi.com/v1';    // v1 JSON 端點（支援 Bearer）
const TZ_OFFSET = 8;                                     // 台灣時區 +8

// 常用城市快速表（避免地理 API 宕機時卡住）
const cityTable = {
  '台北':{lat:25.0375,lon:121.5637}, '臺北':{lat:25.0375,lon:121.5637}, 'taipei':{lat:25.0375,lon:121.5637},
  '新北':{lat:25.0139,lon:121.4637}, '基隆':{lat:25.1314,lon:121.7392}, '桃園':{lat:24.9937,lon:121.2969},
  '新竹':{lat:24.8066,lon:120.9686}, '台中':{lat:24.1477,lon:120.6736}, '臺中':{lat:24.1477,lon:120.6736},
  '嘉義':{lat:23.4850,lon:120.4491}, '台南':{lat:22.9997,lon:120.2270}, '臺南':{lat:22.9997,lon:120.2270},
  '高雄':{lat:22.6273,lon:120.3014}, 'kaohsiung':{lat:22.6273,lon:120.3014}, '屏東':{lat:22.6813,lon:120.4813}
};

/* ========== UI 綁定 ========== */
const birthDateEl = document.getElementById('birthDate');
const birthTimeEl = document.getElementById('birthTime');
const birthPlaceEl = document.getElementById('birthPlace');
const btnGen = document.getElementById('btnGen');
const resultsEl = document.getElementById('results');
const statusEl = document.getElementById('status');
const cardsEl = document.getElementById('cards');

btnGen.addEventListener('click', generate);

/* 預設當日時間 */
(function initNow(){
  const now=new Date();
  const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
  const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
  birthDateEl.value = `${y}-${m}-${d}`;
  birthTimeEl.value = `${hh}:${mm}`;
})();

/* ========== 主要流程 ========== */
async function generate(){
  const dateStr = birthDateEl.value, timeStr = birthTimeEl.value, city = birthPlaceEl.value.trim();
  if(!dateStr || !timeStr || !city){
    alert('請完整填寫：出生日期 / 時間 / 地點'); return;
  }
  resultsEl.style.display = 'block'; resultsEl.style.opacity = 0;
  statusEl.className='loading'; statusEl.textContent='✨ 正在召喚星辰...';
  cardsEl.innerHTML='';

  // 定位
  let latlon = cityTable[city.toLowerCase()] || cityTable[city] || null;
  if(!latlon){
    try{
      const g = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {headers:{'Accept':'application/json'}});
      const gj = await g.json();
      if(gj && gj.length){ latlon = {lat:parseFloat(gj[0].lat), lon:parseFloat(gj[0].lon)}; }
    }catch(e){ /* 忽略，留給 fallback */ }
  }
  if(!latlon){ latlon = cityTable['台北']; } // 最終保底

  // 組 payload
  const dt = new Date(`${dateStr}T${timeStr}:00`);
  const payload = {
    day: dt.getDate(),
    month: dt.getMonth()+1,
    year: dt.getFullYear(),
    hour: dt.getHours(),
    min: dt.getMinutes(),
    lat: latlon.lat,
    lon: latlon.lon,
    tzone: TZ_OFFSET
  };

  try{
    const res = await fetch(`${API_BASE}/planets/position`,{
      method:'POST',
      headers:{
        'Authorization': `Bearer ${API_KEY}`,         // 你的 key 以 Bearer 送出
        'Content-Type':'application/json'
      },
      body: JSON.stringify(payload)
    });

    if(!res.ok) throw new Error(`AstrologyAPI ${res.status}`);
    const data = await res.json();

    const sun = mapSign(data.sun?.sign) || '牡羊座';
    const moon = mapSign(data.moon?.sign) || '金牛座';
    const asc  = mapSign(data.ascendant?.sign) || roughAscendant(dt.getHours());

    const sDeg = Math.round(data.sun?.degree || 0);
    const mDeg = Math.round(data.moon?.degree || 0);
    const aDeg = Math.round(data.ascendant?.degree || 0);

    drawCards({sun,moon,asc,sDeg,mDeg,aDeg});
    reveal();

  }catch(err){
    console.error('[API] error:', err);
    statusEl.className='error';
    statusEl.textContent='💫 無法連上天文 API，已切換離線模式（近似推算）。';
    // 離線近似
    const {sun} = fallbackSun(dateStr);
    const moon = roughMoon(dt);
    const asc = roughAscendant(dt.getHours());
    drawCards({sun,moon,asc,sDeg:rand30(),mDeg:rand30(),aDeg:rand30()});
    reveal();
  }
}

/* ========== 畫面生成 ========== */
function drawCards({sun,moon,asc,sDeg,mDeg,aDeg}){
  statusEl.textContent='命盤已生成 ✨';
  const blocks = [
    {title:'太陽', sign:sun, deg:sDeg, cls:'sun', desc: textSun[sun]},
    {title:'月亮', sign:moon, deg:mDeg, cls:'moon', desc: textMoon[moon]},
    {title:'上升', sign:asc, deg:aDeg, cls:'earth', desc: textAsc[asc]}
  ];
  cardsEl.innerHTML = blocks.map(b=>`
    <div class="card ${b.cls}">
      <h3>${b.title}</h3>
      <div class="sign">${b.sign}</div>
      <div class="deg">${b.deg}°</div>
      <div class="desc">${b.desc||''}</div>
    </div>
  `).join('');
}

function reveal(){
  setTimeout(()=>{ resultsEl.style.opacity=1; resultsEl.scrollIntoView({behavior:'smooth',block:'start'}); }, 50);
}

/* ========== 文案庫（簡潔版） ========== */
const textSun = {
 '牡羊座':'熱情直接、行動派，適合主動出擊的舞台。','金牛座':'穩定務實、感官敏銳，重視安全與品質。',
 '雙子座':'靈活好奇、資訊雷達，擅長連結人與想法。','巨蟹座':'情感豐富、守護能量強，重視家與歸屬。',
 '獅子座':'自信耀眼、創造力強，喜歡成為焦點。','處女座':'細節控、提升派，追求秩序與有效率。',
 '天秤座':'優雅平衡、社交高手，擅長協調與審美。','天蠍座':'深度與洞察力兼具，忠誠而強烈。',
 '射手座':'自由樂觀、遠方召喚，熱愛探索與真相。','摩羯座':'耐力與責任感滿點，計劃派的實踐者。',
 '水瓶座':'前衛獨立、點子怪美，重視理想與自由。','雙魚座':'浪漫直覺、共感力高，擁抱想像與包容。'
};
const textMoon = {
 '牡羊座':'情緒來去快，需要立即行動與回應。','金牛座':'喜歡可預期與舒適，慢即是快。',
 '雙子座':'需要對話與新鮮感；資訊就是安全感。','巨蟹座':'渴望被照顧與照顧人，家是能量來源。',
 '獅子座':'被欣賞就有電；儀式與舞台有療效。','處女座':'用整理來安定；細節到位才安心。',
 '天秤座':'關係與美感要平衡；衝突會消耗能量。','天蠍座':'深度連結勝過表面社交；信任是底線。',
 '射手座':'需要空間與遠景；出走是補給而不是逃跑。','摩羯座':'實際可靠能安定心；成果即安全感。',
 '水瓶座':'保持距離才能親近；理念同頻最重要。','雙魚座':'情緒像潮汐；藝術與夢能自我修復。'
};
const textAsc = {
 '牡羊座':'第一眼就很有行動力與魄力。','金牛座':'沉穩溫和，給人可靠的步調。','雙子座':'訊息靈通，總有話題與好奇。',
 '巨蟹座':'柔軟親切，像家一樣的安全感。','獅子座':'明亮大方，很會帶氣氛。','處女座':'乾淨俐落、專業仔細。',
 '天秤座':'禮貌與美感兼具，社交感很強。','天蠍座':'目光銳利、氣場深；神秘吸引人。',
 '射手座':'爽朗直率，樂觀外放。','摩羯座':'成熟穩重，責任感滿點。','水瓶座':'特立獨行，觀點新鮮。','雙魚座':'溫柔夢幻，有藝術氣息。'
};

/* ========== 小工具 & Fallback ========== */
function rand30(){ return Math.floor(Math.random()*30); }
function mapSign(en){
  const m = {Aries:'牡羊座',Taurus:'金牛座',Gemini:'雙子座',Cancer:'巨蟹座',Leo:'獅子座',
             Virgo:'處女座',Libra:'天秤座',Scorpio:'天蠍座',Sagittarius:'射手座',
             Capricorn:'摩羯座',Aquarius:'水瓶座',Pisces:'雙魚座'};
  return m[en];
}
function fallbackSun(dateStr){
  const md = dateStr.slice(5); // MM-DD
  const table = [
   ['牡羊座','03-21','04-19'],['金牛座','04-20','05-20'],['雙子座','05-21','06-20'],
   ['巨蟹座','06-21','07-22'],['獅子座','07-23','08-22'],['處女座','08-23','09-22'],
   ['天秤座','09-23','10-22'],['天蠍座','10-23','11-21'],['射手座','11-22','12-21'],
   ['摩羯座','12-22','01-19'],['水瓶座','01-20','02-18'],['雙魚座','02-19','03-20']
  ];
  for(const [sign,st,ed] of table){
    if(st<=ed){ if(md>=st&&md<=ed) return {sun:sign}; }
    else { if(md>=st||md<=ed) return {sun:sign}; } // 跨年（摩羯）
  }
  return {sun:'牡羊座'};
}
function roughMoon(dt){
  // 極簡近似：每 ~2.46 天換一宮
  const start = new Date(Date.UTC(2000,0,6)); // 參考點
  const diffDays = (dt - start)/(1000*60*60*24);
  const idx = Math.floor((diffDays/2.46)%12);
  return ['牡羊座','金牛座','雙子座','巨蟹座','獅子座','處女座','天秤座','天蠍座','射手座','摩羯座','水瓶座','雙魚座'][ (idx+12)%12 ];
}
function roughAscendant(hour){
  // 小時段近似（2小時一宮）
  const ascList=['牡羊座','金牛座','雙子座','巨蟹座','獅子座','處女座','天秤座','天蠍座','射手座','摩羯座','水瓶座','雙魚座'];
  return ascList[Math.floor((hour%24)/2)];
}
</script>
</body>
</html>
