<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸŒŒ Culaliya Mystic Lab | å‘½ç›¤å…¨å±•é–‹ v5.1</title>
<style>
body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background: radial-gradient(circle at 50% 20%, #08061a 0%, #0e0828 70%, #000 100%);
  color: #fff;
  text-align: center;
  min-height: 100vh;
}
h1 {
  margin-top: 40px;
  color: #ffd700;
  text-shadow: 0 0 20px #ffb347, 0 0 40px #ffd700;
}
.container {
  width: min(90%, 900px);
  margin: 40px auto;
  padding: 20px;
  background: rgba(20, 10, 40, 0.85);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 18px;
  box-shadow: 0 0 40px rgba(255,215,0,0.2);
  backdrop-filter: blur(8px);
}
input, button {
  width: 90%;
  max-width: 400px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ffb347;
  margin: 8px 0;
  font-size: 16px;
}
button {
  background: linear-gradient(90deg, #8a2be2, #7b68ee);
  color: #fff;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  transform: scale(1.03);
  background: linear-gradient(90deg, #9b30ff, #8a2be2);
}
canvas {
  margin-top: 40px;
  background: radial-gradient(circle at 50% 50%, #0a0720 0%, #000 100%);
  border-radius: 50%;
  box-shadow: 0 0 20px rgba(255,215,0,0.3);
}
</style>
</head>
<body>
  <h1>ğŸŒŒ Culaliya Mystic Lab | å‘½ç›¤å…¨å±•é–‹ v5.1</h1>
  <div class="container">
    <label>å‡ºç”Ÿæ—¥æœŸ</label><br>
    <input type="date" id="birthDate" value="2000-01-01"><br>
    <label>å‡ºç”Ÿæ™‚é–“</label><br>
    <input type="time" id="birthTime" value="13:01"><br>
    <label>å‡ºç”Ÿåœ°é»ï¼ˆåŸå¸‚ï¼‰</label><br>
    <input type="text" id="birthPlace" placeholder="Taipei"><br>
    <button id="generate">âœ¨ ç”Ÿæˆå‘½ç›¤</button>
    <canvas id="chart" width="500" height="500"></canvas>
  </div>

<script type="module">
import * as AE from "https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.22/+esm";

// ğŸŒ å–å¾—åŸå¸‚ç¶“ç·¯åº¦
async function getCoordinates(city) {
  const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
  const data = await resp.json();
  if (data.length === 0) throw new Error("æ‰¾ä¸åˆ°åœ°é»");
  return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
}

// ğŸ¯ å°‡è¡Œæ˜Ÿè³‡æ–™ç¹ªè£½åˆ°å‘½ç›¤ä¸Š
function drawChart(planets, ascendant) {
  const c = document.getElementById("chart");
  const ctx = c.getContext("2d");
  const r = c.width / 2;
  ctx.clearRect(0, 0, c.width, c.height);

  // å¤–åœˆ
  ctx.beginPath();
  ctx.arc(r, r, r - 10, 0, Math.PI * 2);
  ctx.strokeStyle = "#FFD700";
  ctx.lineWidth = 2;
  ctx.stroke();

  // åäºŒå®®åˆ†å‰²
  for (let i = 0; i < 12; i++) {
    const angle = (i * 30 - ascendant) * Math.PI / 180;
    ctx.beginPath();
    ctx.moveTo(r, r);
    ctx.lineTo(r + (r - 10) * Math.cos(angle), r + (r - 10) * Math.sin(angle));
    ctx.strokeStyle = "rgba(255,215,0,0.3)";
    ctx.stroke();
  }

  // è¡Œæ˜Ÿä½ç½®é»
  planets.forEach(p => {
    const angle = (p.lon - ascendant) * Math.PI / 180;
    const x = r + (r - 40) * Math.cos(angle);
    const y = r + (r - 40) * Math.sin(angle);
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI * 2);
    ctx.fillStyle = "#ffb347";
    ctx.fill();
    ctx.fillText(p.name, x + 8, y);
  });
}

// ğŸª„ ä¸»å‡½å¼
document.getElementById("generate").onclick = async () => {
  const date = document.getElementById("birthDate").value;
  const time = document.getElementById("birthTime").value;
  const city = document.getElementById("birthPlace").value || "Taipei";
  const birthDateTime = new Date(`${date}T${time}:00+08:00`);
  const { lat, lon } = await getCoordinates(city);

  const observer = new AE.Observer(lat, lon, 0);
  const bodies = ["Sun", "Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn"];
  const planets = [];

  for (const b of bodies) {
    const eq = AE.Equator(b, birthDateTime, observer, true, true);
    const ecl = AE.Ecliptic(eq);
    planets.push({ name: b, lon: ecl.elon });
  }

  // è¨ˆç®—ä¸Šå‡é» (Ascendant)
  const lst = AE.SiderealTime(birthDateTime, lon);
  const asc = AE.Horizon(lst, lat, 0).azimuth; // è¿‘ä¼¼ä¸Šå‡è§’åº¦

  drawChart(planets, asc);
  console.log("ä¸Šå‡è§’åº¦", asc, "è¡Œæ˜Ÿ", planets);
};
</script>
</body>
</html>
