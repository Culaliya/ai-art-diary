<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ğŸŒŒ Culaliya Mystic Lab | å‘½ç›¤å…¨å±•é–‹ v3.6</title>
<style>
body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background: radial-gradient(circle at 50% 20%, #08061a 0%, #0e0828 70%, #000 100%);
  color: #fff;
  text-align: center;
  min-height: 100vh;
}
h1 {
  margin-top: 40px;
  color: #ffd700;
  text-shadow: 0 0 20px #ffb347, 0 0 40px #ffd700;
}
.container {
  width: min(90%, 900px);
  margin: 40px auto;
  padding: 20px;
  background: rgba(20, 10, 40, 0.85);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 18px;
  box-shadow: 0 0 40px rgba(255,215,0,0.2);
  backdrop-filter: blur(8px);
}
input, button {
  width: 90%;
  max-width: 400px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ffb347;
  font-size: 1em;
  background: rgba(255,255,255,0.05);
  color: #fff;
  margin-bottom: 10px;
}
button {
  cursor: pointer;
  background: linear-gradient(45deg,#5a2ad8,#8a4af8);
  border: none;
  color: #fff;
  font-weight: bold;
  transition: all 0.3s;
  box-shadow: 0 0 20px rgba(106,42,216,0.4);
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 35px rgba(255,215,0,0.7);
}
canvas {
  margin-top: 30px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
  box-shadow: 0 0 30px rgba(255,215,0,0.25);
}
.result {
  margin-top: 30px;
  text-align: left;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 15px;
}
.loader {
  margin: 20px auto;
  border: 4px solid rgba(255,255,255,0.1);
  border-top: 4px solid #ffd700;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin 1s linear infinite;
}
@keyframes spin {100%{transform:rotate(360deg)}}
</style>
</head>

<body>
<h1>ğŸŒŒ Culaliya Mystic Lab å‘½ç›¤å…¨å±•é–‹ v3.6</h1>
<div class="container">
  <label>å‡ºç”Ÿæ—¥æœŸ</label>
  <input type="date" id="birthDate">
  <label>å‡ºç”Ÿæ™‚é–“</label>
  <input type="time" id="birthTime">
  <label>å‡ºç”Ÿåœ°é»ï¼ˆåŸå¸‚ï¼‰</label>
  <input type="text" id="birthPlace" placeholder="ä¾‹å¦‚ï¼šTaipei">
  <button id="generateBtn">âœ¨ ç”Ÿæˆå®Œæ•´å‘½ç›¤</button>
  <div id="loading"></div>
  <canvas id="chart" width="500" height="500"></canvas>
  <div class="result" id="result"></div>
</div>

<script>
// Worker proxy URL
const PROXY = "https://floral-term-b81d.culaliya.workers.dev/";

// å–å¾—ç¶“ç·¯åº¦
async function getCoords(place){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?city=${place}&format=json`);
  const d = await res.json();
  if(!d.length) throw new Error("æ‰¾ä¸åˆ°åœ°é»");
  return { lat:+d[0].lat, lon:+d[0].lon };
}

// é€šç”¨å‘¼å«å‡½å¼
async function callProxy(body){
  const res = await fetch(PROXY,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  const raw = await res.text();
  let data;
  try { data = JSON.parse(raw); }
  catch {
    throw new Error("Proxy è¿”å›é JSONï¼Œå¯èƒ½ Cloudflare é€£ä¸ä¸Šä¸Šæ¸¸ã€‚\n" + raw.slice(0,150));
  }
  if(!data.ok){
    const hint = data.payload?.text?.slice(0,120) || data.payload || "";
    throw new Error(`ä¸Šæ¸¸éŒ¯èª¤ ${data.status}ï½œ${hint}`);
  }
  return data.payload;
}

// å‘¼å« AstrologyAPI
async function fetchPlanets(y,m,d,h,min,lat,lon){
  return callProxy({ endpoint:"planets", day:d, month:m, year:y, hour:h, min, lat, lon, tzone:8 });
}
async function fetchHouses(y,m,d,h,min,lat,lon){
  return callProxy({ endpoint:"house_cusps", day:d, month:m, year:y, hour:h, min, lat, lon, tzone:8 });
}
async function fetchDaily(sign){
  return callProxy({ endpoint:`sun_sign_prediction/daily/${encodeURIComponent(sign)}`, method:"POST" });
}

// ç•«å‘½ç›¤
function drawChart(planets,ctx){
  const cx=250,cy=250,r=200;
  ctx.clearRect(0,0,500,500);
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,2*Math.PI);
  ctx.strokeStyle="#ffd700";
  ctx.lineWidth=2;
  ctx.stroke();
  for(let i=0;i<12;i++){
    const angle = (i*30)*Math.PI/180;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+r*Math.cos(angle),cy+r*Math.sin(angle));
    ctx.strokeStyle="rgba(255,255,255,0.2)";
    ctx.stroke();
  }
  planets.forEach(p=>{
    const deg=(p.longitude)*Math.PI/180;
    const px=cx+(r-25)*Math.cos(deg);
    const py=cy+(r-25)*Math.sin(deg);
    ctx.beginPath();
    ctx.arc(px,py,6,0,2*Math.PI);
    ctx.fillStyle="#ffb347";
    ctx.fill();
    ctx.font="10px Noto Sans TC";
    ctx.fillText(p.name,px+8,py+3);
  });
}

// äº‹ä»¶ï¼šç”Ÿæˆå‘½ç›¤
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  const date=document.getElementById("birthDate").value;
  const time=document.getElementById("birthTime").value;
  const place=document.getElementById("birthPlace").value;
  const loading=document.getElementById("loading");
  const result=document.getElementById("result");
  const ctx=document.getElementById("chart").getContext("2d");

  if(!date||!place){alert("è«‹è¼¸å…¥å‡ºç”Ÿæ—¥æœŸèˆ‡åœ°é»");return;}
  loading.innerHTML='<div class="loader"></div><p>â³ æ­£åœ¨ç”Ÿæˆå®Œæ•´å‘½ç›¤...</p>';
  result.innerHTML='';

  try{
    const [y,m,d]=date.split("-").map(Number);
    const [h,min]=time?time.split(":").map(Number):[12,0];
    const {lat,lon}=await getCoords(place);

    const planets=await fetchPlanets(y,m,d,h,min,lat,lon);
    const houses=await fetchHouses(y,m,d,h,min,lat,lon);
    loading.innerHTML='';

    if(!planets || !planets.planets){
      result.innerHTML=`<p style="color:#ffb347;">âš ï¸ ç„¡æ³•å–å¾—è¡Œæ˜Ÿè³‡æ–™</p>`;
      console.warn(planets);
      return;
    }

    drawChart(planets.planets,ctx);
    result.innerHTML="<h3>ğŸª è¡Œæ˜Ÿèˆ‡å®®ä½åˆ†ä½ˆ</h3>";
    planets.planets.forEach(p=>{
      result.innerHTML += `<p><b>${p.name}</b> â†’ ${p.sign} ${p.norm_degree}Â°ï¼ˆå®®ä½ï¼š${p.house_id||"?"}ï¼‰</p>`;
    });

    result.innerHTML+="<h3>ğŸ  å®®ä½èµ·é»</h3>";
    for(let i=1;i<=12;i++){
      const cusp=houses[`house${i}`];
      result.innerHTML+=`<p>ç¬¬${i}å®®ï¼š${cusp.toFixed(2)}Â°</p>`;
    }

    // ğŸ”® ä»Šæ—¥é‹å‹¢
    const sunSign=planets.sun_sign || planets.planets.find(p=>p.name==="Sun")?.sign || "æœªçŸ¥";
    const daily=await fetchDaily(sunSign);
    if(daily && daily.prediction){
      result.innerHTML+=`<h3>ğŸ”® ä»Šæ—¥é‹å‹¢ (${sunSign})</h3><p>${daily.prediction}</p>`;
    }

  }catch(e){
    loading.innerHTML='';
    result.innerHTML=`<p style="color:red;">âš ï¸ éŒ¯èª¤ï¼š${e.message}</p>`;
  }
});
</script>
</body>
</html>
