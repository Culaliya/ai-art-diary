<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>🌌 Culaliya Mystic Lab | 命盤全展開 v5.3</title>
<style>
body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background: radial-gradient(circle at 50% 20%, #08061a 0%, #0e0828 70%, #000 100%);
  color: #fff; text-align: center; min-height: 100vh;
}
h1 {
  margin-top: 40px; color: #ffd700;
  text-shadow: 0 0 20px #ffb347, 0 0 40px #ffd700;
}
.container {
  width: min(90%,900px); margin:40px auto; padding:20px;
  background:rgba(20,10,40,0.85);
  border:1px solid rgba(255,215,0,0.3); border-radius:18px;
  box-shadow:0 0 40px rgba(255,215,0,0.2);
  backdrop-filter:blur(8px);
}
input,button {
  width:90%;max-width:400px;padding:12px;border-radius:10px;
  border:1px solid #ffb347;margin:8px 0;font-size:16px;
}
button {
  background:linear-gradient(90deg,#8a2be2,#7b68ee);
  color:#fff;cursor:pointer;transition:.3s;
}
button:hover {transform:scale(1.03);
  background:linear-gradient(90deg,#9b30ff,#8a2be2);}
canvas {margin-top:40px;background:#0a0720;border-radius:50%;
  box-shadow:0 0 20px rgba(255,215,0,0.3);}
.msg {margin-top:10px;color:#ffb347;}
.desc {margin-top:20px;line-height:1.6;color:#fff;font-size:15px;}
</style>
</head>
<body>
<h1>🌌 Culaliya Mystic Lab | 命盤全展開 v5.3</h1>
<div class="container">
  <label>出生日期</label><br>
  <input type="date" id="birthDate" value="2000-01-01"><br>
  <label>出生時間</label><br>
  <input type="time" id="birthTime" value="13:01"><br>
  <label>出生地點（城市）</label><br>
  <input type="text" id="birthPlace" placeholder="Taipei"><br>
  <button id="generate">✨ 生成命盤</button>
  <div id="msg" class="msg"></div>
  <canvas id="chart" width="500" height="500"></canvas>
  <div id="desc" class="desc"></div>
</div>

<script>
// ---- 計算基礎 ----
function degToRad(d){return d*Math.PI/180;}
function normalize(d){return (d%360+360)%360;}
function calcSunLon(date){
  const Y=date.getUTCFullYear(),M=date.getUTCMonth()+1,D=date.getUTCDate();
  const JD=367*Y-Math.floor(7*(Y+Math.floor((M+9)/12))/4)+Math.floor(275*M/9)+D+1721013.5+date.getUTCHours()/24;
  const n=JD-2451545.0;
  let L=280.46+0.9856474*n;
  const g=357.528+0.9856003*n;
  return normalize(L+1.915*Math.sin(degToRad(g))+0.02*Math.sin(degToRad(2*g)));
}
function calcMoonLon(date){
  const JD=(date.getTime()/86400000)+2440587.5;
  const T=(JD-2451545.0)/36525;
  const L0=218.316+13.176396*T*36525;
  const M=134.963+13.064993*T*36525;
  return normalize(L0+6.289*Math.sin(degToRad(M)));
}
function calcAscendant(date,lat,lon){
  const t=date.getUTCHours()+date.getUTCMinutes()/60;
  const LST=(100.46+0.985647*t*15+lon)%360;
  return normalize(LST+90);
}

// ---- 十二星座符號 ----
const zodiacNames=["♈白羊","♉金牛","♊雙子","♋巨蟹","♌獅子","♍處女","♎天秤","♏天蠍","♐射手","♑摩羯","♒水瓶","♓雙魚"];
function getZodiac(lon){return zodiacNames[Math.floor(lon/30)];}

// ---- 繪圖 ----
function drawChart(planets,asc){
  const c=document.getElementById("chart"),ctx=c.getContext("2d");
  const r=c.width/2;ctx.clearRect(0,0,c.width,c.height);
  ctx.translate(r,r);
  ctx.beginPath();ctx.arc(0,0,r-10,0,2*Math.PI);
  ctx.strokeStyle="#FFD700";ctx.lineWidth=2;ctx.stroke();

  // 十二宮線
  for(let i=0;i<12;i++){
    const a=degToRad(i*30-asc);
    ctx.beginPath();ctx.moveTo(0,0);
    ctx.lineTo((r-10)*Math.cos(a),(r-10)*Math.sin(a));
    ctx.strokeStyle="rgba(255,215,0,0.3)";ctx.stroke();
  }

  // 星座標籤
  ctx.font="14px Noto Sans TC";ctx.fillStyle="#FFD700";
  for(let i=0;i<12;i++){
    const ang=degToRad((i*30+15)-asc);
    const x=(r-40)*Math.cos(ang),y=(r-40)*Math.sin(ang);
    ctx.fillText(zodiacNames[i],x-15,y+4);
  }

  // 四軸標籤 ASC/MC/DC/IC
  const axes=[{name:"ASC",angle:0},{name:"MC",angle:90},{name:"DC",angle:180},{name:"IC",angle:270}];
  ctx.fillStyle="#7b68ee";ctx.font="bold 14px Noto Sans TC";
  axes.forEach(ax=>{
    const a=degToRad(ax.angle-asc);
    const x=(r-60)*Math.cos(a),y=(r-60)*Math.sin(a);
    ctx.fillText(ax.name,x-15,y+4);
  });

  // 行星
  ctx.fillStyle="#ffb347";ctx.font="14px Noto Sans TC";
  planets.forEach(p=>{
    const a=degToRad(p.lon-asc);
    const x=(r-80)*Math.cos(a),y=(r-80)*Math.sin(a);
    ctx.beginPath();ctx.arc(x,y,6,0,2*Math.PI);
    ctx.fill();ctx.fillText(p.name,x+8,y+4);
  });
  ctx.setTransform(1,0,0,1,0,0);
}

// ---- 主流程 ----
document.getElementById("generate").addEventListener("click",async()=>{
  const msg=document.getElementById("msg"),desc=document.getElementById("desc");
  msg.textContent="正在生成命盤...";
  desc.textContent="";
  try{
    const date=document.getElementById("birthDate").value;
    const time=document.getElementById("birthTime").value;
    const city=document.getElementById("birthPlace").value||"Taipei";
    const dt=new Date(`${date}T${time}:00+08:00`);

    let lat=25.033,lng=121.565;
    if(city.toLowerCase()!=="taipei"){
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
        const j=await r.json();if(j[0]){lat=parseFloat(j[0].lat);lng=parseFloat(j[0].lon);}
      }catch{}
    }

    const sunLon=calcSunLon(dt);
    const moonLon=calcMoonLon(dt);
    const asc=calcAscendant(dt,lat,lng);
    const planets=[{name:"☉太陽",lon:sunLon},{name:"☾月亮",lon:moonLon}];

    drawChart(planets,asc);
    const sunZ=getZodiac(sunLon),moonZ=getZodiac(moonLon),ascZ=getZodiac(asc);
    msg.textContent=`太陽 ${sunLon.toFixed(1)}° (${sunZ})　月亮 ${moonLon.toFixed(1)}° (${moonZ})　上升 ${asc.toFixed(1)}° (${ascZ})`;

    desc.innerHTML=`<b>命盤解讀：</b><br>
    ☉ 太陽位於 <b>${sunZ}</b>，象徵你的核心與自我意識。<br>
    ☾ 月亮位於 <b>${moonZ}</b>，代表你的情緒與內在反應。<br>
    ↑ 上升位於 <b>${ascZ}</b>，呈現你在他人眼中的樣子與生命方向。<br>
    <i>（本命盤採簡化天文模型，誤差±1°，供個人探索使用）</i>`;
  }catch(e){
    console.error(e);msg.textContent="發生錯誤，請再試一次！";
  }
});
</script>
</body>
</html>
