<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸŒŒ Culaliya Mystic Lab | å‘½ç›¤å…¨å±•é–‹ v5.4</title>
<style>
body {
  margin: 0;
  font-family: 'Noto Sans TC', sans-serif;
  background: radial-gradient(circle at 50% 20%, #08061a 0%, #0e0828 70%, #000 100%);
  color: #fff; text-align: center; min-height: 100vh;
}
h1 {
  margin-top: 40px; color: #ffd700;
  text-shadow: 0 0 20px #ffb347, 0 0 40px #ffd700;
}
.container {
  width: min(90%,900px); margin:40px auto; padding:20px;
  background:rgba(20,10,40,0.85);
  border:1px solid rgba(255,215,0,0.3); border-radius:18px;
  box-shadow:0 0 40px rgba(255,215,0,0.2);
  backdrop-filter:blur(8px);
}
input,button {
  width:90%;max-width:400px;padding:12px;border-radius:10px;
  border:1px solid #ffb347;margin:8px 0;font-size:16px;
}
button {
  background:linear-gradient(90deg,#8a2be2,#7b68ee);
  color:#fff;cursor:pointer;transition:.3s;
}
button:hover {transform:scale(1.03);
  background:linear-gradient(90deg,#9b30ff,#8a2be2);}
canvas {
  margin-top:40px;background:#0a0720;border-radius:50%;
  box-shadow:0 0 20px rgba(255,215,0,0.3);cursor:pointer;
}
.tooltip {
  position:absolute;display:none;padding:10px 14px;
  background:rgba(40,20,70,0.9);border:1px solid #ffb347;
  border-radius:8px;color:#fff;font-size:14px;pointer-events:none;
  text-align:left;line-height:1.4;max-width:220px;
  box-shadow:0 0 10px rgba(255,215,0,0.3);
}
.msg {margin-top:10px;color:#ffb347;}
.desc {margin-top:20px;line-height:1.6;color:#fff;font-size:15px;}
</style>
</head>
<body>
<h1>ğŸŒŒ Culaliya Mystic Lab | å‘½ç›¤å…¨å±•é–‹ v5.4</h1>
<div class="container">
  <label>å‡ºç”Ÿæ—¥æœŸ</label><br>
  <input type="date" id="birthDate" value="2000-01-01"><br>
  <label>å‡ºç”Ÿæ™‚é–“</label><br>
  <input type="time" id="birthTime" value="13:01"><br>
  <label>å‡ºç”Ÿåœ°é»ï¼ˆåŸå¸‚ï¼‰</label><br>
  <input type="text" id="birthPlace" placeholder="Taipei"><br>
  <button id="generate">âœ¨ ç”Ÿæˆå‘½ç›¤</button>
  <div id="msg" class="msg"></div>
  <div style="position:relative;display:inline-block;">
    <canvas id="chart" width="500" height="500"></canvas>
    <div id="tooltip" class="tooltip"></div>
  </div>
  <div id="desc" class="desc"></div>
</div>

<script>
// ---- è¨ˆç®—åŸºç¤ ----
function degToRad(d){return d*Math.PI/180;}
function normalize(d){return (d%360+360)%360;}
function calcSunLon(date){
  const Y=date.getUTCFullYear(),M=date.getUTCMonth()+1,D=date.getUTCDate();
  const JD=367*Y-Math.floor(7*(Y+Math.floor((M+9)/12))/4)+Math.floor(275*M/9)+D+1721013.5+date.getUTCHours()/24;
  const n=JD-2451545.0;
  let L=280.46+0.9856474*n;
  const g=357.528+0.9856003*n;
  return normalize(L+1.915*Math.sin(degToRad(g))+0.02*Math.sin(degToRad(2*g)));
}
function calcMoonLon(date){
  const JD=(date.getTime()/86400000)+2440587.5;
  const T=(JD-2451545.0)/36525;
  const L0=218.316+13.176396*T*36525;
  const M=134.963+13.064993*T*36525;
  return normalize(L0+6.289*Math.sin(degToRad(M)));
}
function calcAscendant(date,lat,lon){
  const t=date.getUTCHours()+date.getUTCMinutes()/60;
  const LST=(100.46+0.985647*t*15+lon)%360;
  return normalize(LST+90);
}

const zodiacNames=["â™ˆç™½ç¾Š","â™‰é‡‘ç‰›","â™Šé›™å­","â™‹å·¨èŸ¹","â™Œç…å­","â™è™•å¥³","â™å¤©ç§¤","â™å¤©è ","â™å°„æ‰‹","â™‘æ‘©ç¾¯","â™’æ°´ç“¶","â™“é›™é­š"];
function getZodiac(lon){return zodiacNames[Math.floor(lon/30)];}

// ---- è¡Œæ˜Ÿèªªæ˜åº« ----
const planetInfo={
  "â˜‰å¤ªé™½":"ä»£è¡¨ä½ çš„è‡ªæˆ‘æ„è­˜ã€ç›®æ¨™èˆ‡æ„å¿—ã€‚",
  "â˜¾æœˆäº®":"è±¡å¾µæƒ…ç·’ã€åæ‡‰èˆ‡æ½›æ„è­˜ã€‚",
  "â†‘ä¸Šå‡":"å±•ç¾ä½ åœ¨äººå‰çš„æ¨£è²Œèˆ‡è¡Œå‹•é¢¨æ ¼ã€‚"
};

// ---- ç¹ªåœ– ----
function drawChart(planets,asc){
  const c=document.getElementById("chart"),ctx=c.getContext("2d");
  const r=c.width/2;ctx.clearRect(0,0,c.width,c.height);
  ctx.translate(r,r);
  ctx.beginPath();ctx.arc(0,0,r-10,0,2*Math.PI);
  ctx.strokeStyle="#FFD700";ctx.lineWidth=2;ctx.stroke();

  for(let i=0;i<12;i++){
    const a=degToRad(i*30-asc);
    ctx.beginPath();ctx.moveTo(0,0);
    ctx.lineTo((r-10)*Math.cos(a),(r-10)*Math.sin(a));
    ctx.strokeStyle="rgba(255,215,0,0.3)";ctx.stroke();
  }

  ctx.font="14px Noto Sans TC";ctx.fillStyle="#FFD700";
  for(let i=0;i<12;i++){
    const ang=degToRad((i*30+15)-asc);
    const x=(r-40)*Math.cos(ang),y=(r-40)*Math.sin(ang);
    ctx.fillText(zodiacNames[i],x-15,y+4);
  }

  const axes=[{name:"ASC",angle:0},{name:"MC",angle:90},{name:"DC",angle:180},{name:"IC",angle:270}];
  ctx.fillStyle="#7b68ee";ctx.font="bold 14px Noto Sans TC";
  axes.forEach(ax=>{
    const a=degToRad(ax.angle-asc);
    const x=(r-60)*Math.cos(a),y=(r-60)*Math.sin(a);
    ctx.fillText(ax.name,x-15,y+4);
  });

  ctx.fillStyle="#ffb347";ctx.font="14px Noto Sans TC";
  planets.forEach(p=>{
    const a=degToRad(p.lon-asc);
    const x=(r-80)*Math.cos(a),y=(r-80)*Math.sin(a);
    ctx.beginPath();ctx.arc(x,y,6,0,2*Math.PI);
    ctx.fill();ctx.fillText(p.name,x+8,y+4);
    p._x=x+r;p._y=y+r;p._r=8; // å„²å­˜åº§æ¨™çµ¦ hover
  });
  ctx.setTransform(1,0,0,1,0,0);
}

// ---- Tooltipäº’å‹• ----
const tooltip=document.getElementById("tooltip");
function showTooltip(p,x,y){
  tooltip.style.display="block";
  tooltip.style.left=(x+20)+"px";
  tooltip.style.top=(y-10)+"px";
  tooltip.innerHTML=`
  <b>${p.name}</b><br>
  åº¦æ•¸ï¼š${p.lon.toFixed(1)}Â° (${getZodiac(p.lon)})<br>
  ${planetInfo[p.name]||"é€™é¡†æ˜Ÿä»å¾…è£œå……è§£èªªã€‚"}
  `;
}
function hideTooltip(){tooltip.style.display="none";}

// ---- ä¸»æµç¨‹ ----
document.getElementById("generate").addEventListener("click",async()=>{
  const msg=document.getElementById("msg"),desc=document.getElementById("desc");
  msg.textContent="æ­£åœ¨ç”Ÿæˆå‘½ç›¤...";desc.textContent="";
  try{
    const date=document.getElementById("birthDate").value;
    const time=document.getElementById("birthTime").value;
    const city=document.getElementById("birthPlace").value||"Taipei";
    const dt=new Date(`${date}T${time}:00+08:00`);
    let lat=25.033,lng=121.565;
    if(city.toLowerCase()!=="taipei"){
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
        const j=await r.json();if(j[0]){lat=parseFloat(j[0].lat);lng=parseFloat(j[0].lon);}
      }catch{}
    }

    const sunLon=calcSunLon(dt);
    const moonLon=calcMoonLon(dt);
    const asc=calcAscendant(dt,lat,lng);
    const planets=[{name:"â˜‰å¤ªé™½",lon:sunLon},{name:"â˜¾æœˆäº®",lon:moonLon},{name:"â†‘ä¸Šå‡",lon:asc}];
    drawChart(planets,asc);

    const c=document.getElementById("chart");
    c.onmousemove=e=>{
      const rect=c.getBoundingClientRect();
      const x=e.clientX-rect.left,y=e.clientY-rect.top;
      const found=planets.find(p=>Math.hypot(x-p._x,y-p._y)<p._r+5);
      if(found){showTooltip(found,e.pageX,e.pageY);}
      else hideTooltip();
    };
    c.onmouseleave=hideTooltip;

    const sunZ=getZodiac(sunLon),moonZ=getZodiac(moonLon),ascZ=getZodiac(asc);
    msg.textContent=`å¤ªé™½ ${sunLon.toFixed(1)}Â° (${sunZ})ã€€æœˆäº® ${moonLon.toFixed(1)}Â° (${moonZ})ã€€ä¸Šå‡ ${asc.toFixed(1)}Â° (${ascZ})`;
    desc.innerHTML=`<b>å‘½ç›¤è§£è®€ï¼š</b><br>
    â˜‰ å¤ªé™½ä½æ–¼ <b>${sunZ}</b>ï¼Œè±¡å¾µä½ çš„æ ¸å¿ƒèˆ‡è‡ªæˆ‘æ„è­˜ã€‚<br>
    â˜¾ æœˆäº®ä½æ–¼ <b>${moonZ}</b>ï¼Œä»£è¡¨ä½ çš„æƒ…ç·’èˆ‡å…§åœ¨åæ‡‰ã€‚<br>
    â†‘ ä¸Šå‡ä½æ–¼ <b>${ascZ}</b>ï¼Œå‘ˆç¾ä½ åœ¨ä»–äººçœ¼ä¸­çš„æ¨£å­èˆ‡ç”Ÿå‘½æ–¹å‘ã€‚<br>
    <i>ï¼ˆv5.4ï¼šæ»‘é¼ æ‡¸åœè¡Œæ˜Ÿå¯æŸ¥çœ‹è©³ç´°èªªæ˜ï¼‰</i>`;
  }catch(e){
    console.error(e);msg.textContent="ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼";
  }
});
</script>
</body>
</html>
