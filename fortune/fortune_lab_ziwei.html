<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>🔮 紫微斗數排盤系統 v2.1（深藍金｜規則回權重＋123測邊界）</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg1:#0a1224; --bg2:#0b1630; --bg3:#0a0f1a;
  --gold:#d6b36f; --gold-2:#f0d79b; --cyan:#80d0ff; --accent:#3fa9f5;
  --red:#ef6b6b; --green:#43c184; --violet:#9b7cff;
  --border:rgba(214,179,111,.35); --glow:0 0 22px rgba(214,179,111,.35);
}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Microsoft JhengHei",Inter,system-ui,sans-serif;
  color:#e6ecf2;
  background:
    radial-gradient(1200px 600px at 50% 0%, #0d1a33 0%, #0b1327 40%, #080d17 100%),
    linear-gradient(180deg, #0a1224, #080d17);
  background-attachment:fixed; overflow-x:hidden; padding:20px;
}
a{color:var(--gold)}
#stars{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:screen}
.content{position:relative;z-index:1;max-width:1400px;margin:0 auto}
h1{text-align:center;margin:18px 0 22px;font-size:28px;letter-spacing:.1em;color:var(--gold);text-shadow:0 0 20px rgba(214,179,111,.35)}

.controls{
  display:grid;grid-template-columns:repeat(6,1fr);gap:12px;align-items:end;
  background:linear-gradient(180deg,rgba(13,20,39,.85),rgba(8,13,23,.85));
  border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--glow)
}
.controls .group label{display:block;font-size:12px;color:#a9b6c7;margin:0 0 6px 4px;letter-spacing:.06em}
.controls input,.controls select{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:rgba(12,18,33,.9);color:#e6ecf2;outline:none;
}
.controls input:focus,.controls select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(214,179,111,.15)}
.btn{
  padding:12px 14px;border-radius:12px;border:1px solid var(--border);
  background:linear-gradient(180deg,#182843,#0f1a31);color:var(--gold-2);
  font-weight:600;cursor:pointer;transition:.18s;box-shadow:var(--glow)
}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 28px rgba(214,179,111,.45)}
.btn.primary{background:linear-gradient(180deg,#1b315a,#122340);border-color:#e6c47e;color:#ffeab5}
.btn.ghost{background:transparent}

.rules{
  grid-column:1/-1;display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:4px
}
.switch{
  display:flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--border);
  border-radius:10px;background:linear-gradient(180deg,rgba(16,24,44,.7),rgba(10,16,28,.7));
  font-size:13px;color:#cfe0f1
}
.switch input{accent-color:#e6c47e}

#chartContainer{margin-top:18px;display:none}
.info{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-bottom:14px}
.card{
  background:linear-gradient(180deg,rgba(16,24,44,.9),rgba(10,16,28,.9));
  border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--glow)
}
.card h3{color:var(--gold);font-size:16px;margin-bottom:10px;letter-spacing:.08em}
.card p{color:#d6e0ea;margin:6px 0}

.palace-wrapper{
  display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);
  gap:6px;background:linear-gradient(180deg,rgba(214,179,111,.35),rgba(214,179,111,.12));
  border:1px solid var(--border);border-radius:16px;padding:6px;box-shadow:var(--glow);
  aspect-ratio:1;max-width:1200px;margin:0 auto
}
.palace{
  background:linear-gradient(180deg,rgba(14,20,38,.96),rgba(9,14,25,.96));
  border:1px solid rgba(255,255,255,.065);border-radius:12px;padding:10px;min-height:160px;
  display:flex;flex-direction:column;transition:.18s;position:relative;overflow:hidden
}
.palace:hover{transform:translateY(-2px);border-color:rgba(214,179,111,.55);box-shadow:0 0 22px rgba(214,179,111,.35)}
.header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed rgba(255,255,255,.08);padding-bottom:6px;margin-bottom:8px}
.header .title{font-weight:700;color:var(--gold);letter-spacing:.08em}
.header .branch{color:#8fb7ff;font-weight:600}

.attrs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.attr{font-size:11px;border:1px solid rgba(255,255,255,.08);color:#9bd0ff;padding:2px 6px;border-radius:999px}

.stars{display:flex;gap:6px;flex-wrap:wrap;align-content:flex-start}
.star{padding:3px 8px;border-radius:8px;font-size:12px;font-weight:700;white-space:nowrap;border:1px solid rgba(255,255,255,.1)}
.star.ziwei{background:#6148ff26;border-color:#8f7bff;color:#cabdff}
.star.tianfu{background:#ffb43b1a;border-color:#ffd27a;color:#ffe2a8}
.star.major{background:#1b375f;border-color:#295488;color:#b7d7ff}
.star.helper{background:#0d3a2a;border-color:#1d6a4f;color:#9fe7c7}
.star.unlucky{background:#4a1f25;border-color:#8f3b47;color:#ffc3c8}
.star.lucky{background:#3f2a0e;border-color:#caa86a;color:#ffeab5}

.badge{
  position:absolute;top:6px;left:6px;font-size:11px;display:flex;gap:6px;align-items:center
}
.badge .pill{
  padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:rgba(12,18,33,.85);color:#e6e6e6
}
.badge .score{border-color:#4bb3ff;color:#a9dcff}

.center{
  grid-column:2/4;grid-row:2/4;border:1.2px solid var(--border);display:flex;flex-direction:column;
  align-items:center;justify-content:center;text-align:center
}
.center .name{color:var(--gold-2);font-size:22px;margin-bottom:6px}
.center .row{margin:4px 0;color:#cfdae6}
.center .tag{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;margin:6px 4px;color:var(--gold)}

.elements{margin-top:14px}
.elements-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.elem{
  background:linear-gradient(180deg,rgba(12,18,33,.9),rgba(10,16,28,.9));
  border:1px solid var(--border);border-radius:12px;text-align:center;padding:14px;transition:.2s
}
.elem:hover{transform:translateY(-2px);border-color:rgba(214,179,111,.55)}
.elem strong{display:block;color:var(--gold);font-size:16px;margin-bottom:6px}

.notice{font-size:12px;color:#93a8c4;margin-top:8px}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

@media (max-width:1100px){
  .controls{grid-template-columns:repeat(2,1fr)}
  .rules{grid-template-columns:repeat(2,1fr)}
  .info{grid-template-columns:1fr}
  .palace{min-height:140px}
}
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div class="content">
  <h1>🔮 紫微斗數排盤系統 v2.1（深藍金）</h1>

  <div class="controls">
    <div class="group">
      <label>姓名</label>
      <input id="name" placeholder="請輸入姓名" />
    </div>
    <div class="group">
      <label>性別</label>
      <select id="gender">
        <option value="female">女</option>
        <option value="male">男</option>
      </select>
    </div>
    <div class="group">
      <label>曆法</label>
      <select id="calendar">
        <option value="solar" selected>陽曆（西元）</option>
        <option value="lunar" disabled>農曆（預留）</option>
      </select>
    </div>
    <div class="group">
      <label>生日（陽曆）</label>
      <input type="date" id="birthDate" max="2099-12-31" />
    </div>
    <div class="group">
      <label>出生時辰</label>
      <select id="birthTime">
        <option value="0">子時 (23:00-00:59)</option>
        <option value="1">丑時 (01:00-02:59)</option>
        <option value="2">寅時 (03:00-04:59)</option>
        <option value="3">卯時 (05:00-06:59)</option>
        <option value="4">辰時 (07:00-08:59)</option>
        <option value="5">巳時 (09:00-10:59)</option>
        <option value="6">午時 (11:00-12:59)</option>
        <option value="7">未時 (13:00-14:59)</option>
        <option value="8">申時 (15:00-16:59)</option>
        <option value="9">酉時 (17:00-18:59)</option>
        <option value="10">戌時 (19:00-20:59)</option>
        <option value="11">亥時 (21:00-22:59)</option>
      </select>
    </div>
    <div class="group"><button id="btnGen" class="btn primary">🔮 開始排盤</button></div>
    <div class="group"><button id="btnReset" class="btn ghost">🔁 重置</button></div>
    <div class="group" style="grid-column: span 2;">
      <button id="btnPNG" class="btn">📸 下載命盤 PNG（整體）</button>
      <div class="notice">* 下載會包含上方資訊、十二宮與五行分析。</div>
    </div>

    <!-- 規則開關 -->
    <div class="rules">
      <label class="switch"><input type="checkbox" id="ruleMajor" checked> 主星（紫微系統）</label>
      <label class="switch"><input type="checkbox" id="ruleHelper" checked> 輔星（文昌文曲/左輔右弼/魁鉞）</label>
      <label class="switch"><input type="checkbox" id="ruleUnlucky" checked> 煞星（羊陀火鈴/空劫）</label>
      <label class="switch"><input type="checkbox" id="ruleMinor" checked> 小星（紅鸞天喜/天空等）</label>
      <label class="switch"><input type="checkbox" id="ruleLucun" checked> 祿存（四化基底）</label>
    </div>
    <div class="group" style="grid-column: 1/-1;">
      <div class="notice">鍵盤快速鍵：<b>1</b> 前一時辰、<b>2</b> 還原、<b>3</b> 下一時辰（快速測邊界）。</div>
    </div>
  </div>

  <div id="chartContainer">
    <div class="info">
      <div class="card" id="chartInfo"><h3>命盤資訊</h3></div>
      <div class="card" id="elementsInfo"><h3>五行分析</h3></div>
    </div>
    <div class="palace-wrapper" id="palaceWrapper"></div>
  </div>
</div>

<script>
/* ---------- 星空 ---------- */
const sc=document.getElementById('stars'),sx=sc.getContext('2d');let W,H,SS=[];
function sResize(){W=sc.width=window.innerWidth;H=sc.height=window.innerHeight}
window.addEventListener('resize',sResize);sResize();
for(let i=0;i<200;i++){SS.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+0.4,spd:Math.random()*0.25+0.05,a:Math.random()*0.6+0.25,tw:Math.random()*1000})}
(function drawStars(t=0){
  sx.clearRect(0,0,W,H);
  for(const s of SS){
    const f=0.5+0.5*Math.sin((t+s.tw)/700);
    sx.fillStyle=`rgba(255,255,255,${s.a*f})`;
    sx.beginPath();sx.arc(s.x,s.y,s.r,0,Math.PI*2);sx.fill();
    s.y+=s.spd;if(s.y>H){s.y=0;s.x=Math.random()*W}
  }
  requestAnimationFrame(drawStars)
})();

/* ---------- 命盤算法（含回權重顯示） ---------- */
const EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const PALACE_ORDER=['命宮','兄弟宮','夫妻宮','子女宮','財帛宮','疾厄宮','遷移宮','僕役宮','官祿宮','田宅宮','福德宮','父母宮'];
const WUXING_JU_TABLE=[
  [2,3,3,3,3,4,4,4,4,5,5,5],
  [5,5,2,2,3,3,3,3,4,4,4,4],
  [4,5,5,2,2,3,3,3,3,4,4,4],
  [4,4,5,5,2,2,3,3,3,3,4,4],
  [4,4,4,5,5,2,2,3,3,3,3,4],
  [4,4,4,4,5,5,2,2,3,3,3,3],
  [3,4,4,4,4,5,5,2,2,3,3,3],
  [3,3,4,4,4,4,5,5,2,2,3,3],
  [3,3,3,4,4,4,4,5,5,2,2,3],
  [3,3,3,3,4,4,4,4,5,5,2,2],
  [2,3,3,3,3,4,4,4,4,5,5,5],
  [5,2,3,3,3,3,4,4,4,4,5,5]
];
// 紫微（依局與日）簡化對照
const ZIWEI_POSITION_TABLE=[
  [2,3,4,4,5,5,6,7,8,8,9,9,10,11,0,0,1,1,2,3,4,4,5,5,6,7,8,8,9,9],
  [3,4,4,5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10],
  [4,5,5,6,7,7,8,9,9,10,11,11,0,1,1,2,3,3,4,5,5,6,7,7,8,9,9,10,11,11],
  [5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10,11,0,0],
  [6,7,7,8,9,9,10,11,11,0,1,1,2,3,3,4,5,5,6,7,7,8,9,9,10,11,11,0,1,1]
];

function calculateMingGong(month,time){ // 寅為正月
  let pos=(2+month-1)%12;
  pos=(pos-time+12)%12;   // 生月起逆數到生時
  return pos;
}
function calculateShenGong(month,time){
  let pos=(2+month-1)%12;
  pos=(pos+time)%12;      // 生月起順數到生時
  return pos;
}
function calculateWuxingJu(year,month){
  const yearBranch=(year-4)%12;
  return WUXING_JU_TABLE[yearBranch][month-1]; // 2..6
}

function placeZiweiStars(day,wuxingJu){
  const stars={};
  const juIndex=wuxingJu-2;
  if(juIndex<0||juIndex>4||day<1||day>30) return stars;
  const ziweiPos=ZIWEI_POSITION_TABLE[juIndex][day-1];
  stars['紫微']=ziweiPos;
  stars['天機']=(ziweiPos+1)%12;
  stars['太陽']=(ziweiPos+3)%12;
  stars['武曲']=(ziweiPos+4)%12;
  stars['天同']=(ziweiPos+5)%12;
  stars['廉貞']=(ziweiPos+8)%12;

  const tianfuPos=(ziweiPos+6)%12;
  stars['天府']=tianfuPos;
  stars['太陰']=(tianfuPos+11)%12;
  stars['貪狼']=(tianfuPos+10)%12;
  stars['巨門']=(tianfuPos+9)%12;
  stars['天相']=(tianfuPos+8)%12;
  stars['天梁']=(tianfuPos+7)%12;
  stars['七殺']=(tianfuPos+6)%12;
  stars['破軍']=(tianfuPos+4)%12;
  return stars;
}

/* 輔星（簡化但彼此不重疊，避免與文曲/左輔同式） */
function placeHelperStars(year,month){
  const stars={};
  const yearStem=(year-4)%10;
  // 文昌：戌宮起正月逆數
  stars['文昌']=(10-(month-1)+12)%12;
  // 文曲：巳宮起正月順數（保留）
  stars['文曲']=(4+(month-1))%12;
  // 左輔：子宮起正月順數（避免與文曲同式）
  stars['左輔']=(0+(month-1))%12;
  // 右弼：午宮起正月逆數（避免與文昌同式）
  stars['右弼']=(6-(month-1)+12)%12;

  // 年干魁鉞（常用表）
  const kuiTable=[1,0,11,11,1,0,2,2,1,11];
  const yueTable=[7,8,9,9,7,8,6,6,7,9];
  stars['天魁']=kuiTable[yearStem];
  stars['天鉞']=yueTable[yearStem];
  return stars;
}

/* 煞星 */
function placeUnluckyStars(year,time){
  const stars={};
  const yb=(year-4)%12;
  stars['擎羊']=(yb+1)%12;
  stars['陀羅']=(yb+11)%12;
  const fireTable=[1,0,11,9,8,7,1,0,11,9,8,7];
  const bellTable=[7,6,5,3,2,1,7,6,5,3,2,1];
  stars['火星']=(fireTable[yb]+time)%12;
  stars['鈴星']=(bellTable[yb]+time)%12;
  stars['地空']=(11-time+12)%12;
  stars['地劫']=(11+time)%12;
  return stars;
}

/* 祿存（做為四化基底之一） */
function placeLucun(year){
  const ys=(year-4)%10;
  const lucunTable=[2,3,5,6,5,6,8,9,11,0];
  return {'祿存':lucunTable[ys]};
}

/* 小星群 */
function placeMinorStars(year,month){
  const stars={};
  const yb=(year-4)%12;
  const tianmaTable=[2,11,8,5,2,11,8,5,2,11,8,5];
  stars['天馬']=tianmaTable[yb];
  stars['紅鸞']=(3-yb+12)%12;
  stars['天喜']=(stars['紅鸞']+6)%12;
  stars['天刑']=(9+yb)%12;
  stars['天姚']=(1+yb)%12;
  stars['天巫']=(5+yb)%12;
  stars['天月']=(2+month-1)%12;
  stars['陰煞']=(2-(month-1)+12)%12;
  stars['台輔']=(3+month-1)%12;
  stars['封誥']=(5+month-1)%12;
  stars['龍池']=(4-yb+12)%12;
  stars['鳳閣']=(10+yb-2+12)%12;
  stars['天空']=(11-yb+12)%12;
  const guchenTable=[2,2,5,5,5,8,8,8,11,11,11,2];
  stars['孤辰']=guchenTable[yb];
  stars['寡宿']=(stars['孤辰']+10)%12;
  stars['解神']=(9-(month-1)+12)%12;
  return stars;
}

/* 命主/身主 */
function getLifeMasters(mingBranch){
  const mingzhu=['貪狼','巨門','祿存','文曲','廉貞','武曲','破軍','武曲','廉貞','文曲','祿存','巨門'];
  const shenzhu=['火星','天相','天梁','天同','文昌','天機','火星','天相','天梁','天同','文昌','天機'];
  return {mingzhu:mingzhu[mingBranch],shenzhu:shenzhu[mingBranch]};
}

/* ---------- UI ---------- */
const timeNames=['子時','丑時','寅時','卯時','辰時','巳時','午時','未時','申時','酉時','戌時','亥時'];
const wuxingNames=['','','水二局','木三局','金四局','土五局','火六局'];

let baseInput=null; // 用於 1/2/3 快速鍵回復
function getInputs(){
  const name=document.getElementById('name').value||'未命名';
  const gender=document.getElementById('gender').value;
  const birthDate=document.getElementById('birthDate').value;
  const timeIndex=parseInt(document.getElementById('birthTime').value,10);
  const rules={
    major:document.getElementById('ruleMajor').checked,
    helper:document.getElementById('ruleHelper').checked,
    unlucky:document.getElementById('ruleUnlucky').checked,
    minor:document.getElementById('ruleMinor').checked,
    lucun:document.getElementById('ruleLucun').checked,
  };
  return {name,gender,birthDate,timeIndex,rules};
}

function generateChart(customTimeIndex=null){
  const {name,gender,birthDate,timeIndex,rules}=getInputs();
  if(!birthDate){alert('請選擇生日！');return}
  const d=new Date(birthDate);
  const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
  const t = (customTimeIndex!=null)? customTimeIndex : timeIndex;

  const mingPos=calculateMingGong(m,t);
  const shenPos=calculateShenGong(m,t);
  const wuxingJu=calculateWuxingJu(y,m);

  let allStars={};
  if(rules.major){ Object.assign(allStars, placeZiweiStars(day,wuxingJu)); }
  if(rules.helper){ Object.assign(allStars, placeHelperStars(y,m)); }
  if(rules.unlucky){ Object.assign(allStars, placeUnluckyStars(y,t)); }
  if(rules.lucun){ Object.assign(allStars, placeLucun(y)); }
  if(rules.minor){ Object.assign(allStars, placeMinorStars(y,m)); }

  // 以命宮為起點逆時針建立十二宮
  const palaces=[];
  for(let i=0;i<12;i++){
    const branchIndex=(mingPos+i)%12;
    palaces.push({
      idx:i, // 1~12 顯示用（i+1）
      name:PALACE_ORDER[i],
      branch:EARTHLY_BRANCHES[branchIndex],
      branchIndex,
      isMing:i===0,
      isShen:branchIndex===shenPos,
      stars:[],
      score:0
    });
  }

  // 放星與初步打分（主星+2、天府+2、祿存+1，其餘主星+1，輔星/小星+0.5，煞星-0.5；命/三方四正加成）
  for(const [starName,starPos] of Object.entries(allStars)){
    const p=palaces.find(pp=>pp.branchIndex===starPos);
    if(!p) continue;
    let type='minor', w=0.5;
    if(starName==='紫微'){ type='ziwei'; w=2; }
    else if(starName==='天府'){ type='tianfu'; w=2; }
    else if(['天機','太陽','武曲','天同','廉貞','太陰','貪狼','巨門','天相','天梁','七殺','破軍'].includes(starName)){ type='major'; w=1; }
    else if(['文昌','文曲','左輔','右弼','天魁','天鉞'].includes(starName)){ type='helper'; w=0.7; }
    else if(['擎羊','陀羅','火星','鈴星','地空','地劫'].includes(starName)){ type='unlucky'; w=-0.5; }
    else if(starName==='祿存'){ type='lucky'; w=1; }
    p.stars.push({name:starName,type});
    p.score+=w;
  }

  // 命局加權（+1.5）與三方四正（命/遷移/官祿/財帛 +0.5）
  const baseMap=['水','木','金','土','火']; const base=baseMap[wuxingJu-2];
  const sanfangIdx=[0,6,8,4]; // 命、遷移、官祿、財帛
  palaces.forEach((p, i)=>{
    if(i===0) p.score+=1.5;
    if(sanfangIdx.includes(i)) p.score+=0.5;
  });

  const masters=getLifeMasters(mingPos);
  renderInfo({name,gender,birthDate,timeIndex:t,mingBranch:palaces[0].branch,shenBranch:EARTHLY_BRANCHES[shenPos],wuxingJu,masters});
  renderGrid(palaces,{name,wuxingJu,masters});
  renderElements(palaces,wuxingJu);

  document.getElementById('chartContainer').style.display='block';
  document.getElementById('chartContainer').scrollIntoView({behavior:'smooth',block:'start'});
}

function renderInfo({name,gender,birthDate,timeIndex,mingBranch,shenBranch,wuxingJu,masters}){
  const gText=gender==='male'?'男命':'女命';
  document.getElementById('chartInfo').innerHTML=
    `<h3>命盤資訊</h3>
     <p><strong>${name}</strong>（${gText}）</p>
     <p>陽曆：${birthDate} ${timeNames[timeIndex]}</p>
     <p>命宮：${mingBranch}　身宮：${shenBranch}</p>
     <p>五行局：${wuxingNames[wuxingJu]||'—'}</p>`;
}

function renderGrid(palaces,{name,wuxingJu,masters}){
  const wrapper=document.getElementById('palaceWrapper');
  wrapper.innerHTML='';
  const order=[11,10,9,8, 0,null,null,7, 1,null,null,6, 2,3,4,5];
  order.forEach((idx,pos)=>{
    if(idx===null){
      if(pos===5){
        const c=document.createElement('div');
        c.className='palace center';
        c.innerHTML=
          `<div class="name">${name}</div>
           <div class="row"><span class="tag">命主：${masters.mingzhu}</span> <span class="tag">身主：${masters.shenzhu}</span></div>
           <div class="row"><span class="tag">${wuxingNames[wuxingJu]||''}</span></div>`;
        wrapper.appendChild(c);
      }
      return;
    }
    const p=palaces[idx];
    const box=document.createElement('div');box.className='palace';

    // 序號＋熱度分數角標
    const score = (Math.round(p.score*10)/10).toFixed(1);
    const badge = document.createElement('div');
    badge.className='badge';
    badge.innerHTML=`<span class="pill">#${idx+1}</span><span class="pill score">Score ${score}</span>`;
    box.appendChild(badge);

    const attrs=[];
    if(p.isMing) attrs.push('命');
    if(p.isShen) attrs.push('身');
    const starsHTML=p.stars.length
      ? p.stars.map(s=>`<span class="star ${s.type}">${s.name}</span>`).join('')
      : '<span style="color:#7f8ba0">無主星</span>';

    box.innerHTML +=
      `<div class="header"><span class="title">${p.name}</span><span class="branch">${p.branch}</span></div>
       ${attrs.length?`<div class="attrs">${attrs.map(a=>`<span class="attr">${a}</span>`).join('')}</div>`:''}
       <div class="stars">${starsHTML}</div>`;
    wrapper.appendChild(box);
  });
}

function calculateElementStrength(palaces,wuxingJu){
  const elements={'金':0,'木':0,'水':0,'火':0,'土':0};
  const baseMap=['水','木','金','土','火']; const base=baseMap[wuxingJu-2]; if(base) elements[base]+=3;

  const map={
    '紫微':'土','天機':'木','太陽':'火','武曲':'金','天同':'水','廉貞':'火',
    '天府':'土','太陰':'水','貪狼':'木','巨門':'土','天相':'土','天梁':'木',
    '七殺':'金','破軍':'金','祿存':'土'
  };
  palaces.forEach(p=>{ p.stars.forEach(s=>{ const el=map[s.name]; if(el) elements[el]+=1; }); });
  return elements;
}
function renderElements(palaces,wuxingJu){
  const els=calculateElementStrength(palaces,wuxingJu);
  const maxEl=Object.keys(els).reduce((a,b)=>els[a]>els[b]?a:b);
  const box=document.getElementById('elementsInfo');
  box.innerHTML=
    `<h3>五行分析</h3>
     <div class="elements-grid">
       ${Object.entries(els).map(([k,v])=>`
         <div class="elem">
           <strong>${k}</strong>
           <div>${v} ${k===maxEl?'★':''}</div>
         </div>`).join('')}
     </div>
     <p class="notice">主勢以命局為基底（+3）再疊加主星/祿存五行強度。角標分數為簡易回權重，便於肉眼除錯。</p>`;
}

/* ---------- Buttons & 快捷 ---------- */
function safeToday(){ const dt=new Date(); dt.setHours(0,0,0,0); return dt; }
document.getElementById('birthDate').valueAsDate=safeToday();

document.getElementById('btnGen').addEventListener('click',()=>{
  baseInput=getInputs();
  generateChart();
});
document.getElementById('btnReset').addEventListener('click',()=>{
  document.getElementById('name').value='';
  document.getElementById('gender').value='female';
  document.getElementById('calendar').value='solar';
  document.getElementById('birthDate').valueAsDate=safeToday();
  document.getElementById('birthTime').value='0';
  document.getElementById('ruleMajor').checked=true;
  document.getElementById('ruleHelper').checked=true;
  document.getElementById('ruleUnlucky').checked=true;
  document.getElementById('ruleMinor').checked=true;
  document.getElementById('ruleLucun').checked=true;
  document.getElementById('chartContainer').style.display='none';
});
document.getElementById('btnPNG').addEventListener('click',async ()=>{
  const container=document.querySelector('.content');
  const stars=document.getElementById('stars');stars.style.display='none';
  window.scrollTo(0,0);
  const canvas=await html2canvas(container,{useCORS:true,backgroundColor:'#0a1224',scale:2});
  stars.style.display='block';
  const link=document.createElement('a');
  link.download='紫微斗數命盤.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
});

// 規則切換即時重算
['ruleMajor','ruleHelper','ruleUnlucky','ruleMinor','ruleLucun'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>{
    if(document.getElementById('chartContainer').style.display!=='none') generateChart();
  });
});

// 1/2/3 時支邊界測試
window.addEventListener('keydown',(e)=>{
  if(!baseInput) return;
  if(['1','2','3'].includes(e.key)){
    const t0=parseInt(document.getElementById('birthTime').value,10);
    if(e.key==='1'){ generateChart((t0+11)%12); }
    if(e.key==='2'){ generateChart(t0); }
    if(e.key==='3'){ generateChart((t0+1)%12); }
  }
});
</script>
</body>
</html>
