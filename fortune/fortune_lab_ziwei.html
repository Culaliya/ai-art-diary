<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ğŸ”® ç´«å¾®æ–—æ•¸æ’ç›¤ç³»çµ± v2.0ï¼ˆæ·±è—é‡‘ï¼‰</title>
<!-- html2canvas for PNG download -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg1:#0a1224;
  --bg2:#0b1630;
  --bg3:#0a0f1a;
  --gold:#d6b36f;
  --gold-2:#f0d79b;
  --cyan:#80d0ff;
  --accent:#3fa9f5;
  --red:#ef6b6b;
  --green:#43c184;
  --violet:#9b7cff;
  --border:rgba(214,179,111,.35);
  --glow:0 0 22px rgba(214,179,111,.35);
}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Microsoft JhengHei",Inter,system-ui,sans-serif;
  color:#e6ecf2;
  background:
    radial-gradient(1200px 600px at 50% 0%, #0d1a33 0%, #0b1327 40%, #080d17 100%),
    linear-gradient(180deg, #0a1224, #080d17);
  background-attachment: fixed;
  overflow-x:hidden;
  padding:20px;
}
a{color:var(--gold)}
/* Stars */
#stars{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:screen}
.content{position:relative;z-index:1;max-width:1400px;margin:0 auto}
h1{
  text-align:center;margin:18px 0 22px;font-size:28px;letter-spacing:.1em;
  color:var(--gold);text-shadow:0 0 20px rgba(214,179,111,.35)
}
.controls{
  display:grid;grid-template-columns:repeat(6,1fr);gap:12px;align-items:end;
  background:linear-gradient(180deg,rgba(13,20,39,.85),rgba(8,13,23,.85));
  border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--glow)
}
.controls .group label{display:block;font-size:12px;color:#a9b6c7;margin:0 0 6px 4px;letter-spacing:.06em}
.controls input,.controls select{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:rgba(12,18,33,.9);color:#e6ecf2;outline:none;
}
.controls input:focus,.controls select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(214,179,111,.15)}
.btn{
  padding:12px 14px;border-radius:12px;border:1px solid var(--border);
  background:linear-gradient(180deg,#182843,#0f1a31);color:var(--gold-2);
  font-weight:600;cursor:pointer;transition:.18s;box-shadow:var(--glow)
}
.btn:hover{transform:translateY(-1px);box-shadow:0 0 28px rgba(214,179,111,.45)}
.btn.primary{background:linear-gradient(180deg,#1b315a,#122340);border-color:#e6c47e;color:#ffeab5}
.btn.ghost{background:transparent}
#chartContainer{margin-top:18px;display:none}
.info{
  display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-bottom:14px
}
.card{
  background:linear-gradient(180deg,rgba(16,24,44,.9),rgba(10,16,28,.9));
  border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--glow)
}
.card h3{color:var(--gold);font-size:16px;margin-bottom:10px;letter-spacing:.08em}
.card p{color:#d6e0ea;margin:6px 0}
.palace-wrapper{
  display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);
  gap:6px;background:linear-gradient(180deg,rgba(214,179,111,.35),rgba(214,179,111,.12));
  border:1px solid var(--border);border-radius:16px;padding:6px;box-shadow:var(--glow);
  aspect-ratio:1;max-width:1200px;margin:0 auto
}
.palace{
  background:linear-gradient(180deg,rgba(14,20,38,.96),rgba(9,14,25,.96));
  border:1px solid rgba(255,255,255,.065);border-radius:12px;padding:10px;min-height:160px;
  display:flex;flex-direction:column;transition:.18s;position:relative;overflow:hidden
}
.palace::after{
  content:"";position:absolute;inset:0;background:radial-gradient(300px 120px at 100% 0%, rgba(214,179,111,.12), transparent 60%);
  opacity:0;transition:.25s;pointer-events:none
}
.palace:hover{transform:translateY(-2px);border-color:rgba(214,179,111,.55);box-shadow:0 0 22px rgba(214,179,111,.35)}
.palace:hover::after{opacity:1}
.center{
  grid-column:2/4;grid-row:2/4;border:1.2px solid var(--border);display:flex;flex-direction:column;
  align-items:center;justify-content:center;text-align:center
}
.center .name{color:var(--gold-2);font-size:22px;margin-bottom:6px}
.center .row{margin:4px 0;color:#cfdae6}
.center .tag{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;margin:6px 4px;color:var(--gold)}
.header{
  display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed rgba(255,255,255,.08);
  padding-bottom:6px;margin-bottom:8px
}
.header .title{font-weight:700;color:var(--gold);letter-spacing:.08em}
.header .branch{color:#8fb7ff;font-weight:600}
.attrs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.attr{font-size:11px;border:1px solid rgba(255,255,255,.08);color:#9bd0ff;padding:2px 6px;border-radius:999px}
.stars{display:flex;gap:6px;flex-wrap:wrap;align-content:flex-start}
.star{padding:3px 8px;border-radius:8px;font-size:12px;font-weight:700;white-space:nowrap;border:1px solid rgba(255,255,255,.1)}
.star.ziwei{background:#6148ff26;border-color:#8f7bff;color:#cabdff}
.star.tianfu{background:#ffb43b1a;border-color:#ffd27a;color:#ffe2a8}
.star.major{background:#1b375f;border-color:#295488;color:#b7d7ff}
.star.helper{background:#0d3a2a;border-color:#1d6a4f;color:#9fe7c7}
.star.unlucky{background:#4a1f25;border-color:#8f3b47;color:#ffc3c8}
.star.lucky{background:#3f2a0e;border-color:#caa86a;color:#ffeab5}
.center h2{margin-bottom:8px}
.elements{margin-top:14px}
.elements-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.elem{
  background:linear-gradient(180deg,rgba(12,18,33,.9),rgba(10,16,28,.9));
  border:1px solid var(--border);border-radius:12px;text-align:center;padding:14px;transition:.2s
}
.elem:hover{transform:translateY(-2px);border-color:rgba(214,179,111,.55)}
.elem strong{display:block;color:var(--gold);font-size:16px;margin-bottom:6px}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.notice{font-size:12px;color:#93a8c4;margin-top:8px}
@media (max-width:1100px){
  .controls{grid-template-columns:repeat(2,1fr)}
  .info{grid-template-columns:1fr}
  .palace{min-height:140px}
}
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div class="content">
  <h1>ğŸ”® ç´«å¾®æ–—æ•¸æ’ç›¤ç³»çµ± v2.0ï¼ˆæ·±è—é‡‘ï¼‰</h1>

  <div class="controls">
    <div class="group">
      <label>å§“å</label>
      <input id="name" placeholder="è«‹è¼¸å…¥å§“å" />
    </div>
    <div class="group">
      <label>æ€§åˆ¥</label>
      <select id="gender">
        <option value="female">å¥³</option>
        <option value="male">ç”·</option>
      </select>
    </div>
    <div class="group">
      <label>æ›†æ³•</label>
      <select id="calendar">
        <option value="solar" selected>é™½æ›†ï¼ˆè¥¿å…ƒï¼‰</option>
        <option value="lunar" disabled>è¾²æ›†ï¼ˆé ç•™ï¼‰</option>
      </select>
    </div>
    <div class="group">
      <label>ç”Ÿæ—¥ï¼ˆé™½æ›†ï¼‰</label>
      <input type="date" id="birthDate" max="2099-12-31" />
    </div>
    <div class="group">
      <label>å‡ºç”Ÿæ™‚è¾°</label>
      <select id="birthTime">
        <option value="0">å­æ™‚ (23:00-00:59)</option>
        <option value="1">ä¸‘æ™‚ (01:00-02:59)</option>
        <option value="2">å¯…æ™‚ (03:00-04:59)</option>
        <option value="3">å¯æ™‚ (05:00-06:59)</option>
        <option value="4">è¾°æ™‚ (07:00-08:59)</option>
        <option value="5">å·³æ™‚ (09:00-10:59)</option>
        <option value="6">åˆæ™‚ (11:00-12:59)</option>
        <option value="7">æœªæ™‚ (13:00-14:59)</option>
        <option value="8">ç”³æ™‚ (15:00-16:59)</option>
        <option value="9">é…‰æ™‚ (17:00-18:59)</option>
        <option value="10">æˆŒæ™‚ (19:00-20:59)</option>
        <option value="11">äº¥æ™‚ (21:00-22:59)</option>
      </select>
    </div>
    <div class="group">
      <button id="btnGen" class="btn primary">ğŸ”® é–‹å§‹æ’ç›¤</button>
    </div>
    <div class="group">
      <button id="btnReset" class="btn ghost">ğŸ” é‡ç½®</button>
    </div>
    <div class="group" style="grid-column: span 2;">
      <button id="btnPNG" class="btn">ğŸ“¸ ä¸‹è¼‰å‘½ç›¤ PNGï¼ˆæ•´é«”ï¼‰</button>
      <div class="notice">* ä¸‹è¼‰æœƒåŒ…å«ä¸Šæ–¹è³‡è¨Šã€åäºŒå®®èˆ‡äº”è¡Œåˆ†æã€‚</div>
    </div>
  </div>

  <div id="chartContainer">
    <div class="info">
      <div class="card" id="chartInfo"><h3>å‘½ç›¤è³‡è¨Š</h3></div>
      <div class="card" id="elementsInfo"><h3>äº”è¡Œåˆ†æ</h3></div>
    </div>
    <div class="palace-wrapper" id="palaceWrapper"></div>
  </div>
</div>

<script>
/* ---------- æ˜Ÿç©º ---------- */
const sc=document.getElementById('stars'),sx=sc.getContext('2d');let W,H,SS=[];
function sResize(){W=sc.width=window.innerWidth;H=sc.height=window.innerHeight}
window.addEventListener('resize',sResize);sResize();
for(let i=0;i<200;i++){SS.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.6+0.4,spd:Math.random()*0.25+0.05,a:Math.random()*0.6+0.25,tw:Math.random()*1000})}
function drawStars(t=0){
  sx.clearRect(0,0,W,H);
  for(const s of SS){
    const f=0.5+0.5*Math.sin((t+s.tw)/700);
    sx.fillStyle=`rgba(255,255,255,${s.a*f})`;
    sx.beginPath();sx.arc(s.x,s.y,s.r,0,Math.PI*2);sx.fill();
    s.y+=s.spd;if(s.y>H){s.y=0;s.x=Math.random()*W}
  }
  requestAnimationFrame(drawStars)
}
drawStars();

/* ---------- å‘½ç›¤ç®—æ³•ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---------- */
const EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
// é€†æ™‚é‡å®®ä½ï¼šå‘½â†’å…„å¼Ÿâ†’å¤«å¦»â†’å­å¥³â†’è²¡å¸›â†’ç–¾å„â†’é·ç§»â†’åƒ•å½¹â†’å®˜ç¥¿â†’ç”°å®…â†’ç¦å¾·â†’çˆ¶æ¯
const PALACE_ORDER=['å‘½å®®','å…„å¼Ÿå®®','å¤«å¦»å®®','å­å¥³å®®','è²¡å¸›å®®','ç–¾å„å®®','é·ç§»å®®','åƒ•å½¹å®®','å®˜ç¥¿å®®','ç”°å®…å®®','ç¦å¾·å®®','çˆ¶æ¯å®®'];
// äº”è¡Œå±€è¡¨ï¼ˆå¹´æ”¯ Ã— æœˆï¼‰â€” ç°¡åŒ–ç©©å®šç‰ˆ
const WUXING_JU_TABLE=[
  [2,3,3,3,3,4,4,4,4,5,5,5], // å­
  [5,5,2,2,3,3,3,3,4,4,4,4], // ä¸‘
  [4,5,5,2,2,3,3,3,3,4,4,4], // å¯…
  [4,4,5,5,2,2,3,3,3,3,4,4], // å¯
  [4,4,4,5,5,2,2,3,3,3,3,4], // è¾°
  [4,4,4,4,5,5,2,2,3,3,3,3], // å·³
  [3,4,4,4,4,5,5,2,2,3,3,3], // åˆ
  [3,3,4,4,4,4,5,5,2,2,3,3], // æœª
  [3,3,3,4,4,4,4,5,5,2,2,3], // ç”³
  [3,3,3,3,4,4,4,4,5,5,2,2], // é…‰
  [2,3,3,3,3,4,4,4,4,5,5,5], // æˆŒ
  [5,2,3,3,3,3,4,4,4,4,5,5]  // äº¥
];
// ç´«å¾®ä½ç½®ï¼ˆä¾äº”è¡Œå±€èˆ‡æ—¥æ•¸ï¼‰â€” å¸¸ç”¨å°ç…§è¡¨ï¼ˆç°¡åŒ–ä½†ä¸€è‡´æ€§é«˜ï¼‰
const ZIWEI_POSITION_TABLE=[
  [2,3,4,4,5,5,6,7,8,8,9,9,10,11,0,0,1,1,2,3,4,4,5,5,6,7,8,8,9,9], // æ°´äºŒ
  [3,4,4,5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10], // æœ¨ä¸‰
  [4,5,5,6,7,7,8,9,9,10,11,11,0,1,1,2,3,3,4,5,5,6,7,7,8,9,9,10,11,11], // é‡‘å››
  [5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10,11,0,0], // åœŸäº”
  [6,7,7,8,9,9,10,11,11,0,1,1,2,3,3,4,5,5,6,7,7,8,9,9,10,11,11,0,1,1]  // ç«å…­
];

function calculateMingGong(month,time){ // å¯…ç‚ºæ­£æœˆ
  let pos=(2+month-1)%12; // ç”Ÿæœˆæ‰€åœ¨å®®
  pos=(pos-time+12)%12;   // å¾ç”Ÿæœˆèµ·å­æ™‚é€†æ•¸åˆ°ç”Ÿæ™‚
  return pos;
}
function calculateShenGong(month,time){
  let pos=(2+month-1)%12;
  pos=(pos+time)%12;      // å¾ç”Ÿæœˆèµ·å­æ™‚é †æ•¸åˆ°ç”Ÿæ™‚
  return pos;
}
function calculateWuxingJu(year,month){
  const yearBranch=(year-4)%12; // ç”²å­å¹´ = 4 (è¥¿å…ƒ) å°é½Š
  return WUXING_JU_TABLE[yearBranch][month-1]; // 2..6
}
function placeZiweiStars(day,wuxingJu){
  const stars={};
  const juIndex=wuxingJu-2;
  if(juIndex<0||juIndex>4||day<1||day>30) return stars;
  const ziweiPos=ZIWEI_POSITION_TABLE[juIndex][day-1];
  stars['ç´«å¾®']=ziweiPos;
  stars['å¤©æ©Ÿ']=(ziweiPos+1)%12;
  stars['å¤ªé™½']=(ziweiPos+3)%12;
  stars['æ­¦æ›²']=(ziweiPos+4)%12;
  stars['å¤©åŒ']=(ziweiPos+5)%12;
  stars['å»‰è²']=(ziweiPos+8)%12;
  const tianfuPos=(ziweiPos+6)%12;
  stars['å¤©åºœ']=tianfuPos;
  stars['å¤ªé™°']=(tianfuPos+11)%12;
  stars['è²ªç‹¼']=(tianfuPos+10)%12;
  stars['å·¨é–€']=(tianfuPos+9)%12;
  stars['å¤©ç›¸']=(tianfuPos+8)%12;
  stars['å¤©æ¢']=(tianfuPos+7)%12;
  stars['ä¸ƒæ®º']=(tianfuPos+6)%12;
  stars['ç ´è»']=(tianfuPos+4)%12;
  return stars;
}
function placeHelperStars(year,month){
  const stars={};
  const yearStem=(year-4)%10;
  // æ–‡æ˜Œï¼šæˆŒå®®èµ·æ­£æœˆé€†æ•¸
  stars['æ–‡æ˜Œ']=(10-(month-1)+12)%12;
  // æ–‡æ›²ï¼šå·³å®®èµ·æ­£æœˆé †æ•¸
  stars['æ–‡æ›²']=(4+(month-1))%12;
  // å·¦è¼”ï¼šè¾°å®®èµ·æ­£æœˆé †æ•¸
  stars['å·¦è¼”']=(4+(month-1))%12;
  // å³å¼¼ï¼šæˆŒå®®èµ·æ­£æœˆé€†æ•¸
  stars['å³å¼¼']=(10-(month-1)+12)%12;
  const kuiTable=[1,0,11,11,1,0,2,2,1,11];
  const yueTable=[7,8,9,9,7,8,6,6,7,9];
  stars['å¤©é­']=kuiTable[yearStem];
  stars['å¤©é‰']=yueTable[yearStem];
  return stars;
}
function placeUnluckyStars(year,time){
  const stars={};
  const yb=(year-4)%12;
  stars['æ“ç¾Š']=(yb+1)%12;
  stars['é™€ç¾…']=(yb+11)%12;
  const fireTable=[1,0,11,9,8,7,1,0,11,9,8,7];
  const bellTable=[7,6,5,3,2,1,7,6,5,3,2,1];
  stars['ç«æ˜Ÿ']=(fireTable[yb]+time)%12;
  stars['éˆ´æ˜Ÿ']=(bellTable[yb]+time)%12;
  stars['åœ°ç©º']=(11-time+12)%12;
  stars['åœ°åŠ«']=(11+time)%12;
  return stars;
}
function placeLucun(year){
  const ys=(year-4)%10;
  const lucunTable=[2,3,5,6,5,6,8,9,11,0];
  return {'ç¥¿å­˜':lucunTable[ys]};
}
function placeMinorStars(year,month){
  const stars={};
  const yb=(year-4)%12;
  const tianmaTable=[2,11,8,5,2,11,8,5,2,11,8,5];
  stars['å¤©é¦¬']=tianmaTable[yb];
  stars['ç´…é¸']=(3-yb+12)%12;
  stars['å¤©å–œ']=(stars['ç´…é¸']+6)%12;
  stars['å¤©åˆ‘']=(9+yb)%12;
  stars['å¤©å§š']=(1+yb)%12;
  stars['å¤©å·«']=(5+yb)%12;
  stars['å¤©æœˆ']=(2+month-1)%12;
  stars['é™°ç…']=(2-(month-1)+12)%12;
  stars['å°è¼”']=(3+month-1)%12;
  stars['å°èª¥']=(5+month-1)%12;
  stars['é¾æ± ']=(4-yb+12)%12;
  stars['é³³é–£']=(10+yb-2+12)%12;
  stars['å¤©ç©º']=(11-yb+12)%12;
  const guchenTable=[2,2,5,5,5,8,8,8,11,11,11,2];
  stars['å­¤è¾°']=guchenTable[yb];
  stars['å¯¡å®¿']=(stars['å­¤è¾°']+10)%12;
  stars['è§£ç¥']=(9-(month-1)+12)%12;
  return stars;
}
function getLifeMasters(mingBranch){
  const mingzhu=['è²ªç‹¼','å·¨é–€','ç¥¿å­˜','æ–‡æ›²','å»‰è²','æ­¦æ›²','ç ´è»','æ­¦æ›²','å»‰è²','æ–‡æ›²','ç¥¿å­˜','å·¨é–€'];
  const shenzhu=['ç«æ˜Ÿ','å¤©ç›¸','å¤©æ¢','å¤©åŒ','æ–‡æ˜Œ','å¤©æ©Ÿ','ç«æ˜Ÿ','å¤©ç›¸','å¤©æ¢','å¤©åŒ','æ–‡æ˜Œ','å¤©æ©Ÿ'];
  return {mingzhu:mingzhu[mingBranch],shenzhu:shenzhu[mingBranch]};
}

/* ---------- UI & Render ---------- */
const timeNames=['å­æ™‚','ä¸‘æ™‚','å¯…æ™‚','å¯æ™‚','è¾°æ™‚','å·³æ™‚','åˆæ™‚','æœªæ™‚','ç”³æ™‚','é…‰æ™‚','æˆŒæ™‚','äº¥æ™‚'];
const wuxingNames=['','','æ°´äºŒå±€','æœ¨ä¸‰å±€','é‡‘å››å±€','åœŸäº”å±€','ç«å…­å±€'];

function generateChart(){
  const name=document.getElementById('name').value||'æœªå‘½å';
  const gender=document.getElementById('gender').value;
  const birthDate=document.getElementById('birthDate').value;
  const timeIndex=parseInt(document.getElementById('birthTime').value,10);
  if(!birthDate){alert('è«‹é¸æ“‡ç”Ÿæ—¥ï¼');return}
  const d=new Date(birthDate);
  const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();

  const mingPos=calculateMingGong(m,timeIndex);
  const shenPos=calculateShenGong(m,timeIndex);
  const wuxingJu=calculateWuxingJu(y,m);

  const major=placeZiweiStars(day,wuxingJu);
  const helper=placeHelperStars(y,m);
  const unlucky=placeUnluckyStars(y,timeIndex);
  const lucun=placeLucun(y);
  const minor=placeMinorStars(y,m);
  const allStars={...major,...helper,...unlucky,...lucun,...minor};

  // ä»¥å‘½å®®ç‚ºèµ·é»é€†æ™‚é‡å»ºç«‹åäºŒå®®
  const palaces=[];
  for(let i=0;i<12;i++){
    const branchIndex=(mingPos+i)%12;
    palaces.push({
      name:PALACE_ORDER[i],
      branch:EARTHLY_BRANCHES[branchIndex],
      branchIndex,
      isMing:i===0,
      isShen:branchIndex===shenPos,
      stars:[]
    });
  }
  // æ”¾æ˜Ÿ
  for(const [starName,starPos] of Object.entries(allStars)){
    const p=palaces.find(pp=>pp.branchIndex===starPos);
    if(!p) continue;
    let type='minor';
    if(starName==='ç´«å¾®') type='ziwei';
    else if(starName==='å¤©åºœ') type='tianfu';
    else if(['å¤©æ©Ÿ','å¤ªé™½','æ­¦æ›²','å¤©åŒ','å»‰è²','å¤ªé™°','è²ªç‹¼','å·¨é–€','å¤©ç›¸','å¤©æ¢','ä¸ƒæ®º','ç ´è»'].includes(starName)) type='major';
    else if(['æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼','å¤©é­','å¤©é‰'].includes(starName)) type='helper';
    else if(['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ','åœ°ç©º','åœ°åŠ«'].includes(starName)) type='unlucky';
    else if(starName==='ç¥¿å­˜') type='lucky';
    p.stars.push({name:starName,type});
  }

  const masters=getLifeMasters(mingPos);
  renderInfo({name,gender,birthDate,timeIndex,mingBranch:palaces[0].branch,shenBranch:EARTHLY_BRANCHES[shenPos],wuxingJu,masters});
  renderGrid(palaces,{name,wuxingJu,masters});
  renderElements(palaces,wuxingJu);

  document.getElementById('chartContainer').style.display='block';
  document.getElementById('chartContainer').scrollIntoView({behavior:'smooth',block:'start'});
}

function renderInfo({name,gender,birthDate,timeIndex,mingBranch,shenBranch,wuxingJu,masters}){
  const gText=gender==='male'?'ç”·å‘½':'å¥³å‘½';
  document.getElementById('chartInfo').innerHTML=
    `<h3>å‘½ç›¤è³‡è¨Š</h3>
     <p><strong>${name}</strong>ï¼ˆ${gText}ï¼‰</p>
     <p>é™½æ›†ï¼š${birthDate} ${timeNames[timeIndex]}</p>
     <p>å‘½å®®ï¼š${mingBranch}ã€€èº«å®®ï¼š${shenBranch}</p>
     <p>äº”è¡Œå±€ï¼š${wuxingNames[wuxingJu]||'â€”'}</p>`;
}

function renderGrid(palaces,{name,wuxingJu,masters}){
  const wrapper=document.getElementById('palaceWrapper');
  wrapper.innerHTML='';
  // 4x4 æ”¾ç½®ï¼ˆ12å®® + ä¸­å¤®ï¼‰
  const order=[11,10,9,8, 0,null,null,7, 1,null,null,6, 2,3,4,5];
  order.forEach((idx,pos)=>{
    if(idx===null){
      if(pos===5){
        const c=document.createElement('div');
        c.className='palace center';
        c.innerHTML=
          `<div class="name">${name}</div>
           <div class="row"><span class="tag">å‘½ä¸»ï¼š${masters.mingzhu}</span> <span class="tag">èº«ä¸»ï¼š${masters.shenzhu}</span></div>
           <div class="row"><span class="tag">${wuxingNames[wuxingJu]||''}</span></div>`;
        wrapper.appendChild(c);
      }
      return;
    }
    const p=palaces[idx];
    const box=document.createElement('div');box.className='palace';
    const attrs=[];
    if(p.isMing) attrs.push('å‘½');
    if(p.isShen) attrs.push('èº«');
    const starsHTML=p.stars.map(s=>`<span class="star ${s.type}">${s.name}</span>`).join('');
    box.innerHTML=
      `<div class="header"><span class="title">${p.name}</span><span class="branch">${p.branch}</span></div>
       ${attrs.length?`<div class="attrs">${attrs.map(a=>`<span class="attr">${a}</span>`).join('')}</div>`:''}
       <div class="stars">${starsHTML || '<span style="color:#7f8ba0">ç„¡ä¸»æ˜Ÿ</span>'}</div>`;
    wrapper.appendChild(box);
  });
}

function calculateElementStrength(palaces,wuxingJu){
  const elements={'é‡‘':0,'æœ¨':0,'æ°´':0,'ç«':0,'åœŸ':0};
  const baseMap=['æ°´','æœ¨','é‡‘','åœŸ','ç«']; // 2..6
  const base=baseMap[wuxingJu-2]; if(base) elements[base]+=3; // å‘½å±€åŠ æ¬Š

  // ä¸»æ˜Ÿäº”è¡Œæ˜ å°„ï¼ˆå¸¸ç”¨ï¼‰
  const map={
    'ç´«å¾®':'åœŸ','å¤©æ©Ÿ':'æœ¨','å¤ªé™½':'ç«','æ­¦æ›²':'é‡‘','å¤©åŒ':'æ°´','å»‰è²':'ç«',
    'å¤©åºœ':'åœŸ','å¤ªé™°':'æ°´','è²ªç‹¼':'æœ¨','å·¨é–€':'åœŸ','å¤©ç›¸':'åœŸ','å¤©æ¢':'æœ¨',
    'ä¸ƒæ®º':'é‡‘','ç ´è»':'é‡‘'
  };
  palaces.forEach(p=>{
    p.stars.forEach(s=>{
      const el=map[s.name]; if(el) elements[el]+=1;
    });
  });
  return elements;
}
function renderElements(palaces,wuxingJu){
  const els=calculateElementStrength(palaces,wuxingJu);
  const maxEl=Object.keys(els).reduce((a,b)=>els[a]>els[b]?a:b);
  const box=document.getElementById('elementsInfo');
  box.innerHTML=
    `<h3>äº”è¡Œåˆ†æ</h3>
     <div class="elements-grid">
       ${Object.entries(els).map(([k,v])=>`
         <div class="elem">
           <strong>${k}</strong>
           <div>${v} ${k===maxEl?'â˜…':''}</div>
         </div>`).join('')}
     </div>
     <p class="notice">ä¸»å‹¢ä»¥å‘½å±€ç‚ºåŸºåº•ï¼ˆ+3ï¼‰å†ç–ŠåŠ ä¸»æ˜Ÿäº”è¡Œå¼·åº¦ã€‚</p>`;
}

/* ---------- Buttons ---------- */
document.getElementById('btnGen').addEventListener('click',generateChart);
document.getElementById('btnReset').addEventListener('click',()=>{
  document.getElementById('name').value='';
  document.getElementById('gender').value='female';
  document.getElementById('calendar').value='solar';
  document.getElementById('birthDate').valueAsDate=new Date();
  document.getElementById('birthTime').value='0';
  document.getElementById('chartContainer').style.display='none';
});
document.getElementById('btnPNG').addEventListener('click',async ()=>{
  const container=document.querySelector('.content');
  // æš«æ™‚é—œé–‰æ˜Ÿç©ºå‹•ç•«ä»¥å…æ‹–å°¾
  const stars=document.getElementById('stars');stars.style.display='none';
  window.scrollTo(0,0);
  const canvas=await html2canvas(container,{useCORS:true,backgroundColor:'#0a1224',scale:2});
  stars.style.display='block';
  const link=document.createElement('a');
  link.download='ç´«å¾®æ–—æ•¸å‘½ç›¤.png';
  link.href=canvas.toDataURL('image/png');
  link.click();
});

/* ---------- Defaults ---------- */
document.getElementById('birthDate').valueAsDate=new Date();
</script>
</body>
</html>
