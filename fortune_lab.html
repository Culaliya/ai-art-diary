<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ”® ç´«å¾®æ–—æ•¸æ’ç›¤ç³»çµ±</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
  background: radial-gradient(circle at 50% 20%, #0b0610 0%, #090214 70%, #000 100%);
  color: #0ff;
  min-height: 100vh;
  padding: 20px;
  position: relative;
  overflow-x: hidden;
}
canvas#stars {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
}
h1 {
  text-align: center;
  font-size: 2.5em;
  margin: 30px 0;
  color: #0ff;
  text-shadow: 0 0 25px #ff3eff, 0 0 45px #0ff;
  animation: glowPulse 3s infinite alternate;
}
@keyframes glowPulse {
  from { text-shadow: 0 0 15px #0ff; }
  to { text-shadow: 0 0 35px #ff3eff, 0 0 60px #0ff; }
}
.input-section {
  max-width: 500px;
  margin: 0 auto 40px;
  background: rgba(255,255,255,0.05);
  border: 2px solid #0ff;
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 0 25px rgba(0,255,255,0.5);
}
.input-group {
  margin-bottom: 20px;
}
label {
  display: block;
  margin-bottom: 8px;
  color: #aaf;
  font-size: 1.1em;
}
input, select {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #0ff;
  background: rgba(0,0,0,0.6);
  color: #0ff;
  font-size: 1em;
  font-family: inherit;
}
.time-select {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #0ff;
  background: rgba(0,0,0,0.6);
  color: #0ff;
  font-size: 1em;
}
button {
  width: 100%;
  margin-top: 20px;
  padding: 15px;
  border: 2px solid #ff3eff;
  border-radius: 10px;
  background: linear-gradient(135deg, #0ff, #ff3eff);
  color: #000;
  font-weight: bold;
  font-size: 1.2em;
  cursor: pointer;
  box-shadow: 0 0 15px #ff3eff;
  transition: transform 0.3s;
}
button:hover {
  transform: scale(1.05);
}
.chart-container {
  max-width: 1400px;
  margin: 0 auto;
  display: none;
}
.chart-info {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  border: 1px solid #0ff;
}
.chart-info h3 {
  color: #ff3eff;
  margin-bottom: 15px;
  font-size: 1.5em;
}
.chart-info p {
  color: #aaf;
  margin: 8px 0;
  font-size: 1.1em;
}
.palace-wrapper {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 3px;
  background: #0ff;
  border: 4px solid #0ff;
  box-shadow: 0 0 30px rgba(0,255,255,0.6);
  max-width: 1200px;
  margin: 0 auto;
  aspect-ratio: 1;
}
.palace {
  background: rgba(10,5,20,0.95);
  padding: 12px;
  position: relative;
  border: 1px solid rgba(0,255,255,0.3);
  display: flex;
  flex-direction: column;
  min-height: 180px;
}
.center-info {
  background: rgba(10,5,30,0.98);
  grid-column: 2 / 4;
  grid-row: 2 / 4;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 2px solid #ff3eff;
  padding: 20px;
}
.center-info h2 {
  color: #ff3eff;
  font-size: 2em;
  margin-bottom: 15px;
  text-shadow: 0 0 15px #ff3eff;
}
.center-info .main-palace {
  color: #0ff;
  font-size: 1.5em;
  margin: 10px 0;
}
.center-info .life-master {
  color: #ffb74d;
  font-size: 1.2em;
  margin: 5px 0;
}
.palace-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #ff3eff;
}
.palace-name {
  font-size: 1.2em;
  font-weight: bold;
  color: #ff3eff;
  text-shadow: 0 0 10px #ff3eff;
}
.palace-branch {
  font-size: 1em;
  color: #0ff;
  font-weight: bold;
}
.palace-attrs {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}
.attr-tag {
  font-size: 0.75em;
  padding: 2px 6px;
  border-radius: 4px;
  background: rgba(0,0,0,0.4);
  color: #aaf;
  border: 1px solid rgba(0,255,255,0.3);
}
.stars-container {
  flex: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  align-content: flex-start;
}
.star {
  padding: 3px 7px;
  border-radius: 5px;
  font-size: 0.8em;
  font-weight: 500;
  white-space: nowrap;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.star-ziwei { background: #8b5cf6; color: #fff; border: 1px solid #a78bfa; }
.star-tianfu { background: #ec4899; color: #fff; border: 1px solid #f472b6; }
.star-major { background: #ff3eff; color: #fff; border: 1px solid #ff6bff; }
.star-lucky { background: #10b981; color: #fff; border: 1px solid #34d399; }
.star-unlucky { background: #ef4444; color: #fff; border: 1px solid #f87171; }
.star-helper { background: rgba(0,255,255,0.25); color: #0ff; border: 1px solid #0ff; }
.star-minor { background: rgba(255,183,77,0.2); color: #ffb74d; border: 1px solid #ffb74d; }
.elements-info {
  margin-top: 30px;
  padding: 25px;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  border: 1px solid #0ff;
}
.elements-info h3 {
  color: #ff3eff;
  margin-bottom: 20px;
  font-size: 1.5em;
  text-align: center;
}
.elements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
}
.element-item {
  padding: 15px;
  background: rgba(0,0,0,0.4);
  border-radius: 8px;
  border: 1px solid #0ff;
  text-align: center;
}
.element-item strong {
  color: #ff3eff;
  font-size: 1.3em;
}
@media (max-width: 1024px) {
  .palace {
    min-height: 140px;
    padding: 8px;
  }
  .palace-name {
    font-size: 1em;
  }
  .star {
    font-size: 0.7em;
    padding: 2px 5px;
  }
  .center-info h2 {
    font-size: 1.5em;
  }
}
</style>
</head>
<body>
<canvas id="stars"></canvas>

<h1>ğŸ”® ç´«å¾®æ–—æ•¸æ’ç›¤ç³»çµ±</h1>

<div class="input-section">
  <div class="input-group">
    <label>å§“åï¼š</label>
    <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å">
  </div>
  
  <div class="input-group">
    <label>æ€§åˆ¥ï¼š</label>
    <select id="gender">
      <option value="male">ç”·</option>
      <option value="female">å¥³</option>
    </select>
  </div>
  
  <div class="input-group">
    <label>é™½æ›†ç”Ÿæ—¥ï¼š</label>
    <input type="date" id="birthDate" max="2025-12-31">
  </div>
  
  <div class="input-group">
    <label>å‡ºç”Ÿæ™‚è¾°ï¼š</label>
    <select id="birthTime" class="time-select">
      <option value="0">å­æ™‚ (23:00-00:59)</option>
      <option value="1">ä¸‘æ™‚ (01:00-02:59)</option>
      <option value="2">å¯…æ™‚ (03:00-04:59)</option>
      <option value="3">å¯æ™‚ (05:00-06:59)</option>
      <option value="4">è¾°æ™‚ (07:00-08:59)</option>
      <option value="5">å·³æ™‚ (09:00-10:59)</option>
      <option value="6">åˆæ™‚ (11:00-12:59)</option>
      <option value="7">æœªæ™‚ (13:00-14:59)</option>
      <option value="8">ç”³æ™‚ (15:00-16:59)</option>
      <option value="9">é…‰æ™‚ (17:00-18:59)</option>
      <option value="10">æˆŒæ™‚ (19:00-20:59)</option>
      <option value="11">äº¥æ™‚ (21:00-22:59)</option>
    </select>
  </div>
  
  <button onclick="generateChart()">ğŸ”® é–‹å§‹æ’ç›¤</button>
</div>

<div class="chart-container" id="chartContainer">
  <div class="chart-info" id="chartInfo"></div>
  <div class="palace-wrapper" id="palaceWrapper"></div>
  <div class="elements-info" id="elementsInfo"></div>
</div>

<script>
// æ˜Ÿç©ºèƒŒæ™¯
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let w, h, stars = [];
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();
for (let i = 0; i < 120; i++) {
  stars.push({
    x: Math.random() * w,
    y: Math.random() * h,
    size: Math.random() * 1.8,
    speed: Math.random() * 0.4 + 0.1
  });
}
function drawStars() {
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#0ff';
  for (const s of stars) {
    ctx.globalAlpha = Math.random() * 0.7 + 0.3;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
    ctx.fill();
    s.y += s.speed;
    if (s.y > h) s.y = 0;
  }
  requestAnimationFrame(drawStars);
}
drawStars();

// ========== ç´«å¾®æ–—æ•¸æ ¸å¿ƒæ¼”ç®—æ³• ==========
const EARTHLY_BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
const HEAVENLY_STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
const PALACE_NAMES = ['å‘½å®®', 'çˆ¶æ¯å®®', 'ç¦å¾·å®®', 'ç”°å®…å®®', 'å®˜ç¥¿å®®', 'åƒ•å½¹å®®', 
                      'é·ç§»å®®', 'ç–¾å„å®®', 'è²¡å¸›å®®', 'å­å¥³å®®', 'å¤«å¦»å®®', 'å…„å¼Ÿå®®'];

// ç´«å¾®æ˜Ÿç³»å®‰æ˜Ÿè¡¨ï¼ˆä»¥è¾²æ›†ç”Ÿæ—¥ç‚ºæº–ï¼‰
const ZIWEI_TABLE = {
  // ç´«å¾®æ˜Ÿä½ç½®è¡¨ï¼ˆä¾äº”è¡Œå±€æ•¸å’Œç”Ÿæ—¥ï¼‰
  positions: [
    [2,3,4,4,5,5,6,7,8,8,9,9,10,11,0,0,1,1,2,3,4,4,5,5,6,7,8,8,9,9],  // äºŒå±€
    [3,4,4,5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10], // ä¸‰å±€
    [4,5,5,6,7,7,8,9,9,10,11,11,0,1,1,2,3,3,4,5,5,6,7,7,8,9,9,10,11,11], // å››å±€
    [5,6,6,7,8,8,9,10,10,11,0,0,1,2,2,3,4,4,5,6,6,7,8,8,9,10,10,11,0,0], // äº”å±€
  ]
};

// å¤©åºœæ˜Ÿç³»ï¼ˆé€†æ™‚é‡æ¨ç®—ï¼‰
const TIANFU_OFFSET = 0; // å¤©åºœæ°¸é èˆ‡ç´«å¾®ç›¸å°

// åå››ä¸»æ˜Ÿèˆ‡ç´«å¾®é—œä¿‚ä½ç½®
const MAJOR_STARS_OFFSET = {
  'ç´«å¾®': 0,
  'å¤©æ©Ÿ': 1,  // ç´«å¾®é †è¡Œä¸€ä½
  'å¤ªé™½': 3,  // ç´«å¾®é †è¡Œä¸‰ä½
  'æ­¦æ›²': 4,  // ç´«å¾®é †è¡Œå››ä½
  'å¤©åŒ': 5,  // ç´«å¾®é †è¡Œäº”ä½
  'å»‰è²': 8,  // ç´«å¾®é †è¡Œå…«ä½
  'å¤©åºœ': 0,  // èˆ‡ç´«å¾®å°å®®
  'å¤ªé™°': -1, // å¤©åºœé€†è¡Œä¸€ä½
  'è²ªç‹¼': -2, // å¤©åºœé€†è¡ŒäºŒä½
  'å·¨é–€': -3, // å¤©åºœé€†è¡Œä¸‰ä½
  'å¤©ç›¸': -4, // å¤©åºœé€†è¡Œå››ä½
  'å¤©æ¢': -5, // å¤©åºœé€†è¡Œäº”ä½
  'ä¸ƒæ®º': -6, // å¤©åºœé€†è¡Œå…­ä½
  'ç ´è»': -8  // å¤©åºœé€†è¡Œå…«ä½
};

// å…­å‰æ˜Ÿå®‰æ˜Ÿæ³•
const HELPER_STARS_RULES = {
  'æ–‡æ˜Œ': (year, month) => (10 - month) % 12,  // å¾æˆŒå®«èµ·æ­£æœˆé€†æ¨
  'æ–‡æ›²': (year, month) => (4 + month) % 12,   // å¾å·³å®«èµ·æ­£æœˆé †æ¨
  'å·¦è¼”': (year, month) => (month - 1) % 12,   // å¾è¾°å®«èµ·æ­£æœˆé †æ¨
  'å³å¼¼': (year, month) => (10 - month) % 12,  // å¾æˆŒå®«èµ·æ­£æœˆé€†æ¨
  'å¤©é­': (year) => {  // ä¾å¹´å¹²
    const kui = ['ä¸‘','å­','äº¥','äº¥','ä¸‘','å­','å¯…','å¯…','ä¸‘','äº¥'];
    return EARTHLY_BRANCHES.indexOf(kui[year % 10]);
  },
  'å¤©é‰': (year) => {  // ä¾å¹´å¹²
    const yue = ['æœª','ç”³','é…‰','é…‰','æœª','ç”³','åˆ','åˆ','æœª','é…‰'];
    return EARTHLY_BRANCHES.indexOf(yue[year % 10]);
  }
};

// å…­ç…æ˜Ÿ
const UNLUCKY_STARS_RULES = {
  'æ“ç¾Š': (year) => (year + 1) % 12,
  'é™€ç¾…': (year) => (year - 1 + 12) % 12,
  'ç«æ˜Ÿ': (year, time) => {
    const base = [1,0,11,9,8,7,1,0,11,9,8,7]; // ä¾å¹´æ”¯
    return (base[year % 12] + time) % 12;
  },
  'éˆ´æ˜Ÿ': (year, time) => {
    const base = [7,6,5,3,2,1,7,6,5,3,2,1]; // ä¾å¹´æ”¯
    return (base[year % 12] + time) % 12;
  },
  'åœ°ç©º': (time) => (11 - time) % 12,
  'åœ°åŠ«': (time) => (time + 1) % 12
};

// ç¥¿å­˜èˆ‡å››åŒ–
const LUCUN_TABLE = [2,3,5,6,5,6,8,9,11,0,2,3]; // ä¾å¹´å¹²

// è¨ˆç®—äº”è¡Œå±€
function calculateWuxingJu(year, month, day, time) {
  // ç°¡åŒ–ç‰ˆï¼šæ ¹æ“šå¹´æ”¯å’Œæœˆä»½è¨ˆç®—ç´éŸ³äº”è¡Œå±€
  const yearBranch = (year - 4) % 12;
  const juTable = [
    [2,3,3,3,3,4,4,4,4,5,5,5],  // å­å¹´
    [5,5,2,2,3,3,3,3,4,4,4,4],  // ä¸‘å¹´
    [4,5,5,2,2,3,3,3,3,4,4,4],  // å¯…å¹´
    [4,4,5,5,2,2,3,3,3,3,4,4],  // å¯å¹´
    [4,4,4,5,5,2,2,3,3,3,3,4],  // è¾°å¹´
    [4,4,4,4,5,5,2,2,3,3,3,3],  // å·³å¹´
    [3,4,4,4,4,5,5,2,2,3,3,3],  // åˆå¹´
    [3,3,4,4,4,4,5,5,2,2,3,3],  // æœªå¹´
    [3,3,3,4,4,4,4,5,5,2,2,3],  // ç”³å¹´
    [3,3,3,3,4,4,4,4,5,5,2,2],  // é…‰å¹´
    [2,3,3,3,3,4,4,4,4,5,5,5],  // æˆŒå¹´
    [5,2,3,3,3,3,4,4,4,4,5,5]   // äº¥å¹´
  ];
  return juTable[yearBranch][month - 1];
}

// è¨ˆç®—å‘½å®®ä½ç½®
function calculateMingGong(month, time) {
  // å‘½å®® = å¯…å®®èµ·æ­£æœˆï¼Œé †æ•¸è‡³ç”Ÿæœˆï¼Œå†å¾ç”Ÿæœˆèµ·å­æ™‚ï¼Œé€†æ•¸è‡³ç”Ÿæ™‚
  let pos = (2 + month - 1) % 12; // å¯…å®®èµ·æ­£æœˆ
  pos = (pos - time + 12) % 12;    // é€†æ•¸æ™‚è¾°
  return pos;
}

// è¨ˆç®—èº«å®®ä½ç½®
function calculateShenGong(month, time) {
  // èº«å®® = å¯…å®®èµ·æ­£æœˆï¼Œé †æ•¸è‡³ç”Ÿæœˆï¼Œå†å¾ç”Ÿæœˆèµ·å­æ™‚ï¼Œé †æ•¸è‡³ç”Ÿæ™‚
  let pos = (2 + month - 1) % 12; // å¯…å®®èµ·æ­£æœˆ
  pos = (pos + time) % 12;         // é †æ•¸æ™‚è¾°
  return pos;
}

// å®‰ç´«å¾®æ˜Ÿç³»
function placeZiweiStars(day, wuxingJu) {
  const positions = {};
  
  // æ ¹æ“šäº”è¡Œå±€å’Œç”Ÿæ—¥å®šç´«å¾®ä½ç½®
  const juIndex = wuxingJu - 2; // äºŒå±€=0, ä¸‰å±€=1...
  if (juIndex >= 0 && juIndex < ZIWEI_TABLE.positions.length) {
    const ziweiPos = ZIWEI_TABLE.positions[juIndex][day - 1];
    
    // å®‰ç´«å¾®æ˜Ÿç³»
    positions['ç´«å¾®'] = ziweiPos;
    positions['å¤©æ©Ÿ'] = (ziweiPos + 1) % 12;
    positions['å¤ªé™½'] = (ziweiPos + 3) % 12;
    positions['æ­¦æ›²'] = (ziweiPos + 4) % 12;
    positions['å¤©åŒ'] = (ziweiPos + 5) % 12;
    positions['å»‰è²'] = (ziweiPos + 8) % 12;
    
    // å®‰å¤©åºœæ˜Ÿç³»ï¼ˆèˆ‡ç´«å¾®ç›¸å°ï¼‰
    const tianfuPos = (ziweiPos + 6) % 12;
    positions['å¤©åºœ'] = tianfuPos;
    positions['å¤ªé™°'] = (tianfuPos - 1 + 12) % 12;
    positions['è²ªç‹¼'] = (tianfuPos - 2 + 12) % 12;
    positions['å·¨é–€'] = (tianfuPos - 3 + 12) % 12;
    positions['å¤©ç›¸'] = (tianfuPos - 4 + 12) % 12;
    positions['å¤©æ¢'] = (tianfuPos - 5 + 12) % 12;
    positions['ä¸ƒæ®º'] = (tianfuPos - 6 + 12) % 12;
    positions['ç ´è»'] = (tianfuPos - 8 + 12) % 12;
  }
  
  return positions;
}

// å®‰å…­å‰æ˜Ÿ
function placeHelperStars(year, month, time) {
  const positions = {};
  const yearStem = (year - 4) % 10;
  const yearBranch = (year - 4) % 12;
  
  positions['æ–‡æ˜Œ'] = HELPER_STARS_RULES['æ–‡æ˜Œ'](yearBranch, month);
  positions['æ–‡æ›²'] = HELPER_STARS_RULES['æ–‡æ›²'](yearBranch, month);
  positions['å·¦è¼”'] = HELPER_STARS_RULES['å·¦è¼”'](yearBranch, month);
  positions['å³å¼¼'] = HELPER_STARS_RULES['å³å¼¼'](yearBranch, month);
  positions['å¤©é­'] = HELPER_STARS_RULES['å¤©é­'](yearStem);
  positions['å¤©é‰'] = HELPER_STARS_RULES['å¤©é‰'](yearStem);
  
  return positions;
}

// å®‰å…­ç…æ˜Ÿ
function placeUnluckyStars(year, time) {
  const positions = {};
  const yearStem = (year - 4) % 10;
  const yearBranch = (year - 4) % 12;
  
  positions['æ“ç¾Š'] = UNLUCKY_STARS_RULES['æ“ç¾Š'](yearBranch);
  positions['é™€ç¾…'] = UNLUCKY_STARS_RULES['é™€ç¾…'](yearBranch);
  positions['ç«æ˜Ÿ'] = UNLUCKY_STARS_RULES['ç«æ˜Ÿ'](yearBranch, time);
  positions['éˆ´æ˜Ÿ'] = UNLUCKY_STARS_RULES['éˆ´æ˜Ÿ'](yearBranch, time);
  positions['åœ°ç©º'] = UNLUCKY_STARS_RULES['åœ°ç©º'](time);
  positions['åœ°åŠ«'] = UNLUCKY_STARS_RULES['åœ°åŠ«'](time);
  
  return positions;
}

// å®‰ç¥¿å­˜
function placeLucun(year) {
  const yearStem = (year - 4) % 10;
  return { 'ç¥¿å­˜': LUCUN_TABLE[yearStem] };
}

// å…¶ä»–å°æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
function placeMinorStars(month, day, time) {
  return {
    'å¤©é¦¬': (2 + time) % 12,
    'ç´…é¸': (3 + month) % 12,
    'å¤©å–œ': (9 + month) % 12,
    'å¤©åˆ‘': (9 + month) % 12,
    'å¤©å§š': (month - 1) % 12,
    'å¤©å·«': (month - 1) % 12,
    'å¤©æœˆ': (month - 1) % 12,
    'é™°ç…': (9 - month + 12) % 12,
    'å°è¼”': (month - 1) % 12,
    'å°èª¥': (month + 1) % 12,
    'é¾æ± ': (time + 2) % 12,
    'é³³é–£': (time - 2 + 12) % 12,
  };
}

// ä¸»å‡½æ•¸ï¼šç”Ÿæˆå®Œæ•´å‘½ç›¤
function generateChart() {
  const name = document.getElementById('name').value || 'æœªå‘½å';
  const gender = document.getElementById('gender').value;
  const birthDate = document.getElementById('birthDate').value;
  const timeIndex = parseInt(document.getElementById('birthTime').value);
  
  if (!birthDate) {
    alert('è«‹é¸æ“‡ç”Ÿæ—¥ï¼');
    return;
  }
  
  // è§£ææ—¥æœŸ
  const date = new Date(birthDate);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  // è¨ˆç®—åŸºæœ¬è³‡è¨Š
  const wuxingJu = calculateWuxingJu(year, month, day, timeIndex);
  const mingGongPos = calculateMingGong(month, timeIndex);
  const shenGongPos = calculateShenGong(month, timeIndex);
  
  // å®‰å„é¡æ˜Ÿæ›œ
  const majorStars = placeZiweiStars(day, wuxingJu);
  const helperStars = placeHelperStars(year, month, timeIndex);
  const unluckyStars = placeUnluckyStars(year, timeIndex);
  const lucun = placeLucun(year);
  const minorStars = placeMinorStars(month, day, timeIndex);
  
  // åˆä½µæ‰€æœ‰æ˜Ÿæ›œ
  const allStars = {
    ...majorStars,
    ...helperStars,
    ...unluckyStars,
    ...lucun,
    ...minorStars
  };
  
  // åˆå§‹åŒ–12å®®
  const palaces = [];
  for (let i = 0; i < 12; i++) {
    const palacePos = (mingGongPos + i) % 12;
    palaces.push({
      name: PALACE_NAMES[i],
      branch: EARTHLY_BRANCHES[palacePos],
      branchIndex: palacePos,
      isMing: i === 0,
      isShen: palacePos === shenGongPos,
      stars: []
    });
  }
  
  // å°‡æ˜Ÿæ›œæ”¾å…¥å°æ‡‰å®®ä½
  for (const [starName, starPos] of Object.entries(allStars)) {
    const palace = palaces.find(p => p.branchIndex === starPos);
    if (palace) {
      let starType = 'minor';
      if (['ç´«å¾®','å¤©æ©Ÿ','å¤ªé™½','æ­¦æ›²','å¤©åŒ','å»‰è²','å¤©åºœ','å¤ªé™°','è²ªç‹¼','å·¨é–€','å¤©ç›¸','å¤©æ¢','ä¸ƒæ®º','ç ´è»'].includes(starName)) {
        starType = starName === 'ç´«å¾®' ? 'ziwei' : starName === 'å¤©åºœ' ? 'tianfu' : 'major';
      } else if (['æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼','å¤©é­','å¤©é‰'].includes(starName)) {
        starType = 'helper';
      } else if (['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ','åœ°ç©º','åœ°åŠ«'].includes(starName)) {
        starType = 'unlucky';
      } else if (starName === 'ç¥¿å­˜') {
        starType = 'lucky';
      }
      palace.stars.push({ name: starName, type: starType });
    }
  }
  
  // é¡¯ç¤ºå‘½ç›¤
  displayChart(name, gender, birthDate, timeIndex, palaces, wuxingJu, mingGongPos);
}

function displayChart(name, gender, birthDate, timeIndex, palaces, wuxingJu, mingGongPos) {
  const genderText = gender === 'male' ? 'ç”·å‘½' : 'å¥³å‘½';
  const timeNames = ['å­æ™‚','ä¸‘æ™‚','å¯…æ™‚','å¯æ™‚','è¾°æ™‚','å·³æ™‚','åˆæ™‚','æœªæ™‚','ç”³æ™‚','é…‰æ™‚','æˆŒæ™‚','äº¥æ™‚'];
  const wuxingNames = ['', '', 'æ°´äºŒå±€', 'æœ¨ä¸‰å±€', 'é‡‘å››å±€', 'åœŸäº”å±€', 'ç«å…­å±€'];
  
  // æ‰¾åˆ°å‘½ä¸»å’Œèº«ä¸»æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
  const mingZhu = 'è²ªç‹¼';
  const shenZhu = 'å¤©ç›¸';
  
  document.getElementById('chartInfo').innerHTML = `
    <h3>âœ¨ å‘½ç›¤è³‡è¨Š âœ¨</h3>
    <p><strong>${name}</strong> (${genderText})</p>
    <p><strong>é™½æ›†ï¼š</strong>${birthDate} ${timeNames[timeIndex]}</p>
    <p><strong>å‘½å®®ï¼š</strong>${palaces[0].branch} | <strong>èº«å®®ï¼š</strong>${palaces.find(p => p.isShen)?.branch || 'æœªçŸ¥'}</p>
    <p><strong>äº”è¡Œå±€ï¼š</strong>${wuxingNames[wuxingJu] || 'æœªçŸ¥'}</p>
  `;
  
  // å‚³çµ±12å®®æ’åˆ—ï¼ˆé€†æ™‚é‡ï¼Œå‘½å®®åœ¨å³ä¸‹è§’ï¼‰
  const gridOrder = [
    11, 10, 9, 8,    // ç¬¬ä¸€è¡Œï¼šå…„å¼Ÿã€å¤«å¦»ã€å­å¥³ã€è²¡å¸›
    null, null, null, 7,  // ç¬¬äºŒè¡Œï¼šä¸­é–“ç©ºï¼Œç–¾å„
    null, null, null, 6,  // ç¬¬ä¸‰è¡Œï¼šä¸­é–“ç©ºï¼Œé·ç§»
    0, 1, 2, 3      // ç¬¬å››è¡Œï¼šå‘½å®®ã€çˆ¶æ¯ã€ç¦å¾·ã€ç”°å®…ï¼ˆå¾Œé¢æ¥å®˜ç¥¿ã€åƒ•å½¹ï¼‰
  ];
  
  const wrapper = document.getElementById('palaceWrapper');
  wrapper.innerHTML = '';
  
  gridOrder.forEach((idx, pos) => {
    if (idx === null) {
      // ä¸­é–“è³‡è¨Šå€
      if (pos === 5) {
        const centerDiv = document.createElement('div');
        centerDiv.className = 'center-info';
        centerDiv.innerHTML = `
          <h2>${name}</h2>
          <div class="main-palace">${palaces[0].branch}å®®</div>
          <div class="life-master">å‘½ä¸»ï¼š${mingZhu}</div>
          <div class="life-master">èº«ä¸»ï¼š${shenZhu}</div>
          <div class="life-master" style="margin-top:15px;font-size:1em;">
            ${wuxingNames[wuxingJu] || ''}
          </div>
        `;
        wrapper.appendChild(centerDiv);
      }
      return;
    }
    
    const palace = palaces[idx];
    const div = document.createElement('div');
    div.className = 'palace';
    
    // å®®ä½æ¨™ç±¤
    const attrs = [];
    if (palace.isMing) attrs.push('å‘½');
    if (palace.isShen) attrs.push('èº«');
    
    const attrsHTML = attrs.length > 0 
      ? `<div class="palace-attrs">${attrs.map(a => `<span class="attr-tag">${a}</span>`).join('')}</div>`
      : '';
    
    // æ˜Ÿæ›œ
    const starsHTML = palace.stars
      .map(star => `<span class="star star-${star.type}">${star.name}</span>`)
      .join('');
    
    div.innerHTML = `
      <div class="palace-header">
        <span class="palace-name">${palace.name}</span>
        <span class="palace-branch">${palace.branch}</span>
      </div>
      ${attrsHTML}
      <div class="stars-container">${starsHTML}</div>
    `;
    
    wrapper.appendChild(div);
  });
  
  // äº”è¡Œåˆ†æ
  const elements = { 'é‡‘': 0, 'æœ¨': 0, 'æ°´': 0, 'ç«': 0, 'åœŸ': 0 };
  palaces.forEach(p => {
    p.stars.forEach(s => {
      if (['ç´«å¾®','æ­¦æ›²','ä¸ƒæ®º','ç ´è»'].includes(s.name)) elements['é‡‘']++;
      if (['å¤©æ©Ÿ','å¤©æ¢','è²ªç‹¼'].includes(s.name)) elements['æœ¨']++;
      if (['å¤ªé™½','å»‰è²'].includes(s.name)) elements['ç«']++;
      if (['å¤ªé™°','å¤©åŒ'].includes(s.name)) elements['æ°´']++;
      if (['å¤©åºœ','å¤©ç›¸','å·¨é–€'].includes(s.name)) elements['åœŸ']++;
    });
  });
  
  const maxElement = Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
  
  document.getElementById('elementsInfo').innerHTML = `
    <h3>âš¡ äº”è¡Œåˆ†æ</h3>
    <div class="elements-grid">
      ${Object.entries(elements).map(([el, count]) => `
        <div class="element-item">
          <div><strong>${el}</strong></div>
          <div style="color:#aaf;margin-top:5px;">${count} ${el === maxElement ? 'â˜…' : ''}</div>
        </div>
      `).join('')}
    </div>
    <p style="margin-top:20px;text-align:center;color:#ff7bff;font-size:1.1em;">
      ğŸ’« äº”è¡Œä¸»å‹¢ï¼š<strong style="color:#ff3eff;font-size:1.3em;">${maxElement}</strong>
    </p>
  `;
  
  document.getElementById('chartContainer').style.display = 'block';
  document.getElementById('chartContainer').scrollIntoView({ behavior: 'smooth' });
}

// è¨­ç½®é è¨­å€¼
document.getElementById('birthDate').valueAsDate = new Date();
</script>
</body>
</html>
