<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ§ Culaliya's Music Lab</title>
<style>
body {
  margin:0;
  font-family:'Orbitron',sans-serif;
  background:radial-gradient(circle at 50% 20%, #030616 0%, #0a0120 80%, #000 100%);
  color:#0ff;
  text-align:center;
  overflow:hidden;
}
h1 {
  margin-top:50px;
  color:#0ff;
  font-size:2.2em;
  text-shadow:0 0 25px #00ffff, 0 0 45px #0077ff;
  animation:glowPulse 3s infinite alternate;
}
@keyframes glowPulse {
  from { text-shadow:0 0 15px #00ffff; }
  to { text-shadow:0 0 35px #ff3eff, 0 0 60px #00ffff; }
}
.neon-box {
  background:rgba(255,255,255,0.05);
  border:2px solid #0ff;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,255,255,0.5);
  width:80%;
  max-width:800px;
  margin:50px auto;
  padding:30px;
  animation:glowFlow 4s infinite;
}
@keyframes glowFlow {
  0% { border-color:#0ff; box-shadow:0 0 20px #0ff; }
  50% { border-color:#ff3eff; box-shadow:0 0 25px #ff3eff; }
  100% { border-color:#0ff; box-shadow:0 0 20px #0ff; }
}
iframe {
  width:100%;
  height:352px;
  border:none;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,255,255,0.3);
}
a.back-home {
  position:fixed;
  bottom:20px;
  left:20px;
  padding:10px 20px;
  border:2px solid #0ff;
  border-radius:20px;
  color:#0ff;
  text-decoration:none;
  background:rgba(0,255,255,0.1);
  transition:.3s;
}
a.back-home:hover {background:rgba(0,255,255,0.3);}
canvas#stars {
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  z-index:-1;
}
</style>
<link rel="stylesheet" href="mobile-ui.css">
</head>
<body>
<canvas id="stars"></canvas>
<h1>ğŸ§ AI éŸ³æ¨‚å¯¦é©—å®¤</h1>

<div class="neon-box">
  <p>ğŸ’« Culaliya ç²¾é¸SpotifyéŸ³æ¨‚æ’­æ”¾æ¸…å–® ğŸ’«</p>
  <iframe data-testid="embed-iframe" style="border-radius:12px"
    src="https://open.spotify.com/embed/playlist/7zqopQeAzw0nrvD1cebjdG?utm_source=generator&theme=0"
    width="100%" height="352" frameBorder="0" allowfullscreen=""
    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
</div>

<a href="index.html" class="back-home">ğŸ  å›é¦–é </a>

<script>
// æ˜Ÿæ˜ŸèƒŒæ™¯å‹•ç•«
const canvas=document.getElementById('stars');
const ctx=canvas.getContext('2d');
let w,h,stars=[];
function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
window.addEventListener('resize',resize);
resize();
for(let i=0;i<100;i++){
  stars.push({x:Math.random()*w,y:Math.random()*h,size:Math.random()*1.5,speed:Math.random()*0.3+0.1});
}
function drawStars(){
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#0ff';
  for(const s of stars){
    ctx.globalAlpha=Math.random()*0.7+0.3;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
    ctx.fill();
    s.y+=s.speed;if(s.y>h)s.y=0;
  }
  requestAnimationFrame(drawStars);
}
drawStars();
</script>
<script src="mobile-nav.js"></script>
</body>
</html>

<!-- ğŸ¹ Virtual Piano Trigger -->
<div style="margin: 24px auto; text-align:center;">
  <button id="openPianoBtn" class="glass-btn">
    ğŸ¹ å¬å–šéœœç¶ ç»ç’ƒé‹¼ç´
  </button>
  <div class="tiny-note">ï¼ˆå®ƒå¾ˆå†·ï¼Œä½†æœƒå”±æ­Œï¼‰</div>
</div>

<!-- ğŸ¹ Piano Modal -->
<div id="pianoModal" class="piano-modal" aria-hidden="true">
  <div class="piano-card">
    <div class="piano-topbar">
      <div class="piano-title">VIRTUAL PIANO Â· GLASS NEON A</div>
      <button id="closePianoBtn" class="piano-close">âœ•</button>
    </div>

    <div class="piano-controls">
      <label class="ctrl">
        <span>Voice</span>
        <select id="voiceSel" class="glass-select">
          <option value="glass">Glass</option>
          <option value="toy">Toy</option>
          <option value="pad">Soft Pad</option>
        </select>
      </label>

      <label class="ctrl">
        <span>Sustain</span>
        <input id="sustainChk" type="checkbox" />
      </label>

      <button id="recBtn" class="glass-btn small">âº REC 10s</button>
      <button id="playBtn" class="glass-btn small">â–¶ PLAY</button>
      <button id="clearBtn" class="glass-btn small ghost">ğŸ—‘ CLEAR</button>
    </div>

    <div id="pianoKeys" class="piano-keys"></div>

    <div class="piano-footer" id="pianoLog">
      éœœç¶ ç»ç’ƒè¦å‰‡ï¼šä¸è¦å•ã€Œç‚ºä»€éº¼æ˜¯é€™å€‹è²éŸ³ã€ï¼Œåªè¦æŒ‰ä¸‹å»ã€‚ğŸ‘»
    </div>
  </div>
</div>

<style>
  .glass-btn{
    padding: 12px 18px;
    border-radius: 999px;
    border: 1px solid rgba(120,240,255,.35);
    background: rgba(20,40,60,.28);
    color: rgba(200,255,255,.92);
    box-shadow: 0 0 22px rgba(80,220,255,.18);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease;
    font-weight: 600;
    letter-spacing: .4px;
  }
  .glass-btn:hover{ transform: translateY(-1px); box-shadow: 0 0 28px rgba(80,220,255,.26); }
  .glass-btn.small{ padding: 10px 14px; font-size: 13px; }
  .glass-btn.ghost{
    border-color: rgba(255,120,200,.25);
    box-shadow: 0 0 18px rgba(255,120,200,.12);
  }
  .tiny-note{ margin-top: 10px; font-size: 12px; opacity: .75; }

  .piano-modal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.62);
    z-index: 9999;
    padding: 18px;
  }
  .piano-modal.show{ display:flex; }

  .piano-card{
    width: min(980px, 100%);
    border-radius: 18px;
    border: 1px solid rgba(120,240,255,.25);
    background: rgba(10,18,28,.78);
    box-shadow: 0 0 50px rgba(80,220,255,.12), inset 0 0 40px rgba(80,220,255,.06);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    overflow: hidden;
  }

  .piano-topbar{
    display:flex;
    align-items:center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid rgba(120,240,255,.18);
    background: linear-gradient(90deg, rgba(80,220,255,.08), rgba(255,120,200,.06));
  }
  .piano-title{
    font-weight: 800;
    letter-spacing: 1px;
    font-size: 13px;
    opacity: .92;
  }
  .piano-close{
    width: 34px; height: 34px;
    border-radius: 10px;
    border: 1px solid rgba(120,240,255,.22);
    background: rgba(255,255,255,.06);
    color: rgba(220,255,255,.9);
    cursor: pointer;
  }

  .piano-controls{
    display:flex;
    flex-wrap: wrap;
    gap: 10px 12px;
    padding: 14px 16px;
    align-items:center;
    border-bottom: 1px solid rgba(120,240,255,.14);
  }
  .ctrl{
    display:flex;
    align-items:center;
    gap: 8px;
    font-size: 12px;
    opacity: .9;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(120,240,255,.16);
    background: rgba(255,255,255,.04);
  }
  .glass-select{
    border-radius: 10px;
    border: 1px solid rgba(120,240,255,.22);
    background: rgba(0,0,0,.22);
    color: rgba(220,255,255,.9);
    padding: 6px 10px;
    outline: none;
  }

  .piano-keys{
    padding: 16px;
    display:flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .key{
    width: 52px;
    height: 170px;
    border-radius: 14px;
    border: 1px solid rgba(120,240,255,.18);
    background: rgba(255,255,255,.06);
    box-shadow: 0 0 18px rgba(80,220,255,.09), inset 0 0 12px rgba(255,255,255,.04);
    cursor: pointer;
    position: relative;
    user-select: none;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding-bottom: 10px;
    color: rgba(210,255,255,.72);
    font-size: 12px;
    letter-spacing: .6px;
  }
  .key:active, .key.active{
    background: rgba(80,220,255,.16);
    box-shadow: 0 0 24px rgba(80,220,255,.22), inset 0 0 18px rgba(255,255,255,.06);
    transform: translateY(1px);
  }

  .piano-footer{
    padding: 12px 16px 16px;
    font-size: 12px;
    opacity: .78;
    border-top: 1px solid rgba(120,240,255,.10);
  }
</style>

<script>
(() => {
  // --- UI refs
  const modal = document.getElementById("pianoModal");
  const openBtn = document.getElementById("openPianoBtn");
  const closeBtn = document.getElementById("closePianoBtn");
  const keysWrap = document.getElementById("pianoKeys");
  const voiceSel = document.getElementById("voiceSel");
  const sustainChk = document.getElementById("sustainChk");
  const recBtn = document.getElementById("recBtn");
  const playBtn = document.getElementById("playBtn");
  const clearBtn = document.getElementById("clearBtn");
  const log = document.getElementById("pianoLog");

  // --- Lazy audio init
  let ctx = null;
  const activeOsc = new Map(); // note -> {osc, gain}
  let sustain = false;

  // --- Recording (events, not audio)
  let isRec = false;
  let recStart = 0;
  let recEvents = []; // {t, note, on, voice}
  const REC_LIMIT = 10000;

  // --- Notes (1.5 octaves: C4 -> E5)
  const NOTES = [
    ["C4", 261.63], ["D4", 293.66], ["E4", 329.63], ["F4", 349.23], ["G4", 392.00], ["A4", 440.00], ["B4", 493.88],
    ["C5", 523.25], ["D5", 587.33], ["E5", 659.25]
  ];

  function ensureAudio(){
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    logMsg("Audio awakened. éœœç¶ é–‹å§‹å‘¼å¸ã€‚ğŸ§Šâœ¨");
  }

  function logMsg(msg){
    log.textContent = msg;
  }

  function makeVoice(freq, voice){
    // Simple synth voices using WebAudio (no samples)
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const filt = ctx.createBiquadFilter();

    // Base
    osc.frequency.value = freq;

    if (voice === "glass"){
      osc.type = "sine";
      filt.type = "highpass";
      filt.frequency.value = 240;
      gain.gain.value = 0.0001;
    } else if (voice === "toy"){
      osc.type = "triangle";
      filt.type = "bandpass";
      filt.frequency.value = 900;
      filt.Q.value = 2.2;
      gain.gain.value = 0.0001;
    } else { // pad
      osc.type = "sawtooth";
      filt.type = "lowpass";
      filt.frequency.value = 900;
      filt.Q.value = 0.7;
      gain.gain.value = 0.0001;
    }

    osc.connect(filt);
    filt.connect(gain);
    gain.connect(ctx.destination);

    return {osc, gain};
  }

  function envOn(gainNode, voice){
    const t = ctx.currentTime;
    // envelope
    let attack = 0.01, decay = 0.12, sustainLevel = 0.22;
    if (voice === "pad"){ attack = 0.08; decay = 0.25; sustainLevel = 0.16; }
    if (voice === "toy"){ attack = 0.005; decay = 0.08; sustainLevel = 0.18; }

    gainNode.gain.cancelScheduledValues(t);
    gainNode.gain.setValueAtTime(0.0001, t);
    gainNode.gain.linearRampToValueAtTime(0.26, t + attack);
    gainNode.gain.linearRampToValueAtTime(sustainLevel, t + attack + decay);
  }

  function envOff(gainNode, voice){
    const t = ctx.currentTime;
    let release = 0.14;
    if (voice === "pad") release = 0.55;
    if (voice === "toy") release = 0.08;

    gainNode.gain.cancelScheduledValues(t);
    gainNode.gain.setValueAtTime(gainNode.gain.value, t);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, t + release);
  }

  function noteOn(noteName, freq){
    ensureAudio();
    const voice = voiceSel.value;

    if (activeOsc.has(noteName)) return;

    const {osc, gain} = makeVoice(freq, voice);
    envOn(gain, voice);
    osc.start();
    activeOsc.set(noteName, {osc, gain, voice});

    if (isRec){
      recEvents.push({ t: Date.now() - recStart, note: noteName, on: true, voice });
    }
  }

  function noteOff(noteName){
    const item = activeOsc.get(noteName);
    if (!item) return;

    if (sustain) return; // hold until sustain off / stopAll

    envOff(item.gain, item.voice);
    setTimeout(() => {
      try{ item.osc.stop(); }catch(e){}
      try{ item.osc.disconnect(); }catch(e){}
    }, 700);
    activeOsc.delete(noteName);

    if (isRec){
      recEvents.push({ t: Date.now() - recStart, note: noteName, on: false, voice: item.voice });
    }
  }

  function stopAll(){
    for (const [note, item] of activeOsc.entries()){
      envOff(item.gain, item.voice);
      setTimeout(() => {
        try{ item.osc.stop(); }catch(e){}
        try{ item.osc.disconnect(); }catch(e){}
      }, 700);
    }
    activeOsc.clear();
  }

  function renderKeys(){
    keysWrap.innerHTML = "";
    NOTES.forEach(([name, freq]) => {
      const k = document.createElement("div");
      k.className = "key";
      k.textContent = name;
      k.addEventListener("pointerdown", () => { k.classList.add("active"); noteOn(name, freq); });
      k.addEventListener("pointerup", () => { k.classList.remove("active"); noteOff(name); });
      k.addEventListener("pointerleave", () => { k.classList.remove("active"); noteOff(name); });
      keysWrap.appendChild(k);
    });
  }

  function startRec(){
    recEvents = [];
    isRec = true;
    recStart = Date.now();
    recBtn.textContent = "âº RECâ€¦";
    logMsg("éŒ„éŸ³é–‹å§‹ï¼š10 ç§’å…§çš„å’’èªéƒ½æœƒè¢«è¨˜ä¸‹ä¾†ã€‚ğŸ‘ï¸");
    setTimeout(() => {
      if (!isRec) return;
      isRec = false;
      recBtn.textContent = "âº REC 10s";
      logMsg(`éŒ„éŸ³å®Œæˆï¼š${recEvents.length} å€‹äº‹ä»¶ã€‚æŒ‰ â–¶ PLAY å›æ”¾ã€‚`);
    }, REC_LIMIT);
  }

  function playRec(){
    if (!recEvents.length){
      logMsg("æ²’æœ‰éŒ„éŸ³äº‹ä»¶ã€‚å…ˆéŒ„ä¸€æ®µå†å›æ”¾ã€‚");
      return;
    }
    ensureAudio();
    stopAll();

    logMsg("å›æ”¾ä¸­ï¼šéœœç¶ ç»ç’ƒæ­£åœ¨é‡æ¼”ä½ çš„é¸æ“‡ã€‚ğŸ§Šâœ¨");

    recEvents.forEach(ev => {
      setTimeout(() => {
        // set voice for each event (keeps original vibe)
        const old = voiceSel.value;
        voiceSel.value = ev.voice || old;

        const found = NOTES.find(n => n[0] === ev.note);
        if (!found) return;

        if (ev.on) noteOn(found[0], found[1]);
        else {
          // allow release even when sustain checked during playback
          const prevSustain = sustain;
          sustain = false;
          noteOff(found[0]);
          sustain = prevSustain;
        }
      }, ev.t);
    });

    // end message
    const lastT = Math.max(...recEvents.map(e => e.t));
    setTimeout(() => logMsg("å›æ”¾çµæŸã€‚ä½ å‰›å‰›å¯«äº†ä¸€æ®µå¾ˆå†·çš„æ­Œã€‚"), lastT + 400);
  }

  // --- Modal events
  openBtn.addEventListener("click", () => {
    modal.classList.add("show");
    modal.setAttribute("aria-hidden", "false");
    renderKeys();
    logMsg("éœœç¶ ç»ç’ƒé‹¼ç´å·²å°±ä½ï¼šæŒ‰éµæ˜¯å†°çš„ï¼Œè²éŸ³æ˜¯äº®çš„ã€‚ğŸ§Šâœ¨");
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden", "true");
    stopAll();
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
      stopAll();
    }
  });

  sustainChk.addEventListener("change", () => {
    sustain = sustainChk.checked;
    if (!sustain){
      // release all held notes when sustain off
      stopAll();
    }
    logMsg(sustain ? "Sustain ONï¼šä½ æŒ‰ä¸‹å»çš„éŸ³æœƒé»è‘—ä¸æ”¾ã€‚ğŸ‘»" : "Sustain OFFï¼šæ”¾æ‰‹å°±å›åˆ°é»‘æš—ã€‚");
  });

  recBtn.addEventListener("click", () => {
    ensureAudio();
    if (isRec) return;
    startRec();
  });

  playBtn.addEventListener("click", () => playRec());

  clearBtn.addEventListener("click", () => {
    recEvents = [];
    isRec = false;
    recBtn.textContent = "âº REC 10s";
    logMsg("å·²æ¸…ç©ºã€‚åƒä»€éº¼éƒ½æ²’ç™¼ç”Ÿéä¸€æ¨£ã€‚");
  });

})();
</script>
